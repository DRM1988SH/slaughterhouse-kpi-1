<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة مؤشرات الأداء والمسالخ - v8.24</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- React Router -->
    <script src="https://unpkg.com/react-router@6/dist/umd/react-router.production.min.js"></script>
    <script src="https://unpkg.com/react-router-dom@6/dist/umd/react-router-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; }
        
        /* Print Styles */
        @media print {
            @page { margin: 0; size: auto; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #c5b358; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a08f3a; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        // Global imports
        const { HashRouter, Routes, Route, Navigate, useNavigate, useLocation } = window.ReactRouterDOM;
        const { useState, useEffect, useRef, createContext, useContext, Fragment } = React;

        // App Context
        const AppContext = createContext();
        const useApp = () => useContext(AppContext);

        // Data Service
        const DataService = {
            get: (key, defaultValue) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    return defaultValue;
                }
            },
            set: (key, value) => {
                localStorage.setItem(key, JSON.stringify(value));
                window.dispatchEvent(new Event('storage-update'));
            },
            
            users: {
                getAll: () => DataService.get('users', [
                    { id: '70062', name: 'مصعب علي', role: 'ADMIN' },
                    { id: '12345', name: 'عمر سعيد', role: 'DEPT_MANAGER' },
                    { id: '00000', name: 'حسن سالم', role: 'SECTION_HEAD' },
                    { id: '11111', name: 'حسين محمد', role: 'CONTRACTOR', facilityId: '1' },
                    { id: '99999', name: 'محمد عمر', role: 'USER', facilityId: '1' },
                    { id: '66666', name: 'إدارة العقود', role: 'CONTRACT_MANAGER' }
                ]),
                save: (users) => DataService.set('users', users)
            },
            
            facilities: {
                getAll: () => DataService.get('facilities', [
                    { id: '1', name: 'مسلخ أ', contractNumber: 'CNT-2024-001', operatingCompany: 'شركة الخدمات الحديثة', location: 'المنطقة الصناعية', phone: '0112345678', email: 'info@modern.com' },
                    { id: '2', name: 'مسلخ ب', contractNumber: 'CNT-2024-002', operatingCompany: 'شركة الإبداع', location: 'حي المصانع', phone: '0223456789', email: 'contracts@ibdaa.com' }
                ]),
                save: (facilities) => DataService.set('facilities', facilities)
            },
            
            employees: {
                getAll: () => DataService.get('employees', [
                    { id: 'e1', name: 'عبد العزيز وفيق', jobTitle: 'مشرف المسلخ', salary: 4500, facilityId: '1' },
                    { id: 'e2', name: 'محمد شهباز', jobTitle: 'مشرف النظافة', salary: 4500, facilityId: '1' },
                    { id: 'e3', name: 'صافي الدين الضو', jobTitle: 'محاسب', salary: 3500, facilityId: '1' },
                    { id: 'e4', name: 'احمد كمال', jobTitle: 'قصاب', salary: 2500, facilityId: '1' },
                    { id: 'e5', name: 'سعيد خان', jobTitle: 'قصاب ', salary: 2300, facilityId: '1' },
                    { id: 'e6', name: 'راجو كومار', jobTitle: 'قصاب', salary: 2300, facilityId: '1' },
                    { id: 'e7', name: 'عمر', jobTitle: 'قصاب', salary: 2300, facilityId: '1' },
                    { id: 'e13', name: 'مصطفي', jobTitle: 'عامل نظافة', salary: 2300, facilityId: '1' }
                ]),
                save: (employees) => DataService.set('employees', employees)
            },
            
            items: {
                getAll: () => DataService.get('items', [
                    { id: 'i1', name: 'الحضور والانصراف', category: 'ADMIN', points: 5 },
                    { id: 'i2', name: 'التقارير الإدارية اليومية', category: 'ADMIN', points: 5 },
                    { id: 'i5', name: 'توفير معدات العمل', category: 'OPERATIONAL', points: 10 },
                    { id: 'i12', name: 'نظافة المعدات والأدوات', category: 'HYGIENE', points: 10 },
                    { id: 'i18', name: 'فحص المختبري', category: 'LAB', points: 20 }
                ]),
                save: (items) => DataService.set('items', items)
            },
            
            violationTypes: {
                getAll: () => DataService.get('violationTypes', [
                    { id: 'v1', name: 'غياب الموظف', fineAmount: 250 },
                    { id: 'v2', name: 'عدم توفير التقارير الإدارية اليومية', fineAmount: 100 },
                    { id: 'v5', name: 'عدم توفير معدات العمل', fineAmount: 500 },
                    { id: 'v12', name: 'عدم نظافة المعدات والأدوات', fineAmount: 500 },
                    { id: 'v18', name: 'أي فحص مختبري يثبت حالة إيجابية', fineAmount: 5000 }
                ]),
                save: (violations) => DataService.set('violationTypes', violations)
            },
            
            violations: {
                getAll: () => DataService.get('violations', []),
                save: (violations) => DataService.set('violations', violations)
            },
            
            evaluations: {
                getAll: () => DataService.get('evaluations', []),
                save: (evaluations) => DataService.set('evaluations', evaluations),
                add: (evaluation) => {
                    const evaluations = DataService.evaluations.getAll();
                    const index = evaluations.findIndex(e => e.date === evaluation.date && e.facilityId === evaluation.facilityId);
                    if (index >= 0) {
                        evaluations[index] = evaluation;
                    } else {
                        evaluations.push(evaluation);
                    }
                    DataService.evaluations.save(evaluations);
                }
            },
            
            invoices: {
                getAll: () => DataService.get('invoices', []),
                save: (invoices) => DataService.set('invoices', invoices)
            },
            
            monthlyReports: {
                getAll: () => DataService.get('monthlyReports', []),
                save: (reports) => DataService.set('monthlyReports', reports)
            },
            
            kpiReports: {
                getAll: () => DataService.get('kpiReports', []),
                save: (reports) => DataService.set('kpiReports', reports)
            },
            
            extraLabor: {
                getAll: () => DataService.get('extraLabor', []),
                save: (labor) => DataService.set('extraLabor', labor)
            },
            
            notifications: {
                getAll: () => DataService.get('notifications', []),
                save: (notifications) => DataService.set('notifications', notifications),
                add: (notification) => {
                    const notifications = DataService.notifications.getAll();
                    notifications.push({
                        ...notification,
                        id: Date.now().toString(),
                        date: new Date().toISOString(),
                        read: false
                    });
                    DataService.notifications.save(notifications);
                }
            },
            
            settings: {
                get: () => DataService.get('appSettings', {}),
                save: (settings) => DataService.set('appSettings', settings)
            }
        };

        // Toast Context
        const ToastContext = createContext();
        const ToastProvider = ({ children }) => {
            const [toast, setToast] = useState(null);
            
            const showToast = (message, type = 'success') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 3000);
            };
            
            return (
                <ToastContext.Provider value={{ showToast }}>
                    {toast && (
                        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-white text-black border-2 border-yellow-500 px-6 py-3 rounded-lg shadow-2xl z-[9999]">
                            <i className={`fa ${type === 'success' ? 'fa-check-circle text-green-600' : 'fa-info-circle text-yellow-500'} ml-2`}></i>
                            {toast.message}
                        </div>
                    )}
                    {children}
                </ToastContext.Provider>
            );
        };
        
        const useToast = () => useContext(ToastContext);

        // Login Component
        const Login = ({ onLogin }) => {
            const [id, setId] = useState('');
            const [error, setError] = useState('');
            
            const handleLogin = (e) => {
                e.preventDefault();
                const user = DataService.users.getAll().find(u => u.id === id);
                if (user) {
                    onLogin(user);
                } else {
                    setError('الرمز الوظيفي غير صحيح');
                }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 to-black">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">نظام إدارة مؤشرات الأداء</h1>
                            <p className="text-gray-600">v8.24</p>
                        </div>
                        
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="block text-gray-700 mb-2">الرمز الوظيفي</label>
                                <input
                                    type="text"
                                    value={id}
                                    onChange={(e) => setId(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    placeholder="أدخل الرمز الوظيفي"
                                    autoFocus
                                />
                            </div>
                            
                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg">
                                    {error}
                                </div>
                            )}
                            
                            <button
                                type="submit"
                                className="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200"
                            >
                                تسجيل الدخول
                            </button>
                        </form>
                        
                        <div className="mt-8 pt-6 border-t border-gray-200">
                            <p className="text-sm text-gray-500 text-center">
                                أمثلة رموز اختبارية: 70062 (مدير نظام), 11111 (مقاول), 99999 (طبيب)
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // Layout Component
        const Layout = ({ children, currentUser, onLogout }) => {
            const navigate = useNavigate();
            const location = useLocation();
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            
            const menuItems = [
                { path: '/daily', label: 'التقييم اليومي', icon: 'calendar-check', roles: ['ADMIN', 'USER'] },
                { path: '/violations', label: 'المخالفات', icon: 'exclamation-triangle', roles: ['ADMIN', 'USER', 'DEPT_MANAGER', 'SECTION_HEAD', 'CONTRACTOR', 'CONTRACT_MANAGER'] },
                { path: '/monthly', label: 'التقييم الشهري', icon: 'table', roles: ['ADMIN', 'USER', 'DEPT_MANAGER', 'SECTION_HEAD', 'CONTRACTOR', 'CONTRACT_MANAGER'] },
                { path: '/report', label: 'التقرير الشهري', icon: 'file-text', roles: ['ADMIN', 'USER', 'DEPT_MANAGER', 'SECTION_HEAD', 'CONTRACTOR', 'CONTRACT_MANAGER'] },
                { path: '/kpi', label: 'مؤشر الأداء', icon: 'chart-pie', roles: ['ADMIN', 'USER', 'DEPT_MANAGER', 'SECTION_HEAD', 'CONTRACTOR', 'CONTRACT_MANAGER'] },
                { path: '/invoice', label: 'الفاتورة الشهرية', icon: 'file-invoice-dollar', roles: ['ADMIN', 'USER', 'DEPT_MANAGER', 'SECTION_HEAD', 'CONTRACTOR', 'CONTRACT_MANAGER'] },
                { path: '/labor', label: 'العمالة الإضافية', icon: 'users-cog', roles: ['ADMIN', 'USER'] },
                { path: '/settings', label: 'الإعدادات', icon: 'cogs', roles: ['ADMIN'] }
            ];
            
            const userMenuItems = menuItems.filter(item => item.roles.includes(currentUser.role));
            
            return (
                <div className="flex h-screen bg-gray-100 overflow-hidden">
                    {/* Sidebar */}
                    <div className={`${isSidebarOpen ? 'w-64' : 'w-0'} bg-white shadow-lg transition-all duration-300 flex flex-col no-print`}>
                        <div className="p-6 border-b">
                            <div className="flex items-center justify-between">
                                <h2 className="text-xl font-bold text-gray-800">المسار السريع</h2>
                                <button onClick={() => setIsSidebarOpen(false)} className="text-gray-500 hover:text-gray-700">
                                    <i className="fa fa-times"></i>
                                </button>
                            </div>
                            <div className="mt-4">
                                <div className="text-sm font-medium text-gray-600">{currentUser.name}</div>
                                <div className="text-xs text-gray-500">{currentUser.role}</div>
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto py-4">
                            {userMenuItems.map((item) => (
                                <button
                                    key={item.path}
                                    onClick={() => navigate(item.path)}
                                    className={`w-full flex items-center px-6 py-3 text-right hover:bg-yellow-50 hover:text-yellow-700 transition-colors ${
                                        location.pathname === item.path
                                            ? 'bg-yellow-50 text-yellow-700 border-r-4 border-yellow-500'
                                            : 'text-gray-700'
                                    }`}
                                >
                                    <i className={`fa fa-${item.icon} w-6 ml-3`}></i>
                                    <span className="flex-1 font-medium">{item.label}</span>
                                </button>
                            ))}
                        </div>
                        
                        <div className="p-4 border-t">
                            <button
                                onClick={onLogout}
                                className="w-full flex items-center justify-center px-4 py-2 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg transition-colors"
                            >
                                <i className="fa fa-sign-out-alt ml-2"></i>
                                <span>تسجيل الخروج</span>
                            </button>
                        </div>
                    </div>
                    
                    {/* Main Content */}
                    <div className="flex-1 flex flex-col min-w-0">
                        {/* Header */}
                        <header className="bg-white shadow-sm border-b">
                            <div className="px-6 py-4">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center">
                                        <button
                                            onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                                            className="text-gray-600 hover:text-gray-900 mr-4"
                                        >
                                            <i className="fa fa-bars fa-lg"></i>
                                        </button>
                                        <h1 className="text-xl font-bold text-gray-800 hidden md:block">
                                            نظام إدارة مؤشرات الأداء والمسالخ
                                        </h1>
                                    </div>
                                    <div className="flex items-center space-x-4">
                                        <div className="text-right">
                                            <div className="text-sm font-medium text-gray-600">
                                                {new Date().toLocaleDateString('ar-AE', {
                                                    weekday: 'long',
                                                    year: 'numeric',
                                                    month: 'long',
                                                    day: 'numeric'
                                                })}
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                {new Date().toLocaleTimeString('ar-AE')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </header>
                        
                        {/* Page Content */}
                        <main className="flex-1 overflow-auto p-6">{children}</main>
                    </div>
                </div>
            );
        };

        // Daily Evaluation Page
        const DailyEvaluationPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const navigate = useNavigate();
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [facilityId, setFacilityId] = useState(currentUser.facilityId || '1');
            const [scores, setScores] = useState({});
            const [employees, setEmployees] = useState([]);
            const [items, setItems] = useState([]);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const facilities = DataService.facilities.getAll();
            const currentFacility = facilities.find(f => f.id === facilityId);
            
            useEffect(() => {
                const loadData = () => {
                    const emps = DataService.employees.getAll().filter(e => e.facilityId === facilityId);
                    const its = DataService.items.getAll();
                    const evaluation = DataService.evaluations.getAll().find(
                        e => e.date === date && e.facilityId === facilityId
                    );
                    
                    setEmployees(emps);
                    setItems(its);
                    setScores(evaluation?.scores || {});
                };
                
                loadData();
                window.addEventListener('storage-update', loadData);
                return () => window.removeEventListener('storage-update', loadData);
            }, [date, facilityId]);
            
            const handleScoreChange = (itemId, employeeId, value) => {
                setScores(prev => ({
                    ...prev,
                    [`${itemId}_${employeeId}`]: value
                }));
            };
            
            const handleSubmit = () => {
                setIsSubmitting(true);
                
                const evaluation = {
                    id: `${date}_${facilityId}`,
                    date,
                    facilityId,
                    scores,
                    enteredBy: currentUser.name,
                    enteredDate: new Date().toISOString(),
                    performanceIndex: calculatePerformanceIndex(),
                    submitted: true
                };
                
                DataService.evaluations.add(evaluation);
                
                // Check for violations
                const violations = checkForViolations();
                if (violations.length > 0) {
                    const existingViolations = DataService.violations.getAll();
                    const newViolations = [...existingViolations, ...violations];
                    DataService.violations.save(newViolations);
                }
                
                showToast('تم حفظ التقييم اليومي بنجاح');
                setIsSubmitting(false);
            };
            
            const calculatePerformanceIndex = () => {
                const totalChecks = employees.length * items.length;
                const passedChecks = Object.values(scores).filter(Boolean).length;
                return totalChecks > 0 ? Math.round((passedChecks / totalChecks) * 100) : 100;
            };
            
            const checkForViolations = () => {
                const violations = [];
                const violationTypes = DataService.violationTypes.getAll();
                
                employees.forEach(employee => {
                    items.forEach(item => {
                        const key = `${item.id}_${employee.id}`;
                        const score = scores[key];
                        
                        if (score === false) {
                            const violationType = violationTypes.find(vt => 
                                vt.name.includes(item.name) || item.name.includes(vt.name)
                            );
                            
                            if (violationType) {
                                violations.push({
                                    id: Date.now().toString() + Math.random(),
                                    date,
                                    facilityId,
                                    employeeId: employee.id,
                                    employeeName: employee.name,
                                    violationTypeId: violationType.id,
                                    violationName: `${violationType.name} - ${employee.name}`,
                                    amount: violationType.fineAmount,
                                    total: violationType.fineAmount,
                                    enteredBy: currentUser.name,
                                    status: 'OPEN'
                                });
                            }
                        }
                    });
                });
                
                return violations;
            };
            
            const performanceIndex = calculatePerformanceIndex();
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">التقييم اليومي</h2>
                                <p className="text-gray-600 mt-1">تقييم أداء المسلخ للتاريخ المحدد</p>
                            </div>
                            <div className="flex flex-col sm:flex-row gap-3">
                                <div className="flex items-center gap-2">
                                    <span className="text-gray-600">المسلخ:</span>
                                    <select
                                        value={facilityId}
                                        onChange={(e) => setFacilityId(e.target.value)}
                                        className="border border-gray-300 rounded-lg px-3 py-2 min-w-[150px]"
                                        disabled={currentUser.role !== 'ADMIN'}
                                    >
                                        {facilities.map(facility => (
                                            <option key={facility.id} value={facility.id}>
                                                {facility.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-gray-600">التاريخ:</span>
                                    <input
                                        type="date"
                                        value={date}
                                        onChange={(e) => setDate(e.target.value)}
                                        className="border border-gray-300 rounded-lg px-3 py-2"
                                    />
                                </div>
                            </div>
                        </div>
                        
                        {/* Performance Indicator */}
                        <div className="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h3 className="font-bold text-lg text-gray-800">مؤشر الأداء اليومي</h3>
                                    <p className="text-gray-600 text-sm">نسبة الإنجاز بناءً على التقييم</p>
                                </div>
                                <div className="text-center">
                                    <div className={`text-4xl font-bold ${
                                        performanceIndex >= 90 ? 'text-green-600' :
                                        performanceIndex >= 70 ? 'text-yellow-600' :
                                        'text-red-600'
                                    }`}>
                                        {performanceIndex}%
                                    </div>
                                    <div className="text-sm text-gray-500 mt-1">من 100%</div>
                                </div>
                            </div>
                            <div className="mt-3">
                                <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                                    <div 
                                        className={`h-full rounded-full transition-all duration-500 ${
                                            performanceIndex >= 90 ? 'bg-green-500' :
                                            performanceIndex >= 70 ? 'bg-yellow-500' :
                                            'bg-red-500'
                                        }`}
                                        style={{ width: `${performanceIndex}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Evaluation Table */}
                    <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700 border-b min-w-[200px] sticky right-0 bg-gray-50 z-10">
                                            البند / الموظف
                                        </th>
                                        {employees.map(employee => (
                                            <th key={employee.id} className="py-4 px-4 text-center font-semibold text-gray-700 border-b min-w-[120px]">
                                                <div className="flex flex-col items-center">
                                                    <span className="font-bold">{employee.name}</span>
                                                    <span className="text-xs text-gray-500 mt-1">{employee.jobTitle}</span>
                                                </div>
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {items.map((item, itemIndex) => (
                                        <tr key={item.id} className={itemIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                            <td className="py-3 px-6 border-b font-semibold text-gray-800 sticky right-0 bg-white z-10">
                                                <div className="flex items-center">
                                                    <span className="ml-3">{item.name}</span>
                                                    <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded mr-3">
                                                        {item.category}
                                                    </span>
                                                </div>
                                            </td>
                                            {employees.map(employee => {
                                                const key = `${item.id}_${employee.id}`;
                                                const isChecked = scores[key] || false;
                                                
                                                return (
                                                    <td key={employee.id} className="py-3 px-4 border-b text-center">
                                                        <label className="inline-flex items-center cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={isChecked}
                                                                onChange={(e) => handleScoreChange(item.id, employee.id, e.target.checked)}
                                                                className="w-6 h-6 text-yellow-500 bg-gray-100 border-gray-300 rounded focus:ring-yellow-500 focus:ring-2"
                                                            />
                                                            <span className="mr-2 text-sm">
                                                                {isChecked ? 'مطابق' : 'غير مطابق'}
                                                            </span>
                                                        </label>
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {/* Actions */}
                    <div className="flex justify-between items-center">
                        <button
                            onClick={() => navigate('/violations')}
                            className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                        >
                            <i className="fa fa-list-alt ml-2"></i>
                            عرض المخالفات
                        </button>
                        <div className="flex gap-3">
                            <button
                                onClick={() => {
                                    setScores({});
                                    showToast('تم مسح النموذج');
                                }}
                                className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                            >
                                <i className="fa fa-eraser ml-2"></i>
                                مسح النموذج
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-8 py-3 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-lg transition-colors disabled:opacity-50"
                            >
                                {isSubmitting ? (
                                    <>
                                        <i className="fa fa-spinner fa-spin ml-2"></i>
                                        جاري الحفظ...
                                    </>
                                ) : (
                                    <>
                                        <i className="fa fa-save ml-2"></i>
                                        حفظ التقييم
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Violations Page
        const ViolationsPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [violations, setViolations] = useState([]);
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [facilityId, setFacilityId] = useState(currentUser.facilityId || '1');
            
            const facilities = DataService.facilities.getAll();
            
            useEffect(() => {
                const loadViolations = () => {
                    const allViolations = DataService.violations.getAll();
                    const filtered = allViolations.filter(v => 
                        v.date?.startsWith(month) && 
                        (currentUser.role === 'ADMIN' || v.facilityId === facilityId)
                    );
                    setViolations(filtered);
                };
                
                loadViolations();
                window.addEventListener('storage-update', loadViolations);
                return () => window.removeEventListener('storage-update', loadViolations);
            }, [month, facilityId, currentUser.role]);
            
            const handleStatusChange = (violationId, newStatus) => {
                const updatedViolations = violations.map(v => 
                    v.id === violationId ? { ...v, status: newStatus } : v
                );
                setViolations(updatedViolations);
                DataService.violations.save(updatedViolations);
                showToast('تم تحديث حالة المخالفة');
            };
            
            const handleDelete = (violationId) => {
                if (window.confirm('هل أنت متأكد من حذف هذه المخالفة؟')) {
                    const updatedViolations = violations.filter(v => v.id !== violationId);
                    setViolations(updatedViolations);
                    DataService.violations.save(updatedViolations);
                    showToast('تم حذف المخالفة');
                }
            };
            
            const totalAmount = violations.reduce((sum, v) => sum + (v.amount || 0), 0);
            const openViolations = violations.filter(v => v.status === 'OPEN');
            const closedViolations = violations.filter(v => v.status === 'CLOSED');
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">سجل المخالفات</h2>
                                <p className="text-gray-600 mt-1">إدارة وتتبع جميع المخالفات المسجلة</p>
                            </div>
                            <div className="flex flex-col sm:flex-row gap-3">
                                {currentUser.role === 'ADMIN' && (
                                    <select
                                        value={facilityId}
                                        onChange={(e) => setFacilityId(e.target.value)}
                                        className="border border-gray-300 rounded-lg px-3 py-2"
                                    >
                                        {facilities.map(facility => (
                                            <option key={facility.id} value={facility.id}>
                                                {facility.name}
                                            </option>
                                        ))}
                                    </select>
                                )}
                                <input
                                    type="month"
                                    value={month}
                                    onChange={(e) => setMonth(e.target.value)}
                                    className="border border-gray-300 rounded-lg px-3 py-2"
                                />
                                <button
                                    onClick={() => window.print()}
                                    className="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors"
                                >
                                    <i className="fa fa-print ml-2"></i>
                                    طباعة
                                </button>
                            </div>
                        </div>
                        
                        {/* Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                            <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                <div className="flex items-center">
                                    <div className="bg-blue-100 p-3 rounded-lg">
                                        <i className="fa fa-exclamation-triangle text-blue-600 text-xl"></i>
                                    </div>
                                    <div className="mr-4">
                                        <div className="text-sm text-gray-600">إجمالي المخالفات</div>
                                        <div className="text-2xl font-bold text-gray-800">{violations.length}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-red-50 to-red-100 p-4 rounded-lg border border-red-200">
                                <div className="flex items-center">
                                    <div className="bg-red-100 p-3 rounded-lg">
                                        <i className="fa fa-clock text-red-600 text-xl"></i>
                                    </div>
                                    <div className="mr-4">
                                        <div className="text-sm text-gray-600">مخالفات مفتوحة</div>
                                        <div className="text-2xl font-bold text-gray-800">{openViolations.length}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                <div className="flex items-center">
                                    <div className="bg-green-100 p-3 rounded-lg">
                                        <i className="fa fa-check-circle text-green-600 text-xl"></i>
                                    </div>
                                    <div className="mr-4">
                                        <div className="text-sm text-gray-600">إجمالي الغرامات</div>
                                        <div className="text-2xl font-bold text-gray-800">{totalAmount.toLocaleString()} د.إ</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Violations Table */}
                    <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">#</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">التاريخ</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">المخالفة</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">الموظف</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">المبلغ</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">الحالة</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">المسجل</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {violations.length === 0 ? (
                                        <tr>
                                            <td colSpan="8" className="py-12 text-center text-gray-500">
                                                <i className="fa fa-inbox text-4xl mb-4 text-gray-300"></i>
                                                <div className="text-lg">لا توجد مخالفات مسجلة</div>
                                                <p className="text-sm mt-2">لم يتم تسجيل أي مخالفات لهذا الشهر بعد</p>
                                            </td>
                                        </tr>
                                    ) : (
                                        violations.map((violation, index) => (
                                            <tr key={violation.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                <td className="py-3 px-6 border-b text-gray-600">{index + 1}</td>
                                                <td className="py-3 px-6 border-b text-gray-800">{violation.date}</td>
                                                <td className="py-3 px-6 border-b">
                                                    <div className="font-medium text-gray-800">{violation.violationName}</div>
                                                    {violation.description && (
                                                        <div className="text-sm text-gray-600 mt-1">{violation.description}</div>
                                                    )}
                                                </td>
                                                <td className="py-3 px-6 border-b text-gray-800">{violation.employeeName}</td>
                                                <td className="py-3 px-6 border-b">
                                                    <span className="font-bold text-red-600">
                                                        {violation.amount?.toLocaleString()} د.إ
                                                    </span>
                                                </td>
                                                <td className="py-3 px-6 border-b">
                                                    <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                                                        violation.status === 'OPEN'
                                                            ? 'bg-red-100 text-red-800'
                                                            : 'bg-green-100 text-green-800'
                                                    }`}>
                                                        {violation.status === 'OPEN' ? (
                                                            <>
                                                                <i className="fa fa-clock ml-1"></i>
                                                                مفتوحة
                                                            </>
                                                        ) : (
                                                            <>
                                                                <i className="fa fa-check ml-1"></i>
                                                                مغلقة
                                                            </>
                                                        )}
                                                    </span>
                                                </td>
                                                <td className="py-3 px-6 border-b text-gray-800">{violation.enteredBy}</td>
                                                <td className="py-3 px-6 border-b">
                                                    <div className="flex gap-2">
                                                        {violation.status === 'OPEN' && (
                                                            <button
                                                                onClick={() => handleStatusChange(violation.id, 'CLOSED')}
                                                                className="px-3 py-1 bg-green-100 text-green-700 hover:bg-green-200 rounded-lg text-sm transition-colors"
                                                                title="إغلاق المخالفة"
                                                            >
                                                                <i className="fa fa-check ml-1"></i>
                                                                إغلاق
                                                            </button>
                                                        )}
                                                        {violation.status === 'CLOSED' && (
                                                            <button
                                                                onClick={() => handleStatusChange(violation.id, 'OPEN')}
                                                                className="px-3 py-1 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg text-sm transition-colors"
                                                                titleإعادة فتح المخالفة"
                                                            >
                                                                <i className="fa fa-redo ml-1"></i>
                                                                إعادة فتح
                                                            </button>
                                                        )}
                                                        <button
                                                            onClick={() => handleDelete(violation.id)}
                                                            className="px-3 py-1 bg-red-100 text-red-700 hover:bg-red-200 rounded-lg text-sm transition-colors"
                                                            title="حذف المخالفة"
                                                        >
                                                            <i className="fa fa-trash ml-1"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {/* Summary */}
                    {violations.length > 0 && (
                        <div className="bg-white rounded-xl shadow-sm p-6">
                            <h3 className="font-bold text-lg text-gray-800 mb-4">ملخص المخالفات</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 className="font-medium text-gray-700 mb-3">حسب الحالة</h4>
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">مفتوحة:</span>
                                            <span className="font-bold text-red-600">{openViolations.length} مخالفة</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">مغلقة:</span>
                                            <span className="font-bold text-green-600">{closedViolations.length} مخالفة</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 className="font-medium text-gray-700 mb-3">حسب القيمة</h4>
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">إجمالي المخالفات:</span>
                                            <span className="font-bold text-gray-800">{violations.length} مخالفة</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">إجمالي الغرامات:</span>
                                            <span className="font-bold text-red-600">{totalAmount.toLocaleString()} د.إ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Invoice Page
        const InvoicePage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [facilityId, setFacilityId] = useState(currentUser.facilityId || '1');
            const [invoiceData, setInvoiceData] = useState(null);
            
            const facilities = DataService.facilities.getAll();
            
            useEffect(() => {
                calculateInvoice();
            }, [month, facilityId]);
            
            const calculateInvoice = () => {
                const facility = facilities.find(f => f.id === facilityId);
                if (!facility) return;
                
                // Get employees for this facility
                const employees = DataService.employees.getAll().filter(e => e.facilityId === facilityId);
                
                // Get violations for this month
                const violations = DataService.violations.getAll().filter(v => 
                    v.date?.startsWith(month) && v.facilityId === facilityId && v.status === 'OPEN'
                );
                
                // Get evaluations for this month
                const evaluations = DataService.evaluations.getAll().filter(e => 
                    e.date?.startsWith(month) && e.facilityId === facilityId
                );
                
                // Calculate salaries
                const totalSalaries = employees.reduce((sum, emp) => sum + (emp.salary || 0), 0);
                
                // Calculate violations fines
                const totalFines = violations.reduce((sum, v) => sum + (v.amount || 0), 0);
                
                // Calculate performance index
                let performanceIndex = 100;
                if (evaluations.length > 0) {
                    const totalChecks = evaluations.reduce((sum, eval) => {
                        return sum + Object.values(eval.scores || {}).length;
                    }, 0);
                    const passedChecks = evaluations.reduce((sum, eval) => {
                        return sum + Object.values(eval.scores || {}).filter(Boolean).length;
                    }, 0);
                    performanceIndex = totalChecks > 0 ? Math.round((passedChecks / totalChecks) * 100) : 100;
                }
                
                // Calculate performance deduction (5% if less than 80%)
                let performanceDeduction = 0;
                if (performanceIndex < 80) {
                    performanceDeduction = totalSalaries * 0.05;
                }
                
                // Calculate total deductions
                const totalDeductions = totalFines + performanceDeduction;
                
                // Calculate net amount
                const netAmount = totalSalaries - totalDeductions;
                
                setInvoiceData({
                    facility,
                    employees,
                    violations,
                    evaluations,
                    totalSalaries,
                    totalFines,
                    performanceIndex,
                    performanceDeduction,
                    totalDeductions,
                    netAmount,
                    month,
                    invoiceNumber: `INV-${month.replace('-', '')}-${facilityId}`,
                    issueDate: new Date().toISOString().split('T')[0]
                });
            };
            
            const handleExportPDF = () => {
                const element = document.getElementById('invoice-print');
                if (!element) return;
                
                if (window.html2pdf) {
                    window.html2pdf()
                        .set({
                            margin: 10,
                            filename: `فاتورة_${invoiceData.facility.name}_${month}.pdf`,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2, useCORS: true },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        })
                        .from(element)
                        .save();
                } else {
                    window.print();
                }
            };
            
            if (!invoiceData) {
                return (
                    <div className="flex items-center justify-center h-64">
                        <div className="text-center">
                            <i className="fa fa-spinner fa-spin text-3xl text-yellow-500 mb-4"></i>
                            <div className="text-gray-600">جاري تحضير بيانات الفاتورة...</div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">الفاتورة الشهرية</h2>
                                <p className="text-gray-600 mt-1">كشف حساب مفصل للشهر المالي</p>
                            </div>
                            <div className="flex flex-col sm:flex-row gap-3">
                                {currentUser.role === 'ADMIN' && (
                                    <select
                                        value={facilityId}
                                        onChange={(e) => setFacilityId(e.target.value)}
                                        className="border border-gray-300 rounded-lg px-3 py-2"
                                    >
                                        {facilities.map(facility => (
                                            <option key={facility.id} value={facility.id}>
                                                {facility.name}
                                            </option>
                                        ))}
                                    </select>
                                )}
                                <input
                                    type="month"
                                    value={month}
                                    onChange={(e) => setMonth(e.target.value)}
                                    className="border border-gray-300 rounded-lg px-3 py-2"
                                />
                                <button
                                    onClick={handleExportPDF}
                                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    <i className="fa fa-file-pdf ml-2"></i>
                                    تصدير PDF
                                </button>
                            </div>
                        </div>
                        
                        {/* Invoice Summary */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                            <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                <div className="text-sm text-gray-600">إجمالي الرواتب</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {invoiceData.totalSalaries.toLocaleString()} د.إ
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-red-50 to-red-100 p-4 rounded-lg border border-red-200">
                                <div className="text-sm text-gray-600">إجمالي المخالفات</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {invoiceData.totalFines.toLocaleString()} د.إ
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-yellow-50 to-yellow-100 p-4 rounded-lg border border-yellow-200">
                                <div className="text-sm text-gray-600">مؤشر الأداء</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {invoiceData.performanceIndex}%
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                <div className="text-sm text-gray-600">الصافي المستحق</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {invoiceData.netAmount.toLocaleString()} د.إ
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Printable Invoice */}
                    <div id="invoice-print" className="bg-white rounded-xl shadow-sm p-8">
                        {/* Invoice Header */}
                        <div className="border-b-2 border-gray-300 pb-6 mb-6">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900">فاتورة خدمات</h1>
                                    <p className="text-gray-600 mt-2">فاتورة شهرية لخدمات تشغيل المسلخ</p>
                                </div>
                                <div className="text-left">
                                    <div className="text-2xl font-bold text-blue-600">{invoiceData.invoiceNumber}</div>
                                    <div className="text-gray-600 mt-2">تاريخ الإصدار: {invoiceData.issueDate}</div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Company Details */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                            <div>
                                <h3 className="font-bold text-lg text-gray-800 mb-3">معلومات المسلخ</h3>
                                <div className="space-y-2">
                                    <div className="flex">
                                        <span className="text-gray-600 w-32">اسم المسلخ:</span>
                                        <span className="font-medium">{invoiceData.facility.name}</span>
                                    </div>
                                    <div className="flex">
                                        <span className="text-gray-600 w-32">رقم العقد:</span>
                                        <span className="font-medium">{invoiceData.facility.contractNumber}</span>
                                    </div>
                                    <div className="flex">
                                        <span className="text-gray-600 w-32">الشركة المشغلة:</span>
                                        <span className="font-medium">{invoiceData.facility.operatingCompany}</span>
                                    </div>
                                    <div className="flex">
                                        <span className="text-gray-600 w-32">الشهر:</span>
                                        <span className="font-medium">{month}</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 className="font-bold text-lg text-gray-800 mb-3">معلومات الدفع</h3>
                                <div className="space-y-2">
                                    <div className="flex">
                                        <span className="text-gray-600 w-32">طريقة الدفع:</span>
                                        <span className="font-medium">تحويل بنكي</span>
                                    </div>
                                    <div className="flex">
                                        <span className="text-gray-600 w-32">الحساب البنكي:</span>
                                        <span className="font-medium">XXXX-XXXX-XXXX-XXXX</span>
                                    </div>
                                    <div className="flex">
                                        <span className="text-gray-600 w-32">آخر موعد للدفع:</span>
                                        <span className="font-medium">نهاية الشهر التالي</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Employees Table */}
                        <div className="mb-8">
                            <h3 className="font-bold text-lg text-gray-800 mb-4">تفاصيل الرواتب</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full border-collapse">
                                    <thead>
                                        <tr className="bg-gray-50">
                                            <th className="py-3 px-4 text-right font-semibold text-gray-700 border">#</th>
                                            <th className="py-3 px-4 text-right font-semibold text-gray-700 border">اسم الموظف</th>
                                            <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الوظيفة</th>
                                            <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الراتب الشهري</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {invoiceData.employees.map((employee, index) => (
                                            <tr key={employee.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                <td className="py-3 px-4 border text-gray-600">{index + 1}</td>
                                                <td className="py-3 px-4 border font-medium">{employee.name}</td>
                                                <td className="py-3 px-4 border">{employee.jobTitle}</td>
                                                <td className="py-3 px-4 border font-bold">{employee.salary?.toLocaleString()} د.إ</td>
                                            </tr>
                                        ))}
                                        <tr className="bg-gray-100">
                                            <td colSpan="3" className="py-3 px-4 border font-bold text-right">الإجمالي</td>
                                            <td className="py-3 px-4 border font-bold text-lg">{invoiceData.totalSalaries.toLocaleString()} د.إ</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        {/* Violations Table */}
                        {invoiceData.violations.length > 0 && (
                            <div className="mb-8">
                                <h3 className="font-bold text-lg text-gray-800 mb-4">تفاصيل المخالفات</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full border-collapse">
                                        <thead>
                                            <tr className="bg-gray-50">
                                                <th className="py-3 px-4 text-right font-semibold text-gray-700 border">#</th>
                                                <th className="py-3 px-4 text-right font-semibold text-gray-700 border">التاريخ</th>
                                                <th className="py-3 px-4 text-right font-semibold text-gray-700 border">المخالفة</th>
                                                <th className="py-3 px-4 text-right font-semibold text-gray-700 border">المبلغ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {invoiceData.violations.map((violation, index) => (
                                                <tr key={violation.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                    <td className="py-3 px-4 border text-gray-600">{index + 1}</td>
                                                    <td className="py-3 px-4 border">{violation.date}</td>
                                                    <td className="py-3 px-4 border">{violation.violationName}</td>
                                                    <td className="py-3 px-4 border font-bold text-red-600">{violation.amount?.toLocaleString()} د.إ</td>
                                                </tr>
                                            ))}
                                            <tr className="bg-red-50">
                                                <td colSpan="3" className="py-3 px-4 border font-bold text-right">إجمالي المخالفات</td>
                                                <td className="py-3 px-4 border font-bold text-lg text-red-600">{invoiceData.totalFines.toLocaleString()} د.إ</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        
                        {/* Performance Deduction */}
                        {invoiceData.performanceDeduction > 0 && (
                            <div className="mb-8">
                                <h3 className="font-bold text-lg text-gray-800 mb-4">خصم مؤشر الأداء</h3>
                                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <div className="font-medium text-gray-800">مؤشر الأداء الشهري</div>
                                            <div className="text-sm text-gray-600">نسبة الإنجاز بناءً على التقييمات اليومية</div>
                                        </div>
                                        <div className="text-right">
                                            <div className={`text-2xl font-bold ${
                                                invoiceData.performanceIndex >= 80 ? 'text-green-600' : 'text-red-600'
                                            }`}>
                                                {invoiceData.performanceIndex}%
                                            </div>
                                            <div className="text-sm text-gray-600 mt-1">من 100% المطلوبة</div>
                                        </div>
                                    </div>
                                    <div className="mt-4 pt-4 border-t border-yellow-200">
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-700">قيمة الخصم (5% من إجمالي الرواتب):</span>
                                            <span className="font-bold text-red-600">{invoiceData.performanceDeduction.toLocaleString()} د.إ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Final Summary */}
                        <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
                            <h3 className="font-bold text-lg text-gray-800 mb-4">ملخص الفاتورة</h3>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className="text-gray-700">إجمالي الرواتب:</span>
                                    <span className="font-bold">{invoiceData.totalSalaries.toLocaleString()} د.إ</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-gray-700">إجمالي المخالفات:</span>
                                    <span className="font-bold text-red-600">- {invoiceData.totalFines.toLocaleString()} د.إ</span>
                                </div>
                                {invoiceData.performanceDeduction > 0 && (
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-700">خصم مؤشر الأداء:</span>
                                        <span className="font-bold text-red-600">- {invoiceData.performanceDeduction.toLocaleString()} د.إ</span>
                                    </div>
                                )}
                                <div className="pt-3 border-t border-gray-300">
                                    <div className="flex justify-between items-center">
                                        <span className="text-lg font-bold text-gray-900">الصافي المستحق:</span>
                                        <span className="text-2xl font-bold text-green-600">{invoiceData.netAmount.toLocaleString()} د.إ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Payment Terms */}
                        <div className="mt-8 pt-6 border-t border-gray-300">
                            <h4 className="font-bold text-gray-800 mb-3">شروط الدفع:</h4>
                            <ul className="list-disc pr-5 text-gray-600 space-y-1">
                                <li>يتم الدفع خلال 30 يوم من تاريخ استلام الفاتورة</li>
                                <li>يجب أن يكون الدفع بالعملة المحلية (الدرهم الإماراتي)</li>
                                <li>يجب إرفاق نسخة من الفاتورة مع طلب الدفع</li>
                                <li>جميع المبالغ شاملة الضرائب إن وجدت</li>
                            </ul>
                        </div>
                    </div>
                    
                    {/* Actions */}
                    <div className="flex justify-between items-center">
                        <button
                            onClick={() => window.history.back()}
                            className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                        >
                            <i className="fa fa-arrow-right ml-2"></i>
                            رجوع
                        </button>
                        <div className="flex gap-3">
                            <button
                                onClick={calculateInvoice}
                                className="px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors"
                            >
                                <i className="fa fa-redo ml-2"></i>
                                إعادة حساب
                            </button>
                            <button
                                onClick={handleExportPDF}
                                className="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                <i className="fa fa-download ml-2"></i>
                                تحميل الفاتورة
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Settings Page
        const SettingsPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [activeTab, setActiveTab] = useState('facilities');
            const [facilities, setFacilities] = useState(DataService.facilities.getAll());
            const [employees, setEmployees] = useState(DataService.employees.getAll());
            const [users, setUsers] = useState(DataService.users.getAll());
            
            const [newFacility, setNewFacility] = useState({
                name: '',
                contractNumber: '',
                operatingCompany: '',
                location: '',
                phone: '',
                email: ''
            });
            
            const [newEmployee, setNewEmployee] = useState({
                name: '',
                jobTitle: '',
                salary: 0,
                facilityId: ''
            });
            
            const [newUser, setNewUser] = useState({
                id: '',
                name: '',
                role: 'USER',
                facilityId: ''
            });
            
            const handleSaveFacilities = () => {
                DataService.facilities.save(facilities);
                showToast('تم حفظ التغييرات في المواقع');
            };
            
            const handleSaveEmployees = () => {
                DataService.employees.save(employees);
                showToast('تم حفظ التغييرات في الموظفين');
            };
            
            const handleSaveUsers = () => {
                DataService.users.save(users);
                showToast('تم حفظ التغييرات في المستخدمين');
            };
            
            const handleAddFacility = () => {
                if (!newFacility.name || !newFacility.contractNumber) {
                    showToast('يرجى ملء الحقول المطلوبة', 'error');
                    return;
                }
                
                const facility = {
                    ...newFacility,
                    id: Date.now().toString()
                };
                
                setFacilities([...facilities, facility]);
                setNewFacility({
                    name: '',
                    contractNumber: '',
                    operatingCompany: '',
                    location: '',
                    phone: '',
                    email: ''
                });
                
                showToast('تم إضافة الموقع بنجاح');
            };
            
            const handleAddEmployee = () => {
                if (!newEmployee.name || !newEmployee.jobTitle || !newEmployee.facilityId) {
                    showToast('يرجى ملء الحقول المطلوبة', 'error');
                    return;
                }
                
                const employee = {
                    ...newEmployee,
                    id: 'e' + Date.now().toString()
                };
                
                setEmployees([...employees, employee]);
                setNewEmployee({
                    name: '',
                    jobTitle: '',
                    salary: 0,
                    facilityId: ''
                });
                
                showToast('تم إضافة الموظف بنجاح');
            };
            
            const handleAddUser = () => {
                if (!newUser.id || !newUser.name) {
                    showToast('يرجى ملء الحقول المطلوبة', 'error');
                    return;
                }
                
                const userExists = users.find(u => u.id === newUser.id);
                if (userExists) {
                    showToast('الرمز الوظيفي موجود مسبقاً', 'error');
                    return;
                }
                
                setUsers([...users, newUser]);
                setNewUser({
                    id: '',
                    name: '',
                    role: 'USER',
                    facilityId: ''
                });
                
                showToast('تم إضافة المستخدم بنجاح');
            };
            
            const handleDeleteFacility = (id) => {
                if (window.confirm('هل أنت متأكد من حذف هذا الموقع؟')) {
                    const updated = facilities.filter(f => f.id !== id);
                    setFacilities(updated);
                    showToast('تم حذف الموقع');
                }
            };
            
            const handleDeleteEmployee = (id) => {
                if (window.confirm('هل أنت متأكد من حذف هذا الموظف؟')) {
                    const updated = employees.filter(e => e.id !== id);
                    setEmployees(updated);
                    showToast('تم حذف الموظف');
                }
            };
            
            const handleDeleteUser = (id) => {
                if (id === currentUser.id) {
                    showToast('لا يمكن حذف المستخدم الحالي', 'error');
                    return;
                }
                
                if (window.confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                    const updated = users.filter(u => u.id !== id);
                    setUsers(updated);
                    showToast('تم حذف المستخدم');
                }
            };
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <h2 className="text-2xl font-bold text-gray-800">الإعدادات والنظام</h2>
                        <p className="text-gray-600 mt-1">إدارة إعدادات النظام والمستخدمين والمواقع</p>
                    </div>
                    
                    {/* Tabs */}
                    <div className="bg-white rounded-xl shadow-sm">
                        <div className="border-b border-gray-200">
                            <nav className="flex space-x-8 px-6" aria-label="Tabs">
                                <button
                                    onClick={() => setActiveTab('facilities')}
                                    className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                        activeTab === 'facilities'
                                            ? 'border-yellow-500 text-yellow-600'
                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                    }`}
                                >
                                    <i className="fa fa-building ml-2"></i>
                                    المواقع
                                </button>
                                <button
                                    onClick={() => setActiveTab('employees')}
                                    className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                        activeTab === 'employees'
                                            ? 'border-yellow-500 text-yellow-600'
                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                    }`}
                                >
                                    <i className="fa fa-users ml-2"></i>
                                    الموظفين
                                </button>
                                <button
                                    onClick={() => setActiveTab('users')}
                                    className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                        activeTab === 'users'
                                            ? 'border-yellow-500 text-yellow-600'
                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                    }`}
                                >
                                    <i className="fa fa-user-cog ml-2"></i>
                                    المستخدمين
                                </button>
                            </nav>
                        </div>
                        
                        <div className="p-6">
                            {/* Facilities Tab */}
                            {activeTab === 'facilities' && (
                                <div className="space-y-6">
                                    <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
                                        <h3 className="font-bold text-lg text-gray-800 mb-4">إضافة موقع جديد</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">اسم المسلخ *</label>
                                                <input
                                                    type="text"
                                                    value={newFacility.name}
                                                    onChange={(e) => setNewFacility({...newFacility, name: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                    placeholder="مثال: مسلخ أ"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">رقم العقد *</label>
                                                <input
                                                    type="text"
                                                    value={newFacility.contractNumber}
                                                    onChange={(e) => setNewFacility({...newFacility, contractNumber: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                    placeholder="مثال: CNT-2024-001"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">الشركة المشغلة</label>
                                                <input
                                                    type="text"
                                                    value={newFacility.operatingCompany}
                                                    onChange={(e) => setNewFacility({...newFacility, operatingCompany: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                    placeholder="اسم الشركة"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">الموقع</label>
                                                <input
                                                    type="text"
                                                    value={newFacility.location}
                                                    onChange={(e) => setNewFacility({...newFacility, location: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                    placeholder="الموقع الجغرافي"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">الهاتف</label>
                                                <input
                                                    type="text"
                                                    value={newFacility.phone}
                                                    onChange={(e) => setNewFacility({...newFacility, phone: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                    placeholder="رقم الهاتف"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
                                                <input
                                                    type="email"
                                                    value={newFacility.email}
                                                    onChange={(e) => setNewFacility({...newFacility, email: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                    placeholder="email@example.com"
                                                />
                                            </div>
                                        </div>
                                        <button
                                            onClick={handleAddFacility}
                                            className="mt-6 px-6 py-3 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition-colors"
                                        >
                                            <i className="fa fa-plus ml-2"></i>
                                            إضافة موقع
                                        </button>
                                    </div>
                                    
                                    <div>
                                        <h3 className="font-bold text-lg text-gray-800 mb-4">قائمة المواقع</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full border-collapse">
                                                <thead>
                                                    <tr className="bg-gray-50">
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">اسم المسلخ</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">رقم العقد</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الشركة</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الموقع</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الإجراءات</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {facilities.length === 0 ? (
                                                        <tr>
                                                            <td colSpan="5" className="py-8 text-center text-gray-500">
                                                                <i className="fa fa-building text-3xl mb-4 text-gray-300"></i>
                                                                <div>لا توجد مواقع مسجلة</div>
                                                            </td>
                                                        </tr>
                                                    ) : (
                                                        facilities.map((facility, index) => (
                                                            <tr key={facility.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                                <td className="py-3 px-4 border font-medium">{facility.name}</td>
                                                                <td className="py-3 px-4 border">{facility.contractNumber}</td>
                                                                <td className="py-3 px-4 border">{facility.operatingCompany || '-'}</td>
                                                                <td className="py-3 px-4 border">{facility.location || '-'}</td>
                                                                <td className="py-3 px-4 border">
                                                                    <button
                                                                        onClick={() => handleDeleteFacility(facility.id)}
                                                                        className="px-3 py-1 bg-red-100 text-red-700 hover:bg-red-200 rounded text-sm transition-colors"
                                                                    >
                                                                        <i className="fa fa-trash ml-1"></i>
                                                                        حذف
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                        <button
                                            onClick={handleSaveFacilities}
                                            className="mt-6 px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors"
                                        >
                                            <i className="fa fa-save ml-2"></i>
                                            حفظ التغييرات
                                        </button>
                                    </div>
                                </div>
                            )}
                            
                            {/* Employees Tab */}
                            {activeTab === 'employees' && (
                                <div className="space-y-6">
                                    <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
                                        <h3 className="font-bold text-lg text-gray-800 mb-4">إضافة موظف جديد</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">اسم الموظف *</label>
                                                <input
                                                    type="text"
                                                    value={newEmployee.name}
                                                    onChange={(e) => setNewEmployee({...newEmployee, name: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                    placeholder="الاسم الكامل"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">الوظيفة *</label>
                                                <input
                                                    type="text"
                                                    value={newEmployee.jobTitle}
                                                    onChange={(e) => setNewEmployee({...newEmployee, jobTitle: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                    placeholder="مثال: مشرف المسلخ"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">الراتب الشهري</label>
                                                <input
                                                    type="number"
                                                    value={newEmployee.salary}
                                                    onChange={(e) => setNewEmployee({...newEmployee, salary: parseInt(e.target.value) || 0})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                    placeholder="المبلغ بالدرهم"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">الموقع *</label>
                                                <select
                                                    value={newEmployee.facilityId}
                                                    onChange={(e) => setNewEmployee({...newEmployee, facilityId: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                >
                                                    <option value="">اختر الموقع</option>
                                                    {facilities.map(facility => (
                                                        <option key={facility.id} value={facility.id}>
                                                            {facility.name}
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                        <button
                                            onClick={handleAddEmployee}
                                            className="mt-6 px-6 py-3 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition-colors"
                                        >
                                            <i className="fa fa-plus ml-2"></i>
                                            إضافة موظف
                                        </button>
                                    </div>
                                    
                                    <div>
                                        <h3 className="font-bold text-lg text-gray-800 mb-4">قائمة الموظفين</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full border-collapse">
                                                <thead>
                                                    <tr className="bg-gray-50">
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الاسم</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الوظيفة</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الراتب</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الموقع</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الإجراءات</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {employees.length === 0 ? (
                                                        <tr>
                                                            <td colSpan="5" className="py-8 text-center text-gray-500">
                                                                <i className="fa fa-users text-3xl mb-4 text-gray-300"></i>
                                                                <div>لا توجد موظفين مسجلين</div>
                                                            </td>
                                                        </tr>
                                                    ) : (
                                                        employees.map((employee, index) => (
                                                            <tr key={employee.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                                <td className="py-3 px-4 border font-medium">{employee.name}</td>
                                                                <td className="py-3 px-4 border">{employee.jobTitle}</td>
                                                                <td className="py-3 px-4 border">{employee.salary?.toLocaleString()} د.إ</td>
                                                                <td className="py-3 px-4 border">
                                                                    {facilities.find(f => f.id === employee.facilityId)?.name || '-'}
                                                                </td>
                                                                <td className="py-3 px-4 border">
                                                                    <button
                                                                        onClick={() => handleDeleteEmployee(employee.id)}
                                                                        className="px-3 py-1 bg-red-100 text-red-700 hover:bg-red-200 rounded text-sm transition-colors"
                                                                    >
                                                                        <i className="fa fa-trash ml-1"></i>
                                                                        حذف
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                        <button
                                            onClick={handleSaveEmployees}
                                            className="mt-6 px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors"
                                        >
                                            <i className="fa fa-save ml-2"></i>
                                            حفظ التغييرات
                                        </button>
                                    </div>
                                </div>
                            )}
                            
                            {/* Users Tab */}
                            {activeTab === 'users' && (
                                <div className="space-y-6">
                                    <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
                                        <h3 className="font-bold text-lg text-gray-800 mb-4">إضافة مستخدم جديد</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">الرمز الوظيفي *</label>
                                                <input
                                                    type="text"
                                                    value={newUser.id}
                                                    onChange={(e) => setNewUser({...newUser, id: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                    placeholder="أدخل الرمز الوظيفي"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">اسم المستخدم *</label>
                                                <input
                                                    type="text"
                                                    value={newUser.name}
                                                    onChange={(e) => setNewUser({...newUser, name: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                    placeholder="الاسم الكامل"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">الدور *</label>
                                                <select
                                                    value={newUser.role}
                                                    onChange={(e) => setNewUser({...newUser, role: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                >
                                                    <option value="USER">طبيب بيطري</option>
                                                    <option value="ADMIN">مدير نظام</option>
                                                    <option value="DEPT_MANAGER">مدير إدارة</option>
                                                    <option value="SECTION_HEAD">رئيس شعبة</option>
                                                    <option value="CONTRACTOR">مقاول</option>
                                                    <option value="CONTRACT_MANAGER">مدير عقود</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">الموقع</label>
                                                <select
                                                    value={newUser.facilityId}
                                                    onChange={(e) => setNewUser({...newUser, facilityId: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                                >
                                                    <option value="">الكل</option>
                                                    {facilities.map(facility => (
                                                        <option key={facility.id} value={facility.id}>
                                                            {facility.name}
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                        <button
                                            onClick={handleAddUser}
                                            className="mt-6 px-6 py-3 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition-colors"
                                        >
                                            <i className="fa fa-plus ml-2"></i>
                                            إضافة مستخدم
                                        </button>
                                    </div>
                                    
                                    <div>
                                        <h3 className="font-bold text-lg text-gray-800 mb-4">قائمة المستخدمين</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full border-collapse">
                                                <thead>
                                                    <tr className="bg-gray-50">
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الرمز</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الاسم</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الدور</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الموقع</th>
                                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الإجراءات</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {users.length === 0 ? (
                                                        <tr>
                                                            <td colSpan="5" className="py-8 text-center text-gray-500">
                                                                <i className="fa fa-user-cog text-3xl mb-4 text-gray-300"></i>
                                                                <div>لا توجد مستخدمين مسجلين</div>
                                                            </td>
                                                        </tr>
                                                    ) : (
                                                        users.map((user, index) => (
                                                            <tr key={user.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                                <td className="py-3 px-4 border font-medium">{user.id}</td>
                                                                <td className="py-3 px-4 border">{user.name}</td>
                                                                <td className="py-3 px-4 border">
                                                                    <span className="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
                                                                        {user.role}
                                                                    </span>
                                                                </td>
                                                                <td className="py-3 px-4 border">
                                                                    {user.facilityId ? 
                                                                        facilities.find(f => f.id === user.facilityId)?.name : 
                                                                        'الكل'}
                                                                </td>
                                                                <td className="py-3 px-4 border">
                                                                    <button
                                                                        onClick={() => handleDeleteUser(user.id)}
                                                                        className="px-3 py-1 bg-red-100 text-red-700 hover:bg-red-200 rounded text-sm transition-colors"
                                                                        disabled={user.id === currentUser.id}
                                                                    >
                                                                        <i className="fa fa-trash ml-1"></i>
                                                                        حذف
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                        <button
                                            onClick={handleSaveUsers}
                                            className="mt-6 px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors"
                                        >
                                            <i className="fa fa-save ml-2"></i>
                                            حفظ التغييرات
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* System Info */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <h3 className="font-bold text-lg text-gray-800 mb-4">معلومات النظام</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div className="text-sm text-gray-600">عدد المواقع</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">{facilities.length}</div>
                            </div>
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div className="text-sm text-gray-600">عدد الموظفين</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">{employees.length}</div>
                            </div>
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div className="text-sm text-gray-600">عدد المستخدمين</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">{users.length}</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Monthly Report Page
        const MonthlyReportPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [facilityId, setFacilityId] = useState(currentUser.facilityId || '1');
            const [reportData, setReportData] = useState(null);
            
            const facilities = DataService.facilities.getAll();
            
            useEffect(() => {
                generateReport();
            }, [month, facilityId]);
            
            const generateReport = () => {
                const facility = facilities.find(f => f.id === facilityId);
                if (!facility) return;
                
                // Get data for the selected month
                const evaluations = DataService.evaluations.getAll().filter(e => 
                    e.date?.startsWith(month) && e.facilityId === facilityId
                );
                
                const violations = DataService.violations.getAll().filter(v => 
                    v.date?.startsWith(month) && v.facilityId === facilityId
                );
                
                const employees = DataService.employees.getAll().filter(e => e.facilityId === facilityId);
                
                // Calculate statistics
                const totalDays = new Date(parseInt(month.split('-')[0]), parseInt(month.split('-')[1]), 0).getDate();
                const evaluatedDays = evaluations.length;
                
                let supervisorAbsences = 0;
                let workerAbsences = 0;
                let safetyViolations = 0;
                let hygieneViolations = 0;
                let labViolations = 0;
                
                // Calculate absences from evaluations
                evaluations.forEach(evaluation => {
                    employees.forEach(employee => {
                        const isSupervisor = employee.jobTitle.includes('مشرف');
                        const isAbsent = evaluation.scores && evaluation.scores[`i1_${employee.id}`] === false;
                        
                        if (isAbsent) {
                            if (isSupervisor) supervisorAbsences++;
                            else workerAbsences++;
                        }
                    });
                });
                
                // Count violation types
                violations.forEach(violation => {
                    if (violation.violationTypeId === 'v18') {
                        labViolations++;
                    } else if (['v5', 'v12'].includes(violation.violationTypeId)) {
                        safetyViolations++;
                    } else {
                        hygieneViolations++;
                    }
                });
                
                // Calculate performance index
                let performanceIndex = 100;
                if (evaluations.length > 0) {
                    const totalChecks = evaluations.reduce((sum, eval) => {
                        return sum + Object.values(eval.scores || {}).length;
                    }, 0);
                    const passedChecks = evaluations.reduce((sum, eval) => {
                        return sum + Object.values(eval.scores || {}).filter(Boolean).length;
                    }, 0);
                    performanceIndex = totalChecks > 0 ? Math.round((passedChecks / totalChecks) * 100) : 100;
                }
                
                setReportData({
                    facility,
                    month,
                    totalDays,
                    evaluatedDays,
                    supervisorAbsences,
                    workerAbsences,
                    safetyViolations,
                    hygieneViolations,
                    labViolations,
                    performanceIndex,
                    totalViolations: violations.length,
                    totalFines: violations.reduce((sum, v) => sum + (v.amount || 0), 0)
                });
            };
            
            const handleExportPDF = () => {
                const element = document.getElementById('monthly-report-print');
                if (!element) return;
                
                if (window.html2pdf) {
                    window.html2pdf()
                        .set({
                            margin: 10,
                            filename: `تقرير_شهري_${reportData.facility.name}_${month}.pdf`,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2, useCORS: true },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        })
                        .from(element)
                        .save();
                } else {
                    window.print();
                }
            };
            
            if (!reportData) {
                return (
                    <div className="flex items-center justify-center h-64">
                        <div className="text-center">
                            <i className="fa fa-spinner fa-spin text-3xl text-yellow-500 mb-4"></i>
                            <div className="text-gray-600">جاري تحضير التقرير...</div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">التقرير الشهري</h2>
                                <p className="text-gray-600 mt-1">تقرير شامل عن أداء المسلخ خلال الشهر</p>
                            </div>
                            <div className="flex flex-col sm:flex-row gap-3">
                                {currentUser.role === 'ADMIN' && (
                                    <select
                                        value={facilityId}
                                        onChange={(e) => setFacilityId(e.target.value)}
                                        className="border border-gray-300 rounded-lg px-3 py-2"
                                    >
                                        {facilities.map(facility => (
                                            <option key={facility.id} value={facility.id}>
                                                {facility.name}
                                            </option>
                                        ))}
                                    </select>
                                )}
                                <input
                                    type="month"
                                    value={month}
                                    onChange={(e) => setMonth(e.target.value)}
                                    className="border border-gray-300 rounded-lg px-3 py-2"
                                />
                                <button
                                    onClick={handleExportPDF}
                                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    <i className="fa fa-file-pdf ml-2"></i>
                                    تصدير PDF
                                </button>
                            </div>
                        </div>
                        
                        {/* Report Summary */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                            <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                <div className="text-sm text-gray-600">أيام التقييم</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {reportData.evaluatedDays} / {reportData.totalDays}
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-red-50 to-red-100 p-4 rounded-lg border border-red-200">
                                <div className="text-sm text-gray-600">إجمالي المخالفات</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {reportData.totalViolations}
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-yellow-50 to-yellow-100 p-4 rounded-lg border border-yellow-200">
                                <div className="text-sm text-gray-600">مؤشر الأداء</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {reportData.performanceIndex}%
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                <div className="text-sm text-gray-600">إجمالي الغرامات</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {reportData.totalFines.toLocaleString()} د.إ
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Printable Report */}
                    <div id="monthly-report-print" className="bg-white rounded-xl shadow-sm p-8">
                        {/* Report Header */}
                        <div className="text-center border-b-2 border-gray-300 pb-6 mb-6">
                            <h1 className="text-3xl font-bold text-gray-900">التقرير الشهري</h1>
                            <h2 className="text-2xl text-gray-700 mt-2">مسلخ {reportData.facility.name}</h2>
                            <div className="mt-4">
                                <div className="text-lg text-gray-600">لشهر: {month}</div>
                                <div className="text-sm text-gray-500">تاريخ الإصدار: {new Date().toLocaleDateString('ar-AE')}</div>
                            </div>
                        </div>
                        
                        {/* Facility Information */}
                        <div className="mb-8">
                            <h3 className="font-bold text-xl text-gray-800 mb-4 border-b pb-2">معلومات المسلخ</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <h4 className="font-bold text-gray-700 mb-3">البيانات الأساسية</h4>
                                    <div className="space-y-2">
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">اسم المسلخ:</span>
                                            <span className="font-medium">{reportData.facility.name}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">رقم العقد:</span>
                                            <span className="font-medium">{reportData.facility.contractNumber}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">الشركة المشغلة:</span>
                                            <span className="font-medium">{reportData.facility.operatingCompany}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">الشهر:</span>
                                            <span className="font-medium">{month}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <h4 className="font-bold text-gray-700 mb-3">إحصائيات التقييم</h4>
                                    <div className="space-y-2">
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">عدد أيام الشهر:</span>
                                            <span className="font-medium">{reportData.totalDays} يوم</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">أيام التقييم:</span>
                                            <span className="font-medium">{reportData.evaluatedDays} يوم</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">معدل التقييم:</span>
                                            <span className="font-medium">
                                                {Math.round((reportData.evaluatedDays / reportData.totalDays) * 100)}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Violations Summary */}
                        <div className="mb-8">
                            <h3 className="font-bold text-xl text-gray-800 mb-4 border-b pb-2">ملخص المخالفات</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 className="font-bold text-gray-700 mb-3">حسب النوع</h4>
                                    <div className="space-y-3">
                                        <div className="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                            <div className="flex items-center">
                                                <i className="fa fa-user-tie text-blue-600 ml-2"></i>
                                                <span>غياب مشرفين</span>
                                            </div>
                                            <span className="font-bold">{reportData.supervisorAbsences} مرة</span>
                                        </div>
                                        <div className="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                            <div className="flex items-center">
                                                <i className="fa fa-users text-blue-600 ml-2"></i>
                                                <span>غياب عمال</span>
                                            </div>
                                            <span className="font-bold">{reportData.workerAbsences} مرة</span>
                                        </div>
                                        <div className="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                            <div className="flex items-center">
                                                <i className="fa fa-exclamation-triangle text-red-600 ml-2"></i>
                                                <span>مخالفات سلامة</span>
                                            </div>
                                            <span className="font-bold">{reportData.safetyViolations} مخالفة</span>
                                        </div>
                                        <div className="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                                            <div className="flex items-center">
                                                <i className="fa fa-soap text-yellow-600 ml-2"></i>
                                                <span>مخالفات نظافة</span>
                                            </div>
                                            <span className="font-bold">{reportData.hygieneViolations} مخالفة</span>
                                        </div>
                                        <div className="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                            <div className="flex items-center">
                                                <i className="fa fa-flask text-green-600 ml-2"></i>
                                                <span>فحوصات مختبرية</span>
                                            </div>
                                            <span className="font-bold">{reportData.labViolations} مخالفة</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 className="font-bold text-gray-700 mb-3">التقييم الشهري</h4>
                                    <div className="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-lg border border-gray-200">
                                        <div className="text-center mb-6">
                                            <div className={`text-5xl font-bold mb-2 ${
                                                reportData.performanceIndex >= 90 ? 'text-green-600' :
                                                reportData.performanceIndex >= 70 ? 'text-yellow-600' :
                                                'text-red-600'
                                            }`}>
                                                {reportData.performanceIndex}%
                                            </div>
                                            <div className="text-gray-600">مؤشر الأداء الشهري</div>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center">
                                                <span className="text-gray-600">إجمالي المخالفات:</span>
                                                <span className="font-bold">{reportData.totalViolations}</span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-gray-600">إجمالي الغرامات:</span>
                                                <span className="font-bold text-red-600">{reportData.totalFines.toLocaleString()} د.إ</span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-gray-600">أيام الغياب:</span>
                                                <span className="font-bold">{reportData.supervisorAbsences + reportData.workerAbsences} يوم</span>
                                            </div>
                                        </div>
                                        
                                        <div className="mt-6 pt-4 border-t border-gray-300">
                                            <div className="text-sm text-gray-600">
                                                <i className="fa fa-info-circle ml-2"></i>
                                                التقييم يعتمد على نسبة المطابقة في التقييمات اليومية
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Performance Analysis */}
                        <div className="mb-8">
                            <h3 className="font-bold text-xl text-gray-800 mb-4 border-b pb-2">تحليل الأداء</h3>
                            <div className="bg-gray-50 p-6 rounded-lg">
                                <div className="mb-4">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="font-medium text-gray-700">مستوى الأداء الشهري</span>
                                        <span className={`font-bold ${
                                            reportData.performanceIndex >= 90 ? 'text-green-600' :
                                            reportData.performanceIndex >= 70 ? 'text-yellow-600' :
                                            'text-red-600'
                                        }`}>
                                            {reportData.performanceIndex >= 90 ? 'ممتاز' :
                                             reportData.performanceIndex >= 70 ? 'جيد' :
                                             'مقبول'}
                                        </span>
                                    </div>
                                    <div className="h-4 bg-gray-200 rounded-full overflow-hidden">
                                        <div 
                                            className={`h-full rounded-full ${
                                                reportData.performanceIndex >= 90 ? 'bg-green-500' :
                                                reportData.performanceIndex >= 70 ? 'bg-yellow-500' :
                                                'bg-red-500'
                                            }`}
                                            style={{ width: `${reportData.performanceIndex}%` }}
                                        ></div>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                    <div>
                                        <h4 className="font-bold text-gray-700 mb-3">نقاط القوة</h4>
                                        <ul className="space-y-2">
                                            <li className="flex items-center">
                                                <i className="fa fa-check-circle text-green-500 ml-2"></i>
                                                <span>استمرارية التقييم اليومي</span>
                                            </li>
                                            <li className="flex items-center">
                                                <i className="fa fa-check-circle text-green-500 ml-2"></i>
                                                <span>نسبة مرتفعة من أيام التقييم</span>
                                            </li>
                                            {reportData.labViolations === 0 && (
                                                <li className="flex items-center">
                                                    <i className="fa fa-check-circle text-green-500 ml-2"></i>
                                                    <span>عدم وجود مخالفات مختبرية</span>
                                                </li>
                                            )}
                                        </ul>
                                    </div>
                                    
                                    <div>
                                        <h4 className="font-bold text-gray-700 mb-3">مجالات التحسين</h4>
                                        <ul className="space-y-2">
                                            {reportData.safetyViolations > 0 && (
                                                <li className="flex items-center">
                                                    <i className="fa fa-exclamation-circle text-red-500 ml-2"></i>
                                                    <span>تحسين الالتزام بمعايير السلامة</span>
                                                </li>
                                            )}
                                            {reportData.hygieneViolations > 0 && (
                                                <li className="flex items-center">
                                                    <i className="fa fa-exclamation-circle text-red-500 ml-2"></i>
                                                    <span>تحسين مستويات النظافة</span>
                                                </li>
                                            )}
                                            {reportData.supervisorAbsences > 0 && (
                                                <li className="flex items-center">
                                                    <i className="fa fa-exclamation-circle text-yellow-500 ml-2"></i>
                                                    <span>تقليل أيام غياب المشرفين</span>
                                                </li>
                                            )}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Recommendations */}
                        <div className="mb-8">
                            <h3 className="font-bold text-xl text-gray-800 mb-4 border-b pb-2">التوصيات</h3>
                            <div className="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                                <div className="space-y-3">
                                    <div className="flex items-start">
                                        <i className="fa fa-lightbulb text-yellow-600 mt-1 ml-2"></i>
                                        <div>
                                            <h4 className="font-bold text-gray-800">تحسين مؤشر الأداء</h4>
                                            <p className="text-gray-700 mt-1">
                                                التركيز على تحسين نقاط الضعف في التقييمات اليومية لرفع مؤشر الأداء
                                            </p>
                                        </div>
                                    </div>
                                    {reportData.safetyViolations > 0 && (
                                        <div className="flex items-start">
                                            <i className="fa fa-shield-alt text-red-600 mt-1 ml-2"></i>
                                            <div>
                                                <h4 className="font-bold text-gray-800">تعزيز السلامة</h4>
                                                <p className="text-gray-700 mt-1">
                                                    تنظيم دورات توعوية للعاملين حول معايير السلامة المهنية
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                    {reportData.hygieneViolations > 0 && (
                                        <div className="flex items-start">
                                            <i className="fa fa-hand-sparkles text-blue-600 mt-1 ml-2"></i>
                                            <div>
                                                <h4 className="font-bold text-gray-800">تحسين النظافة</h4>
                                                <p className="text-gray-700 mt-1">
                                                    زيادة عدد مرات التنظيف والتطهير وتوفير المستلزمات اللازمة
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        
                        {/* Signatures */}
                        <div className="mt-12">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="text-center">
                                    <div className="border-t-2 border-gray-300 pt-4">
                                        <div className="font-bold text-gray-800">الطبيب المناوب</div>
                                        <div className="h-8 mt-2"></div>
                                        <div className="text-sm text-gray-600">التوقيع</div>
                                    </div>
                                </div>
                                
                                <div className="text-center">
                                    <div className="border-t-2 border-gray-300 pt-4">
                                        <div className="font-bold text-gray-800">ممثل المقاول</div>
                                        <div className="h-8 mt-2"></div>
                                        <div className="text-sm text-gray-600">التوقيع</div>
                                    </div>
                                </div>
                                
                                <div className="text-center">
                                    <div className="border-t-2 border-gray-300 pt-4">
                                        <div className="font-bold text-gray-800">رئيس الشعبة</div>
                                        <div className="h-8 mt-2"></div>
                                        <div className="text-sm text-gray-600">التوقيع</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Actions */}
                    <div className="flex justify-between items-center">
                        <button
                            onClick={() => window.history.back()}
                            className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                        >
                            <i className="fa fa-arrow-right ml-2"></i>
                            رجوع
                        </button>
                        <div className="flex gap-3">
                            <button
                                onClick={generateReport}
                                className="px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors"
                            >
                                <i className="fa fa-redo ml-2"></i>
                                تحديث التقرير
                            </button>
                            <button
                                onClick={handleExportPDF}
                                className="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                <i className="fa fa-download ml-2"></i>
                                تحميل التقرير
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // KPI Page
        const KPIPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [facilityId, setFacilityId] = useState(currentUser.facilityId || '1');
            const [kpiData, setKpiData] = useState(null);
            
            const facilities = DataService.facilities.getAll();
            
            useEffect(() => {
                calculateKPI();
            }, [month, facilityId]);
            
            const calculateKPI = () => {
                const facility = facilities.find(f => f.id === facilityId);
                if (!facility) return;
                
                // Get evaluations for the month
                const evaluations = DataService.evaluations.getAll().filter(e => 
                    e.date?.startsWith(month) && e.facilityId === facilityId
                );
                
                // Get items for evaluation
                const items = DataService.items.getAll();
                
                // Calculate KPI for each item
                const itemKPIs = items.map(item => {
                    let totalChecks = 0;
                    let passedChecks = 0;
                    
                    evaluations.forEach(evaluation => {
                        const employees = DataService.employees.getAll().filter(e => e.facilityId === facilityId);
                        
                        employees.forEach(employee => {
                            const key = `${item.id}_${employee.id}`;
                            const score = evaluation.scores?.[key];
                            
                            if (score !== undefined) {
                                totalChecks++;
                                if (score === true) {
                                    passedChecks++;
                                }
                            }
                        });
                    });
                    
                    const percentage = totalChecks > 0 ? Math.round((passedChecks / totalChecks) * 100) : 0;
                    
                    return {
                        item,
                        totalChecks,
                        passedChecks,
                        percentage,
                        status: percentage >= 90 ? 'ممتاز' :
                                percentage >= 70 ? 'جيد' :
                                percentage >= 50 ? 'مقبول' : 'ضعيف'
                    };
                });
                
                // Calculate overall KPI
                const totalChecks = itemKPIs.reduce((sum, kpi) => sum + kpi.totalChecks, 0);
                const totalPassed = itemKPIs.reduce((sum, kpi) => sum + kpi.passedChecks, 0);
                const overallPercentage = totalChecks > 0 ? Math.round((totalPassed / totalChecks) * 100) : 0;
                
                setKpiData({
                    facility,
                    month,
                    itemKPIs,
                    overallPercentage,
                    totalChecks,
                    totalPassed,
                    totalItems: items.length,
                    totalEvaluations: evaluations.length
                });
            };
            
            const handleExportPDF = () => {
                const element = document.getElementById('kpi-report-print');
                if (!element) return;
                
                if (window.html2pdf) {
                    window.html2pdf()
                        .set({
                            margin: 10,
                            filename: `مؤشر_الأداء_${kpiData.facility.name}_${month}.pdf`,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2, useCORS: true },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        })
                        .from(element)
                        .save();
                } else {
                    window.print();
                }
            };
            
            if (!kpiData) {
                return (
                    <div className="flex items-center justify-center h-64">
                        <div className="text-center">
                            <i className="fa fa-spinner fa-spin text-3xl text-yellow-500 mb-4"></i>
                            <div className="text-gray-600">جاري حساب مؤشرات الأداء...</div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">مؤشرات الأداء الرئيسية</h2>
                                <p className="text-gray-600 mt-1">قياس وتقييم أداء المسلخ حسب المعايير المحددة</p>
                            </div>
                            <div className="flex flex-col sm:flex-row gap-3">
                                {currentUser.role === 'ADMIN' && (
                                    <select
                                        value={facilityId}
                                        onChange={(e) => setFacilityId(e.target.value)}
                                        className="border border-gray-300 rounded-lg px-3 py-2"
                                    >
                                        {facilities.map(facility => (
                                            <option key={facility.id} value={facility.id}>
                                                {facility.name}
                                            </option>
                                        ))}
                                    </select>
                                )}
                                <input
                                    type="month"
                                    value={month}
                                    onChange={(e) => setMonth(e.target.value)}
                                    className="border border-gray-300 rounded-lg px-3 py-2"
                                />
                                <button
                                    onClick={handleExportPDF}
                                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    <i className="fa fa-file-pdf ml-2"></i>
                                    تصدير PDF
                                </button>
                            </div>
                        </div>
                        
                        {/* KPI Summary */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                            <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                <div className="text-sm text-gray-600">مؤشر الأداء الإجمالي</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {kpiData.overallPercentage}%
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                <div className="text-sm text-gray-600">عدد التقييمات</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {kpiData.totalEvaluations}
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-yellow-50 to-yellow-100 p-4 rounded-lg border border-yellow-200">
                                <div className="text-sm text-gray-600">عدد بنود التقييم</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {kpiData.totalItems}
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                                <div className="text-sm text-gray-600">إجمالي الفحوصات</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {kpiData.totalChecks}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* KPI Chart */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <h3 className="font-bold text-lg text-gray-800 mb-6">توزيع مؤشرات الأداء</h3>
                        <div className="space-y-4">
                            {kpiData.itemKPIs.map((kpi, index) => (
                                <div key={kpi.item.id} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center">
                                            <span className="font-medium text-gray-800">{kpi.item.name}</span>
                                            <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded mr-3">
                                                {kpi.item.category}
                                            </span>
                                        </div>
                                        <div className="flex items-center">
                                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                                kpi.percentage >= 90 ? 'bg-green-100 text-green-800' :
                                                kpi.percentage >= 70 ? 'bg-yellow-100 text-yellow-800' :
                                                kpi.percentage >= 50 ? 'bg-blue-100 text-blue-800' :
                                                'bg-red-100 text-red-800'
                                            }`}>
                                                {kpi.status}
                                            </span>
                                            <span className="font-bold text-lg mr-4">{kpi.percentage}%</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center text-sm text-gray-600 mb-2">
                                        <span>الفحوصات: {kpi.passedChecks} من {kpi.totalChecks}</span>
                                    </div>
                                    <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div 
                                            className={`h-full rounded-full ${
                                                kpi.percentage >= 90 ? 'bg-green-500' :
                                                kpi.percentage >= 70 ? 'bg-yellow-500' :
                                                kpi.percentage >= 50 ? 'bg-blue-500' :
                                                'bg-red-500'
                                            }`}
                                            style={{ width: `${kpi.percentage}%` }}
                                        ></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    {/* Printable Report */}
                    <div id="kpi-report-print" className="bg-white rounded-xl shadow-sm p-8 hidden">
                        {/* Report Header */}
                        <div className="text-center border-b-2 border-gray-300 pb-6 mb-6">
                            <h1 className="text-3xl font-bold text-gray-900">مؤشرات الأداء الرئيسية</h1>
                            <h2 className="text-2xl text-gray-700 mt-2">مسلخ {kpiData.facility.name}</h2>
                            <div className="mt-4">
                                <div className="text-lg text-gray-600">لشهر: {month}</div>
                                <div className="text-sm text-gray-500">تاريخ الإصدار: {new Date().toLocaleDateString('ar-AE')}</div>
                            </div>
                        </div>
                        
                        {/* Overall KPI */}
                        <div className="text-center mb-8">
                            <div className="inline-block p-8 bg-gray-50 rounded-xl border border-gray-200">
                                <div className="text-sm text-gray-600 mb-2">مؤشر الأداء الإجمالي</div>
                                <div className={`text-5xl font-bold mb-4 ${
                                    kpiData.overallPercentage >= 90 ? 'text-green-600' :
                                    kpiData.overallPercentage >= 70 ? 'text-yellow-600' :
                                    'text-red-600'
                                }`}>
                                    {kpiData.overallPercentage}%
                                </div>
                                <div className="text-gray-700">
                                    بناءً على {kpiData.totalChecks} فحص خلال {kpiData.totalEvaluations} يوم تقييم
                                </div>
                            </div>
                        </div>
                        
                        {/* KPI Table */}
                        <div className="mb-8">
                            <h3 className="font-bold text-xl text-gray-800 mb-4 border-b pb-2">تفاصيل المؤشرات</h3>
                            <table className="w-full border-collapse">
                                <thead>
                                    <tr className="bg-gray-100">
                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">البند</th>
                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">التصنيف</th>
                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">النسبة</th>
                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">المطابقة</th>
                                        <th className="py-3 px-4 text-right font-semibold text-gray-700 border">الحالة</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {kpiData.itemKPIs.map((kpi, index) => (
                                        <tr key={kpi.item.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                            <td className="py-3 px-4 border font-medium">{kpi.item.name}</td>
                                            <td className="py-3 px-4 border">{kpi.item.category}</td>
                                            <td className="py-3 px-4 border font-bold">{kpi.percentage}%</td>
                                            <td className="py-3 px-4 border">{kpi.passedChecks}/{kpi.totalChecks}</td>
                                            <td className="py-3 px-4 border">
                                                <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm ${
                                                    kpi.percentage >= 90 ? 'bg-green-100 text-green-800' :
                                                    kpi.percentage >= 70 ? 'bg-yellow-100 text-yellow-800' :
                                                    kpi.percentage >= 50 ? 'bg-blue-100 text-blue-800' :
                                                    'bg-red-100 text-red-800'
                                                }`}>
                                                    {kpi.status}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        
                        {/* Analysis */}
                        <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
                            <h3 className="font-bold text-lg text-gray-800 mb-4">تحليل النتائج</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 className="font-bold text-gray-700 mb-3">بنود القوة</h4>
                                    <ul className="space-y-2">
                                        {kpiData.itemKPIs
                                            .filter(kpi => kpi.percentage >= 90)
                                            .map(kpi => (
                                                <li key={kpi.item.id} className="flex items-center">
                                                    <i className="fa fa-check-circle text-green-500 ml-2"></i>
                                                    <span>{kpi.item.name}: {kpi.percentage}%</span>
                                                </li>
                                            ))}
                                    </ul>
                                </div>
                                
                                <div>
                                    <h4 className="font-bold text-gray-700 mb-3">بنود تحتاج تحسين</h4>
                                    <ul className="space-y-2">
                                        {kpiData.itemKPIs
                                            .filter(kpi => kpi.percentage < 70)
                                            .map(kpi => (
                                                <li key={kpi.item.id} className="flex items-center">
                                                    <i className="fa fa-exclamation-circle text-red-500 ml-2"></i>
                                                    <span>{kpi.item.name}: {kpi.percentage}%</span>
                                                </li>
                                            ))}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Actions */}
                    <div className="flex justify-between items-center">
                        <button
                            onClick={() => window.history.back()}
                            className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                        >
                            <i className="fa fa-arrow-right ml-2"></i>
                            رجوع
                        </button>
                        <div className="flex gap-3">
                            <button
                                onClick={calculateKPI}
                                className="px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors"
                            >
                                <i className="fa fa-redo ml-2"></i>
                                إعادة الحساب
                            </button>
                            <button
                                onClick={handleExportPDF}
                                className="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                <i className="fa fa-download ml-2"></i>
                                تحميل التقرير
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Extra Labor Page
        const ExtraLaborPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [facilityId, setFacilityId] = useState(currentUser.facilityId || '1');
            const [laborData, setLaborData] = useState([]);
            const [newLabor, setNewLabor] = useState({
                name: '',
                jobTitle: '',
                dailyRate: 0,
                days: 0,
                notes: ''
            });
            
            const facilities = DataService.facilities.getAll();
            
            useEffect(() => {
                loadLaborData();
            }, [month, facilityId]);
            
            const loadLaborData = () => {
                const allLabor = DataService.extraLabor.getAll();
                const filtered = allLabor.filter(l => 
                    l.month === month && l.facilityId === facilityId
                );
                setLaborData(filtered);
            };
            
            const handleAddLabor = () => {
                if (!newLabor.name || !newLabor.jobTitle || newLabor.days <= 0) {
                    showToast('يرجى ملء الحقول المطلوبة', 'error');
                    return;
                }
                
                const labor = {
                    ...newLabor,
                    id: Date.now().toString(),
                    month,
                    facilityId,
                    addedBy: currentUser.name,
                    addedDate: new Date().toISOString(),
                    total: newLabor.dailyRate * newLabor.days
                };
                
                const allLabor = DataService.extraLabor.getAll();
                DataService.extraLabor.save([...allLabor, labor]);
                
                setNewLabor({
                    name: '',
                    jobTitle: '',
                    dailyRate: 0,
                    days: 0,
                    notes: ''
                });
                
                loadLaborData();
                showToast('تم إضافة العامل الإضافي');
            };
            
            const handleDeleteLabor = (id) => {
                if (window.confirm('هل أنت متأكد من حذف هذا العامل؟')) {
                    const updated = laborData.filter(l => l.id !== id);
                    setLaborData(updated);
                    DataService.extraLabor.save(updated);
                    showToast('تم حذف العامل');
                }
            };
            
            const totalCost = laborData.reduce((sum, labor) => sum + (labor.total || 0), 0);
            const totalDays = laborData.reduce((sum, labor) => sum + (labor.days || 0), 0);
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">العمالة الإضافية</h2>
                                <p className="text-gray-600 mt-1">إدارة وتسجيل العمالة الإضافية للمسلخ</p>
                            </div>
                            <div className="flex flex-col sm:flex-row gap-3">
                                {currentUser.role === 'ADMIN' && (
                                    <select
                                        value={facilityId}
                                        onChange={(e) => setFacilityId(e.target.value)}
                                        className="border border-gray-300 rounded-lg px-3 py-2"
                                    >
                                        {facilities.map(facility => (
                                            <option key={facility.id} value={facility.id}>
                                                {facility.name}
                                            </option>
                                        ))}
                                    </select>
                                )}
                                <input
                                    type="month"
                                    value={month}
                                    onChange={(e) => setMonth(e.target.value)}
                                    className="border border-gray-300 rounded-lg px-3 py-2"
                                />
                            </div>
                        </div>
                        
                        {/* Summary */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                            <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                <div className="text-sm text-gray-600">عدد العمال</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {laborData.length}
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                <div className="text-sm text-gray-600">إجمالي الأيام</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {totalDays}
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-yellow-50 to-yellow-100 p-4 rounded-lg border border-yellow-200">
                                <div className="text-sm text-gray-600">التكلفة الإجمالية</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {totalCost.toLocaleString()} د.إ
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Add Labor Form */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <h3 className="font-bold text-lg text-gray-800 mb-4">إضافة عامل إضافي</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">اسم العامل *</label>
                                <input
                                    type="text"
                                    value={newLabor.name}
                                    onChange={(e) => setNewLabor({...newLabor, name: e.target.value})}
                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                    placeholder="الاسم الكامل"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">الوظيفة *</label>
                                <input
                                    type="text"
                                    value={newLabor.jobTitle}
                                    onChange={(e) => setNewLabor({...newLabor, jobTitle: e.target.value})}
                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                    placeholder="مثال: عامل نظافة إضافي"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">الأجر اليومي (د.إ) *</label>
                                <input
                                    type="number"
                                    value={newLabor.dailyRate}
                                    onChange={(e) => setNewLabor({...newLabor, dailyRate: parseInt(e.target.value) || 0})}
                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                    placeholder="المبلغ بالدرهم"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">عدد الأيام *</label>
                                <input
                                    type="number"
                                    value={newLabor.days}
                                    onChange={(e) => setNewLabor({...newLabor, days: parseInt(e.target.value) || 0})}
                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                    placeholder="عدد أيام العمل"
                                />
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700 mb-2">ملاحظات</label>
                                <input
                                    type="text"
                                    value={newLabor.notes}
                                    onChange={(e) => setNewLabor({...newLabor, notes: e.target.value})}
                                    className="w-full border border-gray-300 rounded-lg px-4 py-2"
                                    placeholder="ملاحظات إضافية (اختياري)"
                                />
                            </div>
                        </div>
                        <button
                            onClick={handleAddLabor}
                            className="mt-6 px-6 py-3 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition-colors"
                        >
                            <i className="fa fa-plus ml-2"></i>
                            إضافة عامل
                        </button>
                    </div>
                    
                    {/* Labor List */}
                    <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">#</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">اسم العامل</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">الوظيفة</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">الأجر اليومي</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">عدد الأيام</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">الإجمالي</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">تاريخ الإضافة</th>
                                        <th className="py-4 px-6 text-right font-semibold text-gray-700">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {laborData.length === 0 ? (
                                        <tr>
                                            <td colSpan="8" className="py-12 text-center text-gray-500">
                                                <i className="fa fa-users text-4xl mb-4 text-gray-300"></i>
                                                <div className="text-lg">لا توجد عمالة إضافية مسجلة</div>
                                                <p className="text-sm mt-2">قم بإضافة عمال إضافيين باستخدام النموذج أعلاه</p>
                                            </td>
                                        </tr>
                                    ) : (
                                        laborData.map((labor, index) => (
                                            <tr key={labor.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                <td className="py-3 px-6 border-b text-gray-600">{index + 1}</td>
                                                <td className="py-3 px-6 border-b font-medium">{labor.name}</td>
                                                <td className="py-3 px-6 border-b">{labor.jobTitle}</td>
                                                <td className="py-3 px-6 border-b">{labor.dailyRate?.toLocaleString()} د.إ</td>
                                                <td className="py-3 px-6 border-b">{labor.days}</td>
                                                <td className="py-3 px-6 border-b font-bold">
                                                    {(labor.dailyRate * labor.days).toLocaleString()} د.إ
                                                </td>
                                                <td className="py-3 px-6 border-b">
                                                    {new Date(labor.addedDate).toLocaleDateString('ar-AE')}
                                                </td>
                                                <td className="py-3 px-6 border-b">
                                                    <button
                                                        onClick={() => handleDeleteLabor(labor.id)}
                                                        className="px-3 py-1 bg-red-100 text-red-700 hover:bg-red-200 rounded text-sm transition-colors"
                                                    >
                                                        <i className="fa fa-trash ml-1"></i>
                                                        حذف
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {/* Summary */}
                    {laborData.length > 0 && (
                        <div className="bg-white rounded-xl shadow-sm p-6">
                            <h3 className="font-bold text-lg text-gray-800 mb-4">ملخص العمالة الإضافية</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <h4 className="font-medium text-gray-700 mb-2">إجمالي التكلفة</h4>
                                    <div className="text-2xl font-bold text-gray-800">{totalCost.toLocaleString()} د.إ</div>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <h4 className="font-medium text-gray-700 mb-2">متوسط الأجر اليومي</h4>
                                    <div className="text-2xl font-bold text-gray-800">
                                        {laborData.length > 0 
                                            ? (totalCost / totalDays).toLocaleString() 
                                            : 0} د.إ
                                    </div>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <h4 className="font-medium text-gray-700 mb-2">متوسط أيام العمل</h4>
                                    <div className="text-2xl font-bold text-gray-800">
                                        {laborData.length > 0 
                                            ? (totalDays / laborData.length).toFixed(1) 
                                            : 0} يوم/عامل
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Monthly Evaluation Page
        const MonthlyEvaluationPage = ({ currentUser }) => {
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [facilityId, setFacilityId] = useState(currentUser.facilityId || '1');
            const [evaluations, setEvaluations] = useState([]);
            const [employees, setEmployees] = useState([]);
            const [items, setItems] = useState([]);
            
            const facilities = DataService.facilities.getAll();
            
            useEffect(() => {
                loadData();
            }, [month, facilityId]);
            
            const loadData = () => {
                // Get evaluations for the month
                const evals = DataService.evaluations.getAll().filter(e => 
                    e.date?.startsWith(month) && e.facilityId === facilityId
                );
                
                // Sort by date
                evals.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                setEvaluations(evals);
                
                // Get employees for this facility
                const emps = DataService.employees.getAll().filter(e => e.facilityId === facilityId);
                setEmployees(emps);
                
                // Get evaluation items
                const its = DataService.items.getAll();
                setItems(its);
            };
            
            const getScore = (evaluation, itemId, employeeId) => {
                const key = `${itemId}_${employeeId}`;
                const score = evaluation.scores?.[key];
                
                if (score === true) return { icon: 'check', color: 'text-green-500', text: 'مطابق' };
                if (score === false) return { icon: 'times', color: 'text-red-500', text: 'غير مطابق' };
                return { icon: 'minus', color: 'text-gray-400', text: 'لم يتم' };
            };
            
            const calculateMonthlyPerformance = () => {
                if (evaluations.length === 0) return 100;
                
                let totalChecks = 0;
                let passedChecks = 0;
                
                evaluations.forEach(evaluation => {
                    items.forEach(item => {
                        employees.forEach(employee => {
                            const key = `${item.id}_${employee.id}`;
                            const score = evaluation.scores?.[key];
                            
                            if (score !== undefined) {
                                totalChecks++;
                                if (score === true) {
                                    passedChecks++;
                                }
                            }
                        });
                    });
                });
                
                return totalChecks > 0 ? Math.round((passedChecks / totalChecks) * 100) : 100;
            };
            
            const monthlyPerformance = calculateMonthlyPerformance();
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">التقييم الشهري</h2>
                                <p className="text-gray-600 mt-1">عرض شامل لجميع التقييمات اليومية للشهر</p>
                            </div>
                            <div className="flex flex-col sm:flex-row gap-3">
                                {currentUser.role === 'ADMIN' && (
                                    <select
                                        value={facilityId}
                                        onChange={(e) => setFacilityId(e.target.value)}
                                        className="border border-gray-300 rounded-lg px-3 py-2"
                                    >
                                        {facilities.map(facility => (
                                            <option key={facility.id} value={facility.id}>
                                                {facility.name}
                                            </option>
                                        ))}
                                    </select>
                                )}
                                <input
                                    type="month"
                                    value={month}
                                    onChange={(e) => setMonth(e.target.value)}
                                    className="border border-gray-300 rounded-lg px-3 py-2"
                                />
                            </div>
                        </div>
                        
                        {/* Summary */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                            <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                <div className="text-sm text-gray-600">أيام التقييم</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {evaluations.length}
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                <div className="text-sm text-gray-600">عدد الموظفين</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {employees.length}
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-yellow-50 to-yellow-100 p-4 rounded-lg border border-yellow-200">
                                <div className="text-sm text-gray-600">مؤشر الأداء الشهري</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {monthlyPerformance}%
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                                <div className="text-sm text-gray-600">عدد بنود التقييم</div>
                                <div className="text-2xl font-bold text-gray-800 mt-2">
                                    {items.length}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Evaluation Table */}
                    <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full min-w-[1200px]">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th rowSpan="2" className="py-4 px-6 text-center font-semibold text-gray-700 border">
                                            التاريخ
                                        </th>
                                        <th colSpan={items.length} className="py-4 px-6 text-center font-semibold text-gray-700 border">
                                            بنود التقييم
                                        </th>
                                    </tr>
                                    <tr>
                                        {items.map(item => (
                                            <th key={item.id} className="py-3 px-4 text-center font-semibold text-gray-700 border text-sm">
                                                {item.name}
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {evaluations.length === 0 ? (
                                        <tr>
                                            <td colSpan={items.length + 1} className="py-12 text-center text-gray-500">
                                                <i className="fa fa-calendar-times text-4xl mb-4 text-gray-300"></i>
                                                <div className="text-lg">لا توجد تقييمات لهذا الشهر</div>
                                                <p className="text-sm mt-2">قم بإضافة تقييمات يومية أولاً</p>
                                            </td>
                                        </tr>
                                    ) : (
                                        evaluations.map((evaluation, index) => (
                                            <Fragment key={evaluation.id}>
                                                <tr className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                    <td className="py-3 px-6 border text-center font-medium sticky right-0 bg-white">
                                                        {evaluation.date.split('-')[2]}
                                                        <div className="text-xs text-gray-500">
                                                            {evaluation.enteredBy}
                                                        </div>
                                                    </td>
                                                    {items.map(item => {
                                                        // Calculate percentage for this item on this day
                                                        let totalChecks = 0;
                                                        let passedChecks = 0;
                                                        
                                                        employees.forEach(employee => {
                                                            const key = `${item.id}_${employee.id}`;
                                                            const score = evaluation.scores?.[key];
                                                            
                                                            if (score !== undefined) {
                                                                totalChecks++;
                                                                if (score === true) {
                                                                    passedChecks++;
                                                                }
                                                            }
                                                        });
                                                        
                                                        const percentage = totalChecks > 0 
                                                            ? Math.round((passedChecks / totalChecks) * 100) 
                                                            : 0;
                                                        
                                                        return (
                                                            <td key={item.id} className="py-3 px-4 border text-center">
                                                                <div className="flex flex-col items-center">
                                                                    <span className={`font-bold ${
                                                                        percentage >= 90 ? 'text-green-600' :
                                                                        percentage >= 70 ? 'text-yellow-600' :
                                                                        'text-red-600'
                                                                    }`}>
                                                                        {percentage}%
                                                                    </span>
                                                                    <span className="text-xs text-gray-500">
                                                                        {passedChecks}/{totalChecks}
                                                                    </span>
                                                                </div>
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                                <tr className="bg-blue-50">
                                                    <td colSpan={items.length + 1} className="py-2 px-6 border text-center text-sm text-blue-700">
                                                        <div className="flex justify-between items-center">
                                                            <span>مؤشر اليوم: {evaluation.performanceIndex || 0}%</span>
                                                            <span>المقيّم: {evaluation.enteredBy}</span>
                                                            <span>التاريخ: {evaluation.date}</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </Fragment>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {/* Summary by Item */}
                    {evaluations.length > 0 && (
                        <div className="bg-white rounded-xl shadow-sm p-6">
                            <h3 className="font-bold text-lg text-gray-800 mb-4">أداء بنود التقييم خلال الشهر</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {items.map(item => {
                                    // Calculate monthly percentage for this item
                                    let totalChecks = 0;
                                    let passedChecks = 0;
                                    
                                    evaluations.forEach(evaluation => {
                                        employees.forEach(employee => {
                                            const key = `${item.id}_${employee.id}`;
                                            const score = evaluation.scores?.[key];
                                            
                                            if (score !== undefined) {
                                                totalChecks++;
                                                if (score === true) {
                                                    passedChecks++;
                                                }
                                            }
                                        });
                                    });
                                    
                                    const percentage = totalChecks > 0 
                                        ? Math.round((passedChecks / totalChecks) * 100) 
                                        : 0;
                                    
                                    return (
                                        <div key={item.id} className="border border-gray-200 rounded-lg p-4">
                                            <div className="flex justify-between items-start mb-2">
                                                <h4 className="font-medium text-gray-800">{item.name}</h4>
                                                <span className={`px-2 py-1 rounded text-sm ${
                                                    percentage >= 90 ? 'bg-green-100 text-green-800' :
                                                    percentage >= 70 ? 'bg-yellow-100 text-yellow-800' :
                                                    'bg-red-100 text-red-800'
                                                }`}>
                                                    {percentage}%
                                                </span>
                                            </div>
                                            <div className="text-sm text-gray-600 mb-2">{item.category}</div>
                                            <div className="flex justify-between text-sm text-gray-600">
                                                <span>المطابقة: {passedChecks}/{totalChecks}</span>
                                                <span>المتوسط اليومي: {Math.round(percentage/evaluations.length)}%</span>
                                            </div>
                                            <div className="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                <div 
                                                    className={`h-full rounded-full ${
                                                        percentage >= 90 ? 'bg-green-500' :
                                                        percentage >= 70 ? 'bg-yellow-500' :
                                                        'bg-red-500'
                                                    }`}
                                                    style={{ width: `${percentage}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                    
                    {/* Monthly Performance Analysis */}
                    <div className="bg-white rounded-xl shadow-sm p-6">
                        <h3 className="font-bold text-lg text-gray-800 mb-4">تحليل الأداء الشهري</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 className="font-medium text-gray-700 mb-3">توزيع مؤشرات الأيام</h4>
                                <div className="space-y-2">
                                    {evaluations.map(evaluation => (
                                        <div key={evaluation.id} className="flex items-center">
                                            <div className="w-24 text-sm text-gray-600">
                                                {evaluation.date.split('-')[2]} {evaluation.date.split('-')[1]}
                                            </div>
                                            <div className="flex-1">
                                                <div className="h-6 bg-gray-200 rounded-full overflow-hidden">
                                                    <div 
                                                        className={`h-full rounded-full ${
                                                            (evaluation.performanceIndex || 0) >= 90 ? 'bg-green-500' :
                                                            (evaluation.performanceIndex || 0) >= 70 ? 'bg-yellow-500' :
                                                            'bg-red-500'
                                                        }`}
                                                        style={{ width: `${evaluation.performanceIndex || 0}%` }}
                                                    ></div>
                                                </div>
                                            </div>
                                            <div className="w-16 text-right text-sm font-medium">
                                                {evaluation.performanceIndex || 0}%
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div>
                                <h4 className="font-medium text-gray-700 mb-3">الإحصائيات الشهرية</h4>
                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">متوسط المؤشر اليومي:</span>
                                            <span className="font-bold">
                                                {evaluations.length > 0 
                                                    ? Math.round(evaluations.reduce((sum, e) => sum + (e.performanceIndex || 0), 0) / evaluations.length)
                                                    : 0}%
                                            </span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">أفضل يوم:</span>
                                            <span className="font-bold text-green-600">
                                                {evaluations.length > 0 
                                                    ? Math.max(...evaluations.map(e => e.performanceIndex || 0))
                                                    : 0}%
                                            </span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">أسوأ يوم:</span>
                                            <span className="font-bold text-red-600">
                                                {evaluations.length > 0 
                                                    ? Math.min(...evaluations.map(e => e.performanceIndex || 0))
                                                    : 0}%
                                            </span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">أيام فوق 90%:</span>
                                            <span className="font-bold">
                                                {evaluations.filter(e => (e.performanceIndex || 0) >= 90).length} يوم
                                            </span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">أيام تحت 70%:</span>
                                            <span className="font-bold">
                                                {evaluations.filter(e => (e.performanceIndex || 0) < 70).length} يوم
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    setUser(JSON.parse(savedUser));
                }
                setLoading(false);
            }, []);
            
            const handleLogin = (userData) => {
                setUser(userData);
                localStorage.setItem('currentUser', JSON.stringify(userData));
            };
            
            const handleLogout = () => {
                setUser(null);
                localStorage.removeItem('currentUser');
            };
            
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-900">
                        <div className="text-white text-center">
                            <i className="fa fa-spinner fa-spin fa-3x mb-4"></i>
                            <div className="text-xl">جاري التحميل...</div>
                        </div>
                    </div>
                );
            }
            
            if (!user) {
                return <Login onLogin={handleLogin} />;
            }
            
            return (
                <ToastProvider>
                    <HashRouter>
                        <Layout currentUser={user} onLogout={handleLogout}>
                            <Routes>
                                <Route path="/" element={<Navigate to="/daily" />} />
                                <Route path="/daily" element={<DailyEvaluationPage currentUser={user} />} />
                                <Route path="/violations" element={<ViolationsPage currentUser={user} />} />
                                <Route path="/monthly" element={<MonthlyEvaluationPage currentUser={user} />} />
                                <Route path="/report" element={<MonthlyReportPage currentUser={user} />} />
                                <Route path="/kpi" element={<KPIPage currentUser={user} />} />
                                <Route path="/invoice" element={<InvoicePage currentUser={user} />} />
                                <Route path="/labor" element={<ExtraLaborPage currentUser={user} />} />
                                <Route path="/settings" element={<SettingsPage currentUser={user} />} />
                            </Routes>
                        </Layout>
                    </HashRouter>
                </ToastProvider>
            );
        };

        // Render the app
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
