<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>نظام إدارة مؤشرات الأداء والمسالخ - v8.24</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- React Router (UMD) -->
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              gold: {
                DEFAULT: '#c5b358',
                light: '#e6d89b',
                dark: '#a08f3a',
              }
            },
            fontFamily: {
              sans: ['Cairo', 'sans-serif'],
            }
          }
        }
      }
    </script>
    <style>
      body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; }
      
      /* Print Styles */
      @media print {
        @page { margin: 0; size: auto; }
        body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .no-print { display: none !important; }
        ::-webkit-scrollbar { display: none; }
        .rotate-text-fix { transform: rotate(-90deg) !important; -webkit-transform: rotate(-90deg) !important; width: 50px; display: block; margin: 0 auto; white-space: nowrap; }
        .page-break { page-break-after: always; }
      }
      
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb { background: #c5b358; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #a08f3a; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        // ==========================================
        // 0. GLOBAL IMPORTS (UMD)
        // ==========================================
        const { HashRouter, Routes, Route, Navigate, useNavigate, useLocation } = ReactRouterDOM;
        const { useState, useEffect, useContext, createContext, Fragment, useCallback, useRef } = React;

        const APP_VERSION = "v8.24 (Fix ContractorFilesPage Error)";

        // ==========================================
        // 1. DATA CONSTANTS & TYPES
        // ==========================================
        const UserRole = {
            ADMIN: 'ADMIN',
            DEPT_MANAGER: 'DEPT_MANAGER',
            SECTION_HEAD: 'SECTION_HEAD',
            CONTRACTOR: 'CONTRACTOR',
            USER: 'USER',
            CONTRACT_MANAGER: 'CONTRACT_MANAGER'
        };

        const INITIAL_USERS = [
            { id: '70062', name: 'مصعب علي', role: UserRole.ADMIN },
            { id: '12345', name: 'عمر سعيد', role: UserRole.DEPT_MANAGER },
            { id: '00000', name: 'حسن سالم', role: UserRole.SECTION_HEAD },
            { id: '11111', name: 'حسين محمد', role: UserRole.CONTRACTOR, facilityId: '1' },
            { id: '99999', name: 'محمد عمر', role: UserRole.USER, facilityId: '1' },
            { id: '66666', name: 'إدارة العقود', role: UserRole.CONTRACT_MANAGER },
        ];

        const INITIAL_FACILITIES = [
            { id: '1', name: 'مسلخ أ', contractNumber: 'CNT-2024-001', operatingCompany: 'شركة الخدمات الحديثة', location: 'المنطقة الصناعية', phone: '0112345678', email: 'info@modern.com' },
            { id: '2', name: 'مسلخ ب', contractNumber: 'CNT-2024-002', operatingCompany: 'شركة الإبداع', location: 'حي المصانع', phone: '0223456789', email: 'contracts@ibdaa.com' },
        ];

        const INITIAL_EMPLOYEES = [
            { id: 'e1', name: 'عبد العزيز وفيق', jobTitle: 'مشرف المسلخ', salary: 4500, facilityId: '1' },
            { id: 'e2', name: 'محمد شهباز', jobTitle: 'مشرف النظافة', salary: 4500, facilityId: '1' },
            { id: 'e3', name: 'صافي الدين الضو', jobTitle: 'محاسب', salary: 3500, facilityId: '1' },
            { id: 'e4', name: 'احمد كمال', jobTitle: 'قصاب', salary: 2500, facilityId: '1' },
            { id: 'e5', name: 'سعيد خان', jobTitle: 'قصاب ', salary: 2300, facilityId: '1' },
            { id: 'e6', name: 'راجو كومار', jobTitle: 'قصاب', salary: 2300, facilityId: '1' },
            { id: 'e7', name: 'عمر', jobTitle: 'قصاب', salary: 2300, facilityId: '1' },
            { id: 'e13', name: 'مصطفي', jobTitle: 'عامل نظافة', salary: 2300, facilityId: '1' },
        ];

        const INITIAL_VIOLATION_TYPES = [
            { id: 'v1', name: 'غياب الموظف', fineAmount: 250 },
            { id: 'v2', name: 'عدم توفير التقارير الإدارية اليومية', fineAmount: 100 },
            { id: 'v5', name: 'عدم توفير معدات العمل', fineAmount: 500 },
            { id: 'v12', name: 'عدم نظافة المعدات والأدوات', fineAmount: 500 },
            { id: 'v18', name: 'أي فحص مختبري يثبت حالة إيجابية', fineAmount: 5000 },
        ];

        const INITIAL_ITEMS = [
            { id: 'i1', name: 'الحضور والانصراف', category: 'ADMIN', linkedViolationId: 'v1', points: 5 },
            { id: 'i2', name: 'التقارير الإدارية اليومية', category: 'ADMIN', linkedViolationId: 'v2', points: 5 },
            { id: 'i5', name: 'توفير معدات العمل', category: 'OPERATIONAL', linkedViolationId: 'v5', points: 10 },
            { id: 'i12', name: 'نظافة المعدات والأدوات', category: 'HYGIENE', linkedViolationId: 'v12', points: 10 },
            { id: 'i18', name: 'فحص المختبري', category: 'LAB', linkedViolationId: 'v18', points: 20 },
        ];

        // ==========================================
        // 2. UTILITY FUNCTIONS
        // ==========================================
        const numberToArabicWords = (num) => {
            const units = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة'];
            const tens = ['', 'عشرة', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
            const scales = ['', 'ألف', 'مليون', 'مليار'];
            
            if (num === 0) return 'صفر';
            
            let words = '';
            let scaleIndex = 0;
            
            while (num > 0) {
                const chunk = num % 1000;
                if (chunk !== 0) {
                    let chunkWords = '';
                    
                    const hundreds = Math.floor(chunk / 100);
                    const tensUnits = chunk % 100;
                    
                    if (hundreds > 0) {
                        if (hundreds === 1) {
                            chunkWords += 'مائة';
                        } else if (hundreds === 2) {
                            chunkWords += 'مئتان';
                        } else {
                            chunkWords += units[hundreds] + 'مائة';
                        }
                        
                        if (tensUnits > 0) {
                            chunkWords += ' و';
                        }
                    }
                    
                    if (tensUnits > 0) {
                        if (tensUnits < 10) {
                            chunkWords += units[tensUnits];
                        } else if (tensUnits < 20) {
                            const unit = tensUnits % 10;
                            if (unit === 0) {
                                chunkWords += 'عشرة';
                            } else if (unit === 1) {
                                chunkWords += 'أحد عشر';
                            } else if (unit === 2) {
                                chunkWords += 'اثنا عشر';
                            } else {
                                chunkWords += units[unit] + ' عشر';
                            }
                        } else {
                            const ten = Math.floor(tensUnits / 10);
                            const unit = tensUnits % 10;
                            
                            if (unit === 0) {
                                chunkWords += tens[ten];
                            } else {
                                chunkWords += units[unit] + ' و' + tens[ten];
                            }
                        }
                    }
                    
                    if (scaleIndex > 0) {
                        if (chunk === 1) {
                            chunkWords = scales[scaleIndex];
                        } else if (chunk === 2) {
                            chunkWords = 'ألفان';
                        } else if (chunk < 11) {
                            chunkWords += ' ' + scales[scaleIndex];
                        } else {
                            chunkWords += ' ' + scales[scaleIndex];
                        }
                    }
                    
                    if (words) {
                        words = chunkWords + ' و' + words;
                    } else {
                        words = chunkWords;
                    }
                }
                
                num = Math.floor(num / 1000);
                scaleIndex++;
            }
            
            return words + ' درهماً لاغير';
        };

        // ==========================================
        // 3. DATA SERVICE & INDEXEDDB
        // ==========================================
        const getStorage = (key, defaultVal) => {
            const stored = localStorage.getItem(key);
            if (!stored) return defaultVal;
            try { return JSON.parse(stored); } catch { return defaultVal; }
        };

        const setStorage = (key, val) => {
            localStorage.setItem(key, JSON.stringify(val));
            window.dispatchEvent(new Event('storage-update')); 
        };

        // IndexedDB Configuration
        const DB_NAME = 'KPI_System_DB';
        const STORE_NAME = 'files';

        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        };

        const FileService = {
            saveFile: async (file) => {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.put(file);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            getFiles: async (facilityId, month) => {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();
                    request.onsuccess = () => {
                        const all = request.result;
                        const filtered = all.filter(f => f.facilityId === facilityId && f.month === month);
                        resolve(filtered);
                    };
                    request.onerror = () => reject(request.error);
                });
            },
            deleteFile: async (id) => {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        };

        const DataService = {
            users: { getAll: () => getStorage('users', INITIAL_USERS), save: (v) => setStorage('users', v) },
            facilities: { getAll: () => getStorage('facilities', INITIAL_FACILITIES), save: (v) => setStorage('facilities', v) },
            employees: { getAll: () => getStorage('employees', INITIAL_EMPLOYEES), save: (v) => setStorage('employees', v) },
            items: { getAll: () => getStorage('items', INITIAL_ITEMS), save: (v) => setStorage('items', v) },
            violationTypes: { getAll: () => getStorage('violationTypes', INITIAL_VIOLATION_TYPES), save: (v) => setStorage('violationTypes', v) },
            violations: { getAll: () => getStorage('violations', []), save: (v) => setStorage('violations', v) },
            evaluations: { 
                getAll: () => getStorage('evaluations', []), 
                save: (v) => setStorage('evaluations', v),
                add: (entry) => {
                    const list = getStorage('evaluations', []);
                    const existingIdx = list.findIndex(e => e.date === entry.date && e.facilityId === entry.facilityId);
                    if (existingIdx >= 0) list[existingIdx] = entry; else list.push(entry);
                    setStorage('evaluations', list);
                }
            },
            invoices: { getAll: () => getStorage('invoices', []), save: (v) => setStorage('invoices', v) },
            extraLabor: { getAll: () => getStorage('extraLabor', []), save: (v) => setStorage('extraLabor', v) },
            monthlyReports: { getAll: () => getStorage('monthlyReports', []), save: (v) => setStorage('monthlyReports', v) },
            kpiReports: { getAll: () => getStorage('kpiReports', []), save: (v) => setStorage('kpiReports', v) },
            settings: { get: () => getStorage('appSettings', {}), save: (v) => setStorage('appSettings', v) },
            notifications: {
                getAll: () => getStorage('notifications', []),
                save: (v) => setStorage('notifications', v),
                add: (n) => {
                    const list = getStorage('notifications', []);
                    list.push({ 
                        ...n, 
                        id: Date.now().toString(), 
                        date: new Date().toISOString(), 
                        read: false,
                        timestamp: Date.now()
                    });
                    setStorage('notifications', list);
                },
                markAsRead: (userId) => {
                    const list = getStorage('notifications', []);
                    const updated = list.map(n => 
                        n.toUserId === userId && !n.read ? { ...n, read: true } : n
                    );
                    setStorage('notifications', updated);
                },
                markAllAsRead: () => {
                    const list = getStorage('notifications', []);
                    const updated = list.map(n => ({ ...n, read: true }));
                    setStorage('notifications', updated);
                }
            }
        };

        // ==========================================
        // 4. COMMON COMPONENTS (TOAST & NOTIFICATIONS)
        // ==========================================
        const ToastContext = createContext(null);
        const useToast = () => useContext(ToastContext);

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
            return (
                <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-white text-black border-2 border-gold px-6 py-3 rounded-lg shadow-2xl z-[9999] flex items-center gap-2 animate-bounce">
                    <i className={`fa ${type === 'success' ? 'fa-check-circle text-green-600' : 'fa-info-circle text-gold'} text-xl`}></i>
                    <span className="font-bold text-black">{message}</span>
                </div>
            );
        };

        const ToastProvider = ({ children }) => {
            const [toast, setToast] = useState(null);
            const showToast = (msg, type = 'success') => setToast({ message: msg, type });
            return (
                <ToastContext.Provider value={{ showToast }}>
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    {children}
                </ToastContext.Provider>
            );
        };

        // ==========================================
        // 5. AUTH & LAYOUT COMPONENTS
        // ==========================================
        const Login = ({ onLogin }) => {
            const [id, setId] = useState('');
            const [error, setError] = useState('');
            const settings = DataService.settings.get();
            const handleLogin = (e) => {
                e.preventDefault();
                const u = DataService.users.getAll().find(u => u.id === id);
                if(u) onLogin(u); else setError('الرمز الوظيفي غير صحيح');
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 relative">
                     {settings.logo && <div className="absolute inset-0 bg-cover bg-center opacity-10" style={{backgroundImage: `url(${settings.logo})`}}></div>}
                    <div className="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md z-10 text-center border-t-4 border-gold">
                        <h2 className="text-3xl font-bold mb-6 text-gray-800">تسجيل الدخول</h2>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <input value={id} onChange={e => setId(e.target.value)} className="w-full px-4 py-3 border rounded text-center text-xl tracking-widest focus:ring-2 focus:ring-gold outline-none" placeholder="الرمز الوظيفي" autoFocus />
                            {error && <p className="text-red-500 text-sm font-bold">{error}</p>}
                            <button className="w-full bg-gold hover:bg-gold-dark text-white font-bold py-3 px-4 rounded transition-colors shadow-lg">دخول</button>
                        </form>
                    </div>
                </div>
            );
        };

        // Notification Component
        const NotificationBell = ({ currentUser }) => {
            const [notifications, setNotifications] = useState([]);
            const [showDropdown, setShowDropdown] = useState(false);
            
            const loadNotifications = () => {
                const all = DataService.notifications.getAll();
                const userNotifs = all.filter(n => 
                    (n.toUserId === currentUser.id || n.toRole === currentUser.role) && !n.read
                );
                setNotifications(userNotifs);
            };
            
            useEffect(() => {
                loadNotifications();
                window.addEventListener('storage-update', loadNotifications);
                return () => window.removeEventListener('storage-update', loadNotifications);
            }, [currentUser]);
            
            const handleNotificationClick = (notification) => {
                if (notification.type === 'FILE_UPLOADED') {
                    window.location.hash = '#/archive';
                } else if (notification.type === 'INVOICE_SUBMITTED') {
                    window.location.hash = '#/invoice';
                } else if (notification.type === 'EVALUATION_SUBMITTED') {
                    window.location.hash = '#/daily-evaluation';
                } else if (notification.type === 'REPORT_SUBMITTED') {
                    window.location.hash = '#/monthly-report';
                } else if (notification.type === 'KPI_SUBMITTED') {
                    window.location.hash = '#/kpi';
                }
                DataService.notifications.markAsRead(currentUser.id);
                setShowDropdown(false);
            };
            
            const handleMarkAllRead = () => {
                DataService.notifications.markAllAsRead();
                setShowDropdown(false);
            };
            
            return (
                <div className="relative">
                    <button 
                        onClick={() => setShowDropdown(!showDropdown)}
                        className="relative p-2 rounded-full hover:bg-white/20 transition-colors"
                    >
                        <i className="fa fa-bell text-xl"></i>
                        {notifications.length > 0 && (
                            <span className="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center animate-pulse">
                                {notifications.length}
                            </span>
                        )}
                    </button>
                    
                    {showDropdown && (
                        <div className="absolute left-0 mt-2 w-96 bg-white rounded-lg shadow-xl z-50 border border-gray-200">
                            <div className="p-4 border-b flex justify-between items-center">
                                <h3 className="font-bold text-black">الإشعارات</h3>
                                {notifications.length > 0 && (
                                    <button 
                                        onClick={handleMarkAllRead}
                                        className="text-sm text-blue-600 hover:text-blue-800"
                                    >
                                        تحديد الكل كمقروء
                                    </button>
                                )}
                            </div>
                            <div className="max-h-96 overflow-y-auto">
                                {notifications.length === 0 ? (
                                    <div className="p-4 text-center text-gray-500">
                                        لا توجد إشعارات جديدة
                                    </div>
                                ) : (
                                    notifications.map(n => (
                                        <div 
                                            key={n.id}
                                            onClick={() => handleNotificationClick(n)}
                                            className="p-4 border-b hover:bg-gray-50 cursor-pointer transition-colors"
                                        >
                                            <div className="flex items-start">
                                                <i className={`fa ${
                                                    n.type === 'FILE_UPLOADED' ? 'fa-file-upload text-blue-500' :
                                                    n.type.includes('INVOICE') ? 'fa-file-invoice-dollar text-green-500' :
                                                    n.type.includes('EVALUATION') ? 'fa-calendar-check text-purple-500' :
                                                    n.type.includes('REPORT') ? 'fa-file-alt text-orange-500' :
                                                    n.type.includes('KPI') ? 'fa-chart-pie text-teal-500' :
                                                    'fa-bell text-gold'
                                                } mt-1 ml-3`}></i>
                                                <div className="flex-1">
                                                    <p className="font-semibold text-sm text-black">{n.message}</p>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        {new Date(n.date).toLocaleString('ar-AE')}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Layout = ({ children, currentUser, onLogout }) => {
            const navigate = useNavigate();
            const location = useLocation();
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [time, setTime] = useState(new Date());
            const [notificationBadge, setNotificationBadge] = useState(0);
            const settings = DataService.settings.get();

            useEffect(() => { const t = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(t); }, []);

            // Check Notifications
            useEffect(() => {
                const checkNotifications = () => {
                    const all = DataService.notifications.getAll();
                    const userNotifs = all.filter(n => 
                        (n.toUserId === currentUser.id || n.toRole === currentUser.role) && !n.read
                    );
                    setNotificationBadge(userNotifs.length);
                };
                checkNotifications();
                window.addEventListener('storage-update', checkNotifications);
                return () => window.removeEventListener('storage-update', checkNotifications);
            }, [currentUser]);

            const menu = [
                { label: 'التقييم اليومي', path: '/daily-evaluation', icon: 'fa-calendar-check', roles: [UserRole.ADMIN, UserRole.USER] },
                { label: 'المخالفات', path: '/violations', icon: 'fa-exclamation-triangle', roles: [UserRole.ADMIN, UserRole.USER, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD, UserRole.CONTRACTOR, UserRole.CONTRACT_MANAGER] },
                { label: 'التقييم الشهري', path: '/monthly-evaluation', icon: 'fa-table', roles: [UserRole.ADMIN, UserRole.USER, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD, UserRole.CONTRACTOR, UserRole.CONTRACT_MANAGER] },
                { label: 'التقرير الشهري', path: '/monthly-report', icon: 'fa-file-text', roles: [UserRole.ADMIN, UserRole.USER, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD, UserRole.CONTRACTOR, UserRole.CONTRACT_MANAGER] },
                { label: 'مؤشر الأداء', path: '/kpi', icon: 'fa-chart-pie', roles: [UserRole.ADMIN, UserRole.USER, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD, UserRole.CONTRACTOR, UserRole.CONTRACT_MANAGER] },
                { label: 'الفاتورة الشهرية', path: '/invoice', icon: 'fa-file-invoice-dollar', roles: [UserRole.ADMIN, UserRole.USER, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD, UserRole.CONTRACTOR, UserRole.CONTRACT_MANAGER] },
                { label: 'ملف التقارير', path: '/contractor-files', icon: 'fa-folder-open', roles: [UserRole.ADMIN, UserRole.CONTRACTOR] },
                { label: 'أرشيف العقود', path: '/archive', icon: 'fa-archive', roles: [UserRole.ADMIN, UserRole.CONTRACT_MANAGER] },
                { label: 'العمالة الإضافية', path: '/extra-labor', icon: 'fa-users-cog', roles: [UserRole.ADMIN, UserRole.USER] },
                { label: 'الاعدادات', path: '/settings', icon: 'fa-cogs', roles: [UserRole.ADMIN] },
            ];

            const dateStr = time.toLocaleDateString('ar-AE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeStr = time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            return (
                <div className="flex h-screen bg-gray-100 overflow-hidden" dir="rtl">
                    <div className={`${isSidebarOpen ? 'w-64' : 'w-0'} bg-white shadow-lg transition-all duration-300 flex flex-col no-print z-20`}>
                        <div className="h-[150px] flex items-center justify-center border-b p-4 bg-gray-50">
                            {settings.logo ? <img src={settings.logo} className="max-h-full object-contain" alt="شعار المؤسسة" /> : <i className="fa fa-image fa-3x text-gray-400"></i>}
                        </div>
                        <div className="flex-1 overflow-y-auto py-4">
                            {menu.filter(i => !i.roles || i.roles.includes(currentUser.role)).map(i => (
                                <button 
                                    key={i.path} 
                                    onClick={() => navigate(i.path)} 
                                    className={`w-full flex items-center px-6 py-3 text-right hover:bg-gold-light hover:text-white transition-colors border-l-4 ${location.pathname === i.path ? 'bg-gold text-white border-gold-dark' : 'text-gray-700 border-transparent'}`}
                                >
                                    <i className={`fa ${i.icon} w-8 ml-2`}></i>
                                    <span className="flex-1 font-semibold">{i.label}</span>
                                </button>
                            ))}
                        </div>
                        <div className="p-4 border-t text-center bg-gray-50">
                            <div className="mb-2 text-xs font-bold text-gray-700">
                                {currentUser.name} <span className="block text-gray-500 font-normal">({currentUser.role})</span>
                            </div>
                            <div className="text-[10px] text-gray-400 mb-2">{APP_VERSION}</div>
                            <button onClick={onLogout} className="w-full bg-red-100 text-red-600 py-2 rounded hover:bg-red-200 transition-colors">
                                <i className="fa fa-sign-out-alt ml-2"></i> خروج
                            </button>
                        </div>
                    </div>
                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="h-[70px] bg-gold text-white flex items-center justify-between px-6 shadow-md no-print z-10">
                            <div className="flex items-center">
                                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="text-white hover:text-gray-100 mr-2 transition-transform active:scale-95">
                                    <i className="fa fa-bars fa-lg"></i>
                                </button>
                                <h1 className="mr-4 text-xl font-bold hidden sm:block tracking-wide">برنامج قياس مؤشرات الأداء</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex flex-col items-end text-sm font-semibold leading-tight bg-black/20 px-4 py-2 rounded-lg backdrop-blur-sm">
                                    <span className="text-xs opacity-90 mb-1">{dateStr}</span>
                                    <span className="font-mono text-lg dir-ltr">{timeStr}</span>
                                </div>
                                <NotificationBell currentUser={currentUser} />
                            </div>
                        </header>
                        <main className="flex-1 overflow-auto p-4 sm:p-6 print:p-0 print:overflow-visible bg-gray-100">
                            {children}
                        </main>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 6. PAGE COMPONENTS
        // ==========================================

        const DailyEvaluationPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [items, setItems] = useState([]);
            const [employees, setEmployees] = useState([]);
            const [scores, setScores] = useState({});
            const [submitted, setSubmitted] = useState(false);
            const [facilities, setFacilities] = useState([]);
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const [performanceIndex, setPerformanceIndex] = useState(100);
            const [unresolved, setUnresolved] = useState([]);
            const [isUpdateMode, setIsUpdateMode] = useState(false);
            const [autoFines, setAutoFines] = useState([]);
            
            const isAdmin = currentUser.role === UserRole.ADMIN;
            const canEdit = [UserRole.ADMIN, UserRole.USER].includes(currentUser.role);
            const isVeterinarian = currentUser.role === UserRole.USER || currentUser.role === UserRole.ADMIN;

            useEffect(() => {
                const refresh = () => {
                    setItems(DataService.items.getAll());
                    setFacilities(DataService.facilities.getAll());
                };
                refresh();
                window.addEventListener('storage-update', refresh);
                return () => window.removeEventListener('storage-update', refresh);
            }, []);

            useEffect(() => {
                const loadEmps = () => {
                    setEmployees(DataService.employees.getAll().filter(e => e.facilityId === selectedFacility));
                };
                loadEmps();
                window.addEventListener('storage-update', loadEmps);
                return () => window.removeEventListener('storage-update', loadEmps);
            }, [selectedFacility]);

const isApplicable = (item, emp) => {
    const t = emp.jobTitle.trim();
    
    // الحفاظ على التوافق مع البنود القديمة
    const oldItemIds = ['i1', 'i2', 'i3', 'i4', 'i5', 'i6', 'i7', 'i8', 'i9', 'i10', 'i11', 'i12', 'i13', 'i14', 'i15', 'i16', 'i17', 'i18', 'i19'];
    
    if (oldItemIds.includes(item.id)) {
        // استخدام المنطق القديم للبنود الموجودة مسبقاً
        if (['i1', 'i15', 'i16', 'i8', 'i9', 'i10'].includes(item.id)) return true;
        if (['i2', 'i3', 'i4', 'i5', 'i6', 'i7', 'i18'].includes(item.id)) return t.includes('مشرف');
        if (['i12', 'i14'].includes(item.id)) return t.includes('نظافة') || t.includes('حمال') || t.includes('مشرف');
        if (['i17', 'i11', 'i13'].includes(item.id)) return t.includes('قصاب') || t.includes('جزار');
        if (item.id === 'i19') return t.includes('محاسب');
        return false;
    }
    
    // المنطق الجديد للبنود المضافة حديثاً - يعتمد على category
    if (item.category === 'ADMIN') {
        // البنود الإدارية تنطبق على الجميع
        return true;
    }
    
    if (item.category === 'OPERATIONAL') {
        // البنود التشغيلية تنطبق على المشرفين
        return t.includes('مشرف');
    }
    
    if (item.category === 'HYGIENE') {
        // البنود الصحية تنطبق على عمال النظافة والمشرفين
        return t.includes('نظافة') || t.includes('حمال') || t.includes('مشرف');
    }
    
    if (item.category === 'PROFESSIONAL') {
        // البنود المهنية تنطبق على القصابين
        return t.includes('قصاب') || t.includes('جزار');
    }
    
    if (item.category === 'SAFETY') {
        // البنود الأمنية تنطبق على الجميع
        return true;
    }
    
    if (item.category === 'LAB') {
        // البنود المخبرية تنطبق على المشرفين
        return t.includes('مشرف');
    }
    
    // إذا لم يكن هناك تطابق، نرجع true كقيمة افتراضية
    return true;
};

            const calculatePerformanceIndex = (scoresMap) => {
                let totalPoints = 0;
                let earnedPoints = 0;
                
                employees.forEach(e => {
                    items.forEach(i => {
                        if(isApplicable(i,e)) {
                            const itemPoints = i.points || 5;
                            totalPoints += itemPoints;
                            const key = `${i.id}_${e.id}`;
                            const passed = scoresMap[key];
                            
                            if(passed === true) {
                                earnedPoints += itemPoints;
                            } else if(passed === false) {
                                earnedPoints += 0;
                            } else if(passed === undefined) {
                                earnedPoints += itemPoints;
                            }
                        }
                    });
                });
                
                return totalPoints === 0 ? 100 : Math.round((earnedPoints/totalPoints)*100);
            };

            const calculateAutoFines = (scoresMap) => {
                const fines = [];
                employees.forEach(e => {
                    items.forEach(i => {
                        if(isApplicable(i,e)) {
                            const key = `${i.id}_${e.id}`;
                            const passed = scoresMap[key];
                            
                            if(passed === false && i.linkedViolationId) {
                                const vType = DataService.violationTypes.getAll().find(v => v.id === i.linkedViolationId);
                                if(vType) {
                                    fines.push({
                                        key,
                                        item: i,
                                        emp: e,
                                        violationType: vType,
                                        amount: vType.fineAmount
                                    });
                                }
                            }
                        }
                    });
                });
                return fines;
            };

            const loadData = () => {
                const existing = DataService.evaluations.getAll().find(e => e.date === date && e.facilityId === selectedFacility);
                
                if (existing) {
                    setScores(existing.scores); 
                    setSubmitted(true);
                    setPerformanceIndex(existing.performanceIndex);
                    setIsUpdateMode(false); 
                    setAutoFines(calculateAutoFines(existing.scores));
                } else {
                    const init = {};
                    employees.forEach(e => {
                        items.forEach(i => { 
                            if(isApplicable(i,e)) {
                                init[`${i.id}_${e.id}`] = true;
                            }
                        });
                    });
                    setScores(init); 
                    setSubmitted(false); 
                    setPerformanceIndex(100);
                    setUnresolved([]);
                    setIsUpdateMode(false);
                    setAutoFines([]);
                }
            };

            useEffect(() => {
               if(employees.length > 0) loadData();
               window.addEventListener('storage-update', loadData);
               return () => window.removeEventListener('storage-update', loadData);
            }, [date, selectedFacility, employees]);

            const handleCheck = (iId, eId) => {
                if(submitted) return; 

                const k = `${iId}_${eId}`;
                const newScores = {...scores, [k]: !scores[k]};
                setScores(newScores);
                
                const newIndex = calculatePerformanceIndex(newScores);
                setPerformanceIndex(newIndex);
                
                const fines = calculateAutoFines(newScores);
                setAutoFines(fines);
            };

            const handleEdit = () => {
                if(!canEdit) return;
                setSubmitted(false);
                setIsUpdateMode(true);
                showToast('تم فتح التعديل. عند الانتهاء اضغط على تحديث واعتماد.');
            };

            const handleSubmit = () => {
                const finalIndex = calculatePerformanceIndex(scores);
                
                let currentViolations = DataService.violations.getAll();
                let updatedViolations = [...currentViolations];

                const requiredFines = calculateAutoFines(scores);

                requiredFines.forEach(fine => {
                    const exists = updatedViolations.some(v => 
                        v.date === date && 
                        v.facilityId === selectedFacility &&
                        v.violationTypeId === fine.violationType.id &&
                        v.violationName.includes(fine.emp.name)
                    );

                    if (!exists) {
                        updatedViolations.push({
                            id: Date.now().toString() + Math.random(),
                            date, 
                            violationTypeId: fine.violationType.id, 
                            violationName: `${fine.violationType.name} - ${fine.emp.name}`, 
                            amount: fine.violationType.fineAmount, 
                            total: fine.violationType.fineAmount, 
                            enteredBy: currentUser.name, 
                            status: 'OPEN', 
                            facilityId: selectedFacility,
                            isAuto: true 
                        });
                    }
                });

                employees.forEach(e => {
                    items.forEach(i => {
                        const isChecked = scores[`${i.id}_${e.id}`];
                        if (isChecked === true || (isChecked === false && !i.linkedViolationId)) {
                             if (i.linkedViolationId) {
                                 updatedViolations = updatedViolations.filter(v => 
                                     !(v.date === date && 
                                       v.facilityId === selectedFacility && 
                                       v.violationTypeId === i.linkedViolationId && 
                                       v.violationName.includes(e.name))
                                 );
                             }
                        }
                    });
                });

                DataService.violations.save(updatedViolations);

                const entry = { 
                    id: Date.now().toString(), 
                    date, 
                    facilityId: selectedFacility, 
                    scores, 
                    submitted: true, 
                    performanceIndex: finalIndex,
                    enteredBy: currentUser.name,
                    enteredDate: new Date().toISOString(),
                    locked: true 
                };
                
                DataService.evaluations.add(entry);
                setSubmitted(true);
                setIsUpdateMode(false);
                setPerformanceIndex(finalIndex);
                
                if (isVeterinarian) {
                    DataService.notifications.add({
                        toUserId: DataService.users.getAll().find(u => u.role === UserRole.CONTRACTOR && u.facilityId === selectedFacility)?.id,
                        message: `تم ${isUpdateMode ? 'تحديث' : 'تقديم'} التقييم اليومي ${date} - المؤشر: ${finalIndex}%`,
                        facilityId: selectedFacility,
                        type: 'EVALUATION_SUBMITTED'
                    });
                }
                
                showToast(`تم الحفظ بنجاح. تم تسجيل/تحديث ${requiredFines.length} مخالفات تلقائية.`);
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex justify-between items-center">
                        <h2 className="text-xl font-bold">التقييم اليومي: {facilities.find(f=>f.id===selectedFacility)?.name}</h2>
                        <div className="flex gap-2">
                             {isAdmin && (
                                 <select value={selectedFacility} onChange={e=>setSelectedFacility(e.target.value)} className="border p-1 rounded">
                                     {facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                 </select>
                             )}
                             <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="border p-1 rounded"/>
                        </div>
                    </div>
                    
                    <div className="bg-white p-4 rounded shadow overflow-x-auto">
                        <table className="w-full text-sm text-center border-collapse">
                            <thead>
                                <tr>
                                    <th className="p-2 border bg-gray-50 sticky right-0 z-10">البند</th>
                                    {employees.map(e=>(
                                        <th key={e.id} className="p-2 border bg-gray-50 min-w-[100px]">
                                            {e.name}<br/>
                                            <span className="text-xs text-gray-500">{e.jobTitle}</span>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {items.map(i=>(
                                    <tr key={i.id}>
                                        <td className="p-2 border font-bold text-right sticky right-0 bg-white z-10">{i.name}</td>
                                        {employees.map(e=>{
                                            const app = isApplicable(i,e);
                                            return (
                                                <td key={e.id} className={`border p-2 ${!app?'bg-gray-100':''}`}>
                                                    {app ? (
                                                        <input 
                                                            type="checkbox" 
                                                            checked={scores[`${i.id}_${e.id}`] || false}
                                                            onChange={()=>handleCheck(i.id,e.id)} 
                                                            disabled={submitted} 
                                                            className="w-5 h-5 accent-gold cursor-pointer disabled:cursor-not-allowed"
                                                        />
                                                    ) : '-'}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    <div className="bg-white p-4 rounded shadow">
                        <div className="flex justify-between items-center">
                            <h3 className={`font-bold text-xl ${performanceIndex<80?'text-red-500':'text-green-500'}`}>
                                مؤشر الأداء اليومي: {performanceIndex}%
                            </h3>
                            {canEdit && (
                                <div className="flex gap-2">
                                    {!submitted ? (
                                        <button 
                                            onClick={handleSubmit} 
                                            className="px-6 py-2 rounded text-white font-bold bg-gold hover:bg-gold-dark shadow-lg transition-transform active:scale-95"
                                        >
                                            {isUpdateMode ? 'تحديث واعتماد' : 'اعتماد التقييم'}
                                        </button>
                                    ) : (
                                        <button 
                                            onClick={handleEdit} 
                                            className="px-6 py-2 rounded text-white font-bold bg-blue-600 hover:bg-blue-700 shadow-lg transition-transform active:scale-95"
                                        >
                                            <i className="fa fa-edit ml-2"></i> تعديل التقييم
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                        
                        {autoFines.length > 0 && (
                            <div className="mt-4 border-t pt-4">
                                <h4 className="text-orange-600 font-bold mb-2">
                                    <i className="fa fa-exclamation-triangle ml-2"></i>
                                    المخالفات المرتبطة ({autoFines.length})
                                </h4>
                                <div className="bg-orange-50 p-3 rounded border border-orange-200">
                                    <ul className="text-sm space-y-1">
                                        {autoFines.map((fine, idx) => (
                                            <li key={idx} className="flex justify-between">
                                                <span>{fine.item.name} - {fine.emp.name}</span>
                                                <span className="font-bold text-red-600">{fine.amount} درهم</span>
                                            </li>
                                        ))}
                                    </ul>
                                    <div className="mt-2 text-xs text-gray-600 border-t border-orange-200 pt-2 font-bold">
                                        الإجمالي: {autoFines.reduce((acc, curr) => acc + curr.amount, 0)} درهم 
                                        {submitted ? ' (تم التسجيل والخصم من الفاتورة)' : ' (سيتم التسجيل تلقائياً عند الاعتماد)'}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {submitted && (
                            <div className="mt-4">
                                <div className="bg-green-50 border border-green-200 p-3 rounded flex items-center">
                                    <i className="fa fa-lock text-green-600 text-xl ml-2"></i>
                                    <div>
                                        <h4 className="font-bold text-green-700">التقييم معتمد ومغلق</h4>
                                        <p className="text-sm text-green-600">
                                            تم حفظ البيانات. المؤشر الحالي {performanceIndex}%. لا يعود المؤشر إلى 100% إلا عند معالجة أسباب المخالفة وتعديل التقييم.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ViolationsPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [violations, setViolations] = useState([]);
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [facilities, setFacilities] = useState([]);
            const canViewAll = [UserRole.ADMIN, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD, UserRole.CONTRACT_MANAGER].includes(currentUser.role);
            const canEdit = [UserRole.ADMIN, UserRole.USER].includes(currentUser.role);

            const loadData = () => {
                const allFacs = DataService.facilities.getAll();
                if(canViewAll) { 
                    setFacilities(allFacs); 
                } else { 
                    setFacilities(allFacs.filter(f=>f.id===currentUser.facilityId)); 
                    if(currentUser.facilityId) setSelectedFacility(currentUser.facilityId); 
                }
                
                let v = DataService.violations.getAll().filter(v => v.facilityId===selectedFacility);
                if(month) v = v.filter(i=>i.date.startsWith(month));
                setViolations(v);
            };

            useEffect(() => {
                loadData();
                window.addEventListener('storage-update', loadData);
                return () => window.removeEventListener('storage-update', loadData);
            }, [month, selectedFacility, currentUser, canViewAll]);

            const updateV = (id, status) => {
                const all = DataService.violations.getAll().map(v => v.id===id?{...v,status}:v);
                DataService.violations.save(all);
                showToast('تم التحديث');
            };

            const deleteV = (id) => {
                if(!confirm('حذف المخالفة نهائياً؟')) return;
                const all = DataService.violations.getAll().filter(v => v.id!==id);
                DataService.violations.save(all);
                showToast('تم الحذف');
                loadData();
            };

            const handleImageUpload = (id, e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.size > 10 * 1024 * 1024) {
                    alert('حجم الصورة كبير جداً. الحد الأقصى 10 ميجابايت.');
                    return;
                }

                const reader = new FileReader();
                reader.onloadend = () => {
                    const all = DataService.violations.getAll();
                    const idx = all.findIndex(v => v.id === id);
                    if (idx !== -1) {
                        all[idx].evidenceImage = reader.result;
                        DataService.violations.save(all);
                        showToast('تم رفع صورة المخالفة');
                        loadData();
                    }
                };
                reader.readAsDataURL(file);
            };

            const handleDeleteImage = (id) => {
                if (!confirm('هل أنت متأكد من حذف صورة الإثبات؟')) return;
                const all = DataService.violations.getAll();
                const idx = all.findIndex(v => v.id === id);
                if (idx !== -1) {
                    delete all[idx].evidenceImage;
                    DataService.violations.save(all);
                    showToast('تم حذف الصورة');
                    loadData();
                }
            };

            const viewImage = (dataUrl) => {
                const win = window.open();
                if (win) {
                    win.document.write(`
                        <html>
                            <head><title>إثبات المخالفة</title></head>
                            <body style="margin:0;padding:0;display:flex;justify-content:center;align-items:center;height:100vh;background:#f0f0f0;">
                                <img src="${dataUrl}" style="max-width:100%; max-height:100%; box-shadow: 0 0 20px rgba(0,0,0,0.5);" />
                            </body>
                        </html>
                    `);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex justify-between items-center no-print">
                        <h2 className="text-xl font-bold">سجل المخالفات</h2>
                        <div className="flex gap-2">
                            {canViewAll ? (
                                <select value={selectedFacility} onChange={e=>setSelectedFacility(e.target.value)} className="border p-2 rounded">
                                    {facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                </select>
                            ) : (
                                <span className="font-bold px-3">{facilities.find(f=>f.id===selectedFacility)?.name}</span>
                            )}
                            <input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border p-2 rounded"/>
                            <button onClick={()=>window.print()} className="bg-blue-600 text-white px-3 rounded">طباعة</button>
                        </div>
                    </div>
                    
                    <div id="violation-report" className="bg-white p-4 rounded shadow">
                        <table className="w-full text-sm text-right border-collapse">
                            <thead>
                                <tr className="bg-gold text-white">
                                    <th className="p-3 border">م</th>
                                    <th className="p-3 border">التاريخ</th>
                                    <th className="p-3 border">المخالفة</th>
                                    <th className="p-3 border">القيمة</th>
                                    <th className="p-3 border">الحالة</th>
                                    <th className="p-3 border text-center no-print">الإثبات</th>
                                    <th className="p-3 border">الطبيب المناوب</th>
                                    <th className="p-3 border no-print"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {violations.map((v, i) => (
                                    <tr key={v.id} className="border-b">
                                        <td className="p-3 border">{i+1}</td>
                                        <td className="p-3 border">{v.date}</td>
                                        <td className="p-3 border">{v.violationName}</td>
                                        <td className="p-3 border">{v.amount}</td>
                                        <td className="p-3 border">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${v.status==='OPEN'?'bg-red-100 text-red-800':'bg-green-100 text-green-800'}`}>
                                                {v.status === 'OPEN' ? 'مفتوحة' : 'مغلقة'}
                                            </span>
                                        </td>
                                        <td className="p-3 border text-center no-print">
                                            {v.evidenceImage ? (
                                                <div className="flex justify-center items-center gap-2">
                                                    <button 
                                                        onClick={() => viewImage(v.evidenceImage)} 
                                                        className="bg-blue-100 text-blue-600 hover:bg-blue-200 p-2 rounded-full transition-colors"
                                                        title="معاينة الصورة"
                                                    >
                                                        <i className="fa fa-eye"></i>
                                                    </button>
                                                    {canEdit && (
                                                        <button 
                                                            onClick={() => handleDeleteImage(v.id)} 
                                                            className="bg-red-100 text-red-600 hover:bg-red-200 p-2 rounded-full transition-colors"
                                                            title="حذف الصورة"
                                                        >
                                                            <i className="fa fa-trash-alt"></i>
                                                        </button>
                                                    )}
                                                </div>
                                            ) : (
                                                canEdit && (
                                                    <label className="cursor-pointer inline-flex flex-col items-center justify-center text-gray-400 hover:text-gold transition-colors">
                                                        <i className="fa fa-camera text-xl mb-1"></i>
                                                        <span className="text-[10px]">رفع صورة</span>
                                                        <input 
                                                            type="file" 
                                                            accept="image/*" 
                                                            className="hidden" 
                                                            onChange={(e) => handleImageUpload(v.id, e)} 
                                                        />
                                                    </label>
                                                )
                                            )}
                                        </td>
                                        <td className="p-3 border text-blue-800 font-semibold">{v.enteredBy}</td>
                                        <td className="p-3 border no-print">
                                            {canEdit && (
                                                <div className="flex gap-1 justify-end">
                                                    {v.status === 'OPEN' && (
                                                        <button onClick={()=>updateV(v.id,'CLOSED')} className="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                                            إغلاق
                                                        </button>
                                                    )}
                                                    <button onClick={()=>deleteV(v.id)} className="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                                        حذف
                                                    </button>
                                                </div>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                                {violations.length === 0 && (
                                    <tr>
                                        <td colSpan={8} className="p-4 text-center text-gray-500">
                                            لا توجد مخالفات لهذا الشهر
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const MonthlyReportPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const [facilities, setFacilities] = useState([]);
            const [report, setReport] = useState(null);
            const [stats, setStats] = useState({});
            const [signatures, setSignatures] = useState({
                enteredBy: '',
                enteredDate: '',
                contractor: '',
                contractorDate: '',
                sectionHead: '',
                sectionHeadDate: ''
            });
            
            const canViewAll = [UserRole.ADMIN, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD, UserRole.CONTRACT_MANAGER].includes(currentUser.role);
            const canSubmit = [UserRole.ADMIN, UserRole.USER].includes(currentUser.role);
            const canSectionHead = [UserRole.ADMIN, UserRole.SECTION_HEAD].includes(currentUser.role);
            const canContractor = [UserRole.ADMIN, UserRole.CONTRACTOR].includes(currentUser.role);

            const loadData = () => {
                const allFacs = DataService.facilities.getAll();
                if(canViewAll) { 
                    setFacilities(allFacs); 
                } else { 
                    setFacilities(allFacs.filter(f=>f.id===currentUser.facilityId)); 
                    if(currentUser.facilityId) setSelectedFacility(currentUser.facilityId); 
                }

                const r = DataService.monthlyReports.getAll().find(r => r.month === month && r.facilityId === selectedFacility);
                setReport(r || null);
                
                if (r?.signatures) {
                    setSignatures(r.signatures);
                }
                
                const evals = DataService.evaluations.getAll().filter(e => e.date.startsWith(month) && e.facilityId === selectedFacility);
                const viols = DataService.violations.getAll().filter(v => v.date.startsWith(month) && v.facilityId === selectedFacility);
                const emps = DataService.employees.getAll().filter(e => e.facilityId === selectedFacility);
                
                let supAbs = 0, workAbs = 0;
                evals.forEach(ev => {
                    emps.forEach(e => { 
                        if(ev.scores[`i1_${e.id}`]===false) { 
                            if(e.jobTitle.includes('مشرف')) supAbs++; 
                            else workAbs++; 
                        } 
                    });
                });
                
                setStats({
                    supAbs, 
                    workAbs,
                    safety: viols.filter(v=>['v5','v6','v7','v8','v9','v10','v11','v15','v16'].includes(v.violationTypeId)).length,
                    hygiene: viols.filter(v=>['v12','v13','v14','v17'].includes(v.violationTypeId)).length,
                    lab: viols.filter(v=>v.violationTypeId==='v18').length
                });
            };

            useEffect(() => {
                loadData();
                window.addEventListener('storage-update', loadData);
                return () => window.removeEventListener('storage-update', loadData);
            }, [month, selectedFacility, currentUser]);

            const handleAction = (action) => {
                const rec = report || { 
                    id: `${month}-${selectedFacility}`, 
                    month, 
                    facilityId: selectedFacility, 
                    signatures: {},
                    status: 'PENDING'
                };
                
                const today = new Date().toLocaleDateString('en-GB');
                
                if(action === 'SUBMIT') { 
                    rec.submitted = true; 
                    rec.status = 'SUBMITTED';
                    rec.signatures = {
                        ...signatures,
                        enteredBy: currentUser.name,
                        enteredDate: today
                    };
                    
                    const contractor = DataService.users.getAll().find(u => 
                        u.role === UserRole.CONTRACTOR && u.facilityId === selectedFacility
                    );
                    if (contractor) {
                        DataService.notifications.add({
                            toUserId: contractor.id,
                            message: `تم تقديم التقرير الشهري ${month} للمراجعة`,
                            facilityId: selectedFacility,
                            type: 'REPORT_SUBMITTED'
                        });
                    }
                }
                
                if(action === 'SECTION_HEAD') { 
                    rec.approvedBySectionHead = true; 
                    rec.status = 'SECTION_HEAD_APPROVED';
                    rec.signatures = {
                        ...signatures,
                        sectionHead: currentUser.name,
                        sectionHeadDate: today
                    };
                    
                    const deptManager = DataService.users.getAll().find(u => u.role === UserRole.DEPT_MANAGER);
                    if (deptManager) {
                        DataService.notifications.add({
                            toUserId: deptManager.id,
                            message: `تم اعتماد التقرير الشهري ${month} من رئيس الشعبة`,
                            facilityId: selectedFacility,
                            type: 'REPORT_APPROVED'
                        });
                    }

                    const vet = DataService.users.getAll().find(u => u.role === UserRole.USER && u.facilityId === selectedFacility);
                    if (vet) {
                        DataService.notifications.add({
                            toUserId: vet.id,
                            message: `تم اعتماد التقرير الشهري ${month} من رئيس الشعبة`,
                            facilityId: selectedFacility,
                            type: 'REPORT_APPROVED'
                        });
                    }
                }
                
                if(action === 'CONTRACTOR') { 
                    rec.approvedByContractor = true; 
                    rec.status = 'CONTRACTOR_APPROVED';
                    rec.signatures = {
                        ...signatures,
                        contractor: currentUser.name,
                        contractorDate: today
                    };
                }
                
                DataService.monthlyReports.save([...DataService.monthlyReports.getAll().filter(r=>r.id!==rec.id), rec]);
                setReport(rec);
                showToast('تم الحفظ');
            };

            const handleExport = () => {
                const el = document.getElementById('monthly-report-print');
                if(el && window.html2pdf) {
                    window.html2pdf().from(el).set({ 
                        margin: 0, 
                        filename: `Report-${month}.pdf`, 
                        image: { type: 'jpeg', quality: 0.98 }, 
                        html2canvas: { scale: 2, useCORS: true }, 
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
                    }).save();
                } else {
                    window.print();
                }
            };

            const fac = facilities.find(f => f.id === selectedFacility);

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex justify-between items-center no-print">
                        <h2 className="text-xl font-bold">التقرير الشهري</h2>
                        <div className="flex gap-2">
                            {canViewAll ? (
                                <select value={selectedFacility} onChange={e=>setSelectedFacility(e.target.value)} className="border p-2 rounded">
                                    {facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                </select>
                            ) : (
                                <span className="font-bold px-3">{fac?.name}</span>
                            )}
                            <input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border p-2 rounded"/>
                            
                            {canSubmit && (!report?.submitted) && (
                                <button onClick={()=>handleAction('SUBMIT')} className="bg-green-600 text-white px-4 rounded font-bold shadow">
                                    تقديم
                                </button>
                            )}
                            
                            {canSectionHead && report?.submitted && !report?.approvedBySectionHead && (
                                <button onClick={()=>handleAction('SECTION_HEAD')} className="bg-gold text-white px-4 rounded font-bold shadow">
                                    اعتماد رئيس الشعبة
                                </button>
                            )}
                            
                            {canContractor && report?.submitted && !report?.approvedByContractor && (
                                <button onClick={()=>handleAction('CONTRACTOR')} className="bg-purple-600 text-white px-4 rounded font-bold shadow">
                                    اعتماد المقاول
                                </button>
                            )}
                            
                            <button onClick={handleExport} className="bg-blue-600 text-white px-4 rounded">
                                <i className="fa fa-print"></i> PDF
                            </button>
                        </div>
                    </div>
                    
                    <div id="monthly-report-print" className="bg-white mx-auto w-full max-w-[210mm] min-h-[297mm] p-4 text-xs font-sans text-black flex flex-col relative shadow-lg">
                        <div className="flex justify-between items-stretch mb-1 border-2 border-[#b8860b] h-20 bg-[#c5b358]">
                            <div className="w-1/4 flex items-center justify-center p-2"></div>
                            <div className="w-1/2 flex flex-col items-center justify-center text-black font-bold">
                                <h1 className="text-xl mb-1">إدارة الصحة العامة</h1>
                                <h2 className="text-lg">مسلخ {fac?.name}</h2>
                            </div>
                            <div className="w-1/4 flex items-center justify-center p-2 border-r-2 border-[#b8860b]">
                                {DataService.settings.get().logo ? (
                                    <img src={DataService.settings.get().logo} className="max-h-16 mix-blend-multiply" alt="شعار المؤسسة" />
                                ) : 'LOGO'}
                            </div>
                        </div>
                        
                        <div className="bg-[#8b4513] text-white text-center font-bold py-1 border-2 border-[#8b4513] mb-1">
                            التقرير الشهري عن متعهد المسلخ
                        </div>
                        
                        <div className="bg-[#d2691e] text-white text-center font-bold py-1 border-2 border-[#d2691e] mb-4">
                            عقد رقم ({fac?.contractNumber})
                        </div>
                        
                        <div className="border-2 border-[#c5b358] mb-4">
                            <div className="bg-[#c5b358] text-right font-bold p-1 border-b border-[#c5b358]">البيانات</div>
                            <div className="flex border-b border-gray-400">
                                <div className="w-1/4 bg-gray-50 p-1 border-l border-gray-400 font-bold">الشهر</div>
                                <div className="w-3/4 p-1">{month}</div>
                            </div>
                            <div className="flex border-b border-gray-400">
                                <div className="w-1/4 bg-gray-50 p-1 border-l border-gray-400 font-bold">المشغل</div>
                                <div className="w-3/4 p-1">{fac?.operatingCompany}</div>
                            </div>
                        </div>
                        
                        <div className="border-2 border-[#c5b358] flex-1 flex flex-col">
                            <div className="bg-[#c5b358] text-right font-bold p-1 border-b border-black">مخالفات العقد</div>
                            <div className="flex bg-gray-100 font-bold text-center border-b border-black">
                                <div className="w-1/3 p-1 border-l border-black">نوع المخالفة</div>
                                <div className="w-1/6 p-1 border-l border-black">الوحدة</div>
                                <div className="w-1/6 p-1 border-l border-black">العدد</div>
                                <div className="w-1/3 p-1">ملاحظات</div>
                            </div>
                            
                            <div className="flex border-b border-black">
                                <div className="w-1/3 p-2 border-l border-black font-bold">غياب مشرف</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">يوم</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">{stats.supAbs}</div>
                                <div className="w-1/3"></div>
                            </div>
                            
                            <div className="flex border-b border-black">
                                <div className="w-1/3 p-2 border-l border-black font-bold">غياب عمال</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">يوم</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">{stats.workAbs}</div>
                                <div className="w-1/3"></div>
                            </div>
                            
                            <div className="flex border-b border-black">
                                <div className="w-1/3 p-2 border-l border-black font-bold">سلامة مهنية</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">يوم</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">{stats.safety}</div>
                                <div className="w-1/3"></div>
                            </div>
                            
                            <div className="flex border-b border-black">
                                <div className="w-1/3 p-2 border-l border-black font-bold">نظافة</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">يوم</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">{stats.hygiene}</div>
                                <div className="w-1/3"></div>
                            </div>
                            
                            <div className="flex border-b border-black">
                                <div className="w-1/3 p-2 border-l border-black font-bold">فحص مخبري</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">سلبي</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">{stats.lab>0?'إيجابي':'-'}</div>
                                <div className="w-1/3"></div>
                            </div>
                        </div>
                        
                        <div className="mt-8 border-2 border-black">
                            <div className="flex border-b border-black">
                                <div className="w-1/2 text-center p-1 border-l border-black font-bold bg-gray-50">ممثل الشركة</div>
                                <div className="w-1/2 text-center p-1 font-bold bg-gray-50">الطبيب البيطري</div>
                            </div>
                            <div className="flex h-16">
                                <div className="w-1/2 border-l border-black p-2 flex items-end justify-center font-bold">
                                    {report?.approvedByContractor ? signatures.contractor : ''}
                                </div>
                                <div className="w-1/2 p-2 flex items-end justify-center font-bold">
                                    {report?.submitted ? signatures.enteredBy : ''}
                                </div>
                            </div>
                            <div className="text-center p-1 font-bold bg-gray-50 border-t border-b border-black">رئيس شعبة المسالخ</div>
                            <div className="h-16 flex items-end justify-center font-bold">
                                {report?.approvedBySectionHead ? signatures.sectionHead : ''}
                            </div>
                        </div>
                        
                        <div className="mt-auto bg-[#c5b358] flex justify-between px-4 py-1 font-bold border-t-2 border-[#8b4513]">
                            <span>SH-KPI</span>
                            <span>نسخة الكترونية معتمدة</span>
                            <span>Page 1-1</span>
                        </div>
                    </div>
                </div>
            );
        };

        const KPIPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const [facilities, setFacilities] = useState([]);
            const [items, setItems] = useState([]);
            const [stats, setStats] = useState({});
            const [record, setRecord] = useState(null);
            const [notes, setNotes] = useState({});
            const [paymentNum, setPaymentNum] = useState('');
            const [signatures, setSignatures] = useState({
                enteredBy: '',
                enteredDate: '',
                contractor: '',
                contractorDate: '',
                deptManager: '',
                deptManagerDate: ''
            });
            
            const canViewAll = [UserRole.ADMIN, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD, UserRole.CONTRACT_MANAGER].includes(currentUser.role);
            const canSubmit = (currentUser.role === UserRole.ADMIN || currentUser.role === UserRole.USER) && (!record || record.status === 'PENDING');
            const canApproveContractor = [UserRole.ADMIN, UserRole.CONTRACTOR].includes(currentUser.role) && (record?.status === 'SUBMITTED');
            const canApproveManager = [UserRole.ADMIN, UserRole.DEPT_MANAGER].includes(currentUser.role) && (record?.status === 'SUBMITTED' || record?.status === 'CONTRACTOR_APPROVED');

            const loadData = () => {
                const allFacs = DataService.facilities.getAll();
                if(canViewAll) { 
                    setFacilities(allFacs); 
                } else { 
                    setFacilities(allFacs.filter(f=>f.id===currentUser.facilityId)); 
                    if(currentUser.facilityId) setSelectedFacility(currentUser.facilityId); 
                }
                setItems(DataService.items.getAll());

                const inv = DataService.invoices.getAll().find(i => i.month === month && i.facilityId === selectedFacility);
                setPaymentNum(inv ? inv.id : `PAY-${month}`);
                
                const r = DataService.kpiReports.getAll().find(r => r.month === month && r.facilityId === selectedFacility);
                setRecord(r || null);
                
                if (r?.signatures) {
                    setSignatures(r.signatures);
                }
                
                const evals = DataService.evaluations.getAll().filter(e => e.date.startsWith(month) && e.facilityId === selectedFacility);
                const s = {};
                const autoNotes = {};
                DataService.items.getAll().forEach(i => {
                    let total=0, passed=0;
                    evals.forEach(ev => Object.keys(ev.scores).forEach(k => { 
                        if(k.startsWith(`${i.id}_`)) { 
                            total++; 
                            if(ev.scores[k]) passed++; 
                        } 
                    }));
                    const pct = total===0?100:Math.round((passed/total)*100);
                    s[i.id] = { total, passed, percentage: pct };
                    if(pct < 100) autoNotes[i.id] = "تم تحرير مخالفة بالبند";
                });
                setStats(s);
                setNotes({ ...autoNotes, ...(r?.notes || {}) });
            };

            useEffect(() => {
                loadData();
                window.addEventListener('storage-update', loadData);
                return () => window.removeEventListener('storage-update', loadData);
            }, [month, selectedFacility, currentUser]);

            const handleSave = (status) => {
                const updated = { 
                    id: `${month}-${selectedFacility}`, 
                    month, 
                    facilityId: selectedFacility, 
                    notes, 
                    status, 
                    signatures: { ...signatures },
                    stats: stats,
                    lastUpdated: new Date().toISOString()
                };
                
                const today = new Date().toLocaleDateString('en-GB');
                
                if(status === 'SUBMITTED') {
                    updated.signatures.enteredBy = currentUser.name;
                    updated.signatures.enteredDate = today;
                    
                    const contractor = DataService.users.getAll().find(u => 
                        u.role === UserRole.CONTRACTOR && u.facilityId === selectedFacility
                    );
                    if (contractor) {
                        DataService.notifications.add({
                            toUserId: contractor.id,
                            message: `تم تقديم مؤشر الأداء ${month} للمراجعة`,
                            facilityId: selectedFacility,
                            type: 'KPI_SUBMITTED'
                        });
                    }
                }
                
                if(status === 'CONTRACTOR_APPROVED') {
                    updated.signatures.contractor = currentUser.name;
                    updated.signatures.contractorDate = today;
                    
                    const deptManager = DataService.users.getAll().find(u => u.role === UserRole.DEPT_MANAGER);
                    if (deptManager) {
                        DataService.notifications.add({
                            toUserId: deptManager.id,
                            message: `تم اعتماد مؤشر الأداء ${month} من المقاول`,
                            facilityId: selectedFacility,
                            type: 'KPI_APPROVED'
                        });
                    }
                }
                
                if(status === 'APPROVED') {
                    updated.signatures.deptManager = currentUser.name;
                    updated.signatures.deptManagerDate = today;

                    const vet = DataService.users.getAll().find(u => u.role === UserRole.USER && u.facilityId === selectedFacility);
                    if (vet) {
                        DataService.notifications.add({
                            toUserId: vet.id,
                            message: `تم اعتماد مؤشر الأداء ${month} من مدير الإدارة`,
                            facilityId: selectedFacility,
                            type: 'KPI_APPROVED'
                        });
                    }
                }
                
                const all = DataService.kpiReports.getAll();
                DataService.kpiReports.save([...all.filter(r=>r.id!==updated.id), updated]);
                setRecord(updated);
                showToast('تم الحفظ');
            };

            const handleEdit = () => {
                if(!record) return;
                const updated = { 
                    ...record, 
                    status: 'PENDING', 
                    signatures: { 
                        ...record.signatures, 
                        contractor: '', 
                        contractorDate: '',
                        deptManager: '',
                        deptManagerDate: '' 
                    } 
                };
                const all = DataService.kpiReports.getAll();
                DataService.kpiReports.save([...all.filter(r=>r.id!==updated.id), updated]);
                setRecord(updated);
                showToast('تم فتح التعديل');
            };

            const handleExport = () => {
                const el = document.getElementById('kpi-report');
                if(el && window.html2pdf) {
                    window.html2pdf().from(el).set({ 
                        margin: 0, 
                        filename: `KPI-${month}.pdf`, 
                        image: { type: 'jpeg', quality: 0.98 }, 
                        html2canvas: { scale: 2, useCORS: true }, 
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
                    }).save();
                } else {
                    window.print();
                }
            };

            const fac = facilities.find(f => f.id === selectedFacility);

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex justify-between items-center no-print">
                        <h2 className="text-xl font-bold">مؤشر الأداء</h2>
                        <div className="flex gap-2">
                            {canViewAll ? (
                                <select value={selectedFacility} onChange={e=>setSelectedFacility(e.target.value)} className="border p-2 rounded">
                                    {facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                </select>
                            ) : (
                                <span className="font-bold px-3">{fac?.name}</span>
                            )}
                            <input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border p-2 rounded"/>
                            
                            {canSubmit && (
                                <button onClick={()=>handleSave('SUBMITTED')} className="bg-green-600 text-white px-4 rounded font-bold shadow">
                                    تقديم للاعتماد
                                </button>
                            )}
                            
                            {canSubmit && record && record.status !== 'PENDING' && (
                                <button onClick={handleEdit} className="bg-blue-500 text-white px-4 rounded font-bold">
                                    تعديل
                                </button>
                            )}
                            
                            {canApproveContractor && !record?.signatures.contractor && (
                                <button onClick={()=>handleSave('CONTRACTOR_APPROVED')} className="bg-purple-600 text-white px-4 rounded font-bold shadow">
                                    اعتماد المقاول
                                </button>
                            )}
                            
                            {canApproveManager && !record?.signatures.deptManager && (
                                <button onClick={()=>handleSave('APPROVED')} className="bg-gold text-white px-4 rounded font-bold shadow border-2 border-gold-dark">
                                    اعتماد مدير الإدارة
                                </button>
                            )}
                            
                            <button onClick={handleExport} className="bg-blue-600 text-white px-4 rounded">
                                <i className="fa fa-print"></i> PDF
                            </button>
                        </div>
                    </div>
                    
                    <div id="kpi-report" className="bg-white mx-auto w-full max-w-[210mm] min-h-[297mm] p-4 text-xs font-sans text-black flex flex-col relative shadow-lg">
                        <div className="flex justify-between items-stretch mb-2 border-2 border-[#8b4513] h-24">
                            <div className="w-1/4 border-l-2 border-[#8b4513] flex items-center justify-center p-2"></div>
                            <div className="w-1/2 flex flex-col items-center justify-center bg-[#c5b358] text-black font-bold">
                                <h1 className="text-xl mb-1">إدارة الصحة العامة</h1>
                                <h2 className="text-lg">مسلخ {fac?.name}</h2>
                            </div>
                            <div className="w-1/4 border-r-2 border-[#8b4513] flex items-center justify-center p-2">
                                {DataService.settings.get().logo ? (
                                    <img src={DataService.settings.get().logo} className="max-h-20 mix-blend-multiply" alt="شعار المؤسسة" />
                                ) : 'LOGO'}
                            </div>
                        </div>
                        
                        <div className="bg-[#8b4513] text-white text-center font-bold py-1 border-2 border-[#8b4513] mb-2">
                            المؤشرات الرئيسية للأداء
                        </div>
                        
                        <div className="border-2 border-black text-center font-bold py-1 mb-2 bg-gray-50">
                            تقدم شهرياً إلى إدارة المحاسبة
                        </div>
                        
                        <div className="flex border-2 border-[#c5b358] mb-4 font-bold text-center">
                            <div className="w-1/2 flex">
                                <div className="bg-[#c5b358] w-1/3 py-1 border-l border-white">رقم العقد</div>
                                <div className="w-2/3 py-1 bg-[#fdf5e6]">{fac?.contractNumber}</div>
                            </div>
                            <div className="w-1/2 flex">
                                <div className="bg-[#c5b358] w-1/3 py-1 border-r border-white">رقم الفاتورة</div>
                                <div className="w-2/3 py-1 bg-[#fdf5e6]">{paymentNum}</div>
                            </div>
                        </div>
                        
                        <div className="border-2 border-black flex-1 flex flex-col">
                            <div className="bg-[#c5b358] text-black font-bold border-b-2 border-black">
                                <div className="text-right px-2 py-1 bg-[#e6d89b] border-b border-black">البيانات</div>
                                <div className="flex border-b border-black">
                                    <div className="w-1/2 border-l border-black p-1 text-center bg-white">مسلخ {fac?.name}</div>
                                    <div className="w-1/2 p-1 text-center bg-white">شهر {month}</div>
                                </div>
                                <div className="text-right px-2 py-1 bg-[#f0f0f0] border-b border-black text-[10px]">
                                    معايير تقييم الأداء: (ممتاز: 95-100) (جيد جداً: 90-94) (جيد: 80-89) (مقبول: 70-79) (ضعيف: أقل من 70)
                                </div>
                            </div>
                            
                            <div className="flex flex-1">
                                <div className="flex flex-col w-[45%] border-l border-gray-300">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white">البند</div>
                                    {items.map((item,i)=>(
                                        <div key={item.id} className={`flex-1 flex items-center justify-start pr-2 font-bold text-right border-b border-gray-300 ${i%2===0?'bg-white':'bg-gray-50'}`}>
                                            {item.name}
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="flex flex-col w-[10%] min-w-[70px] border-l border-gray-300">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white text-center text-[10px] leading-tight">
                                        طريقة<br/>الاحتساب
                                    </div>
                                    <div className="flex-1 flex items-center justify-center bg-[#fdf5e6] overflow-hidden">
                                        <span className="text-[10px] text-gray-800 font-bold whitespace-nowrap origin-center" style={{transform:'rotate(-90deg)', width:'100px'}}>
                                            الالتزام الفعلي ÷ المطلوب × 100%
                                        </span>
                                    </div>
                                </div>
                                
                                <div className="flex flex-col w-[8%] border-l border-gray-300">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white text-[10px]">الكلي</div>
                                    {items.map((item,i)=>{
                                        const s=stats[item.id]||{total:0}; 
                                        return (
                                            <div key={item.id} className={`flex-1 flex items-center justify-center border-b border-gray-300 ${i%2===0?'bg-white':'bg-gray-50'}`}>
                                                {s.total}
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                <div className="flex flex-col w-[8%] border-l border-gray-300">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white text-[10px]">المطابق</div>
                                    {items.map((item,i)=>{
                                        const s=stats[item.id]||{passed:0}; 
                                        return (
                                            <div key={item.id} className={`flex-1 flex items-center justify-center border-b border-gray-300 ${i%2===0?'bg-white':'bg-gray-50'}`}>
                                                {s.passed}
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                <div className="flex flex-col w-[8%] border-l border-gray-300">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white">%</div>
                                    {items.map((item,i)=>{
                                        const s=stats[item.id]||{percentage:100}; 
                                        return (
                                            <div key={item.id} className={`flex-1 flex items-center justify-center font-bold border-b border-gray-300 ${i%2===0?'bg-white':'bg-gray-50'}`}>
                                                {s.percentage}%
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                <div className="flex flex-col w-[21%]">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white">ملاحظات</div>
                                    {items.map((item,i)=>(
                                        <div key={item.id} className={`flex-1 flex items-center justify-center border-b border-gray-300 ${i%2===0?'bg-white':'bg-gray-50'}`}>
                                            <input 
                                                className="w-full text-center bg-transparent outline-none text-[10px]" 
                                                value={notes[item.id]||''} 
                                                onChange={e=>setNotes({...notes,[item.id]:e.target.value})} 
                                                disabled={record?.status==='APPROVED' && !canSubmit} 
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        <div className="mt-4 flex justify-between items-end px-8 pb-4">
                            <div className="text-center">
                                <div className="font-bold mb-8 border-b-2 border-black pb-1 min-w-[150px]">الطبيب المناوب</div>
                                <div>{signatures.enteredBy || ''}</div>
                                <div className="text-xs text-gray-500">{signatures.enteredDate || ''}</div>
                            </div>
                            <div className="text-center">
                                <div className="font-bold mb-8 border-b-2 border-black pb-1 min-w-[150px]">ممثل المقاول</div>
                                <div>{signatures.contractor || ''}</div>
                                <div className="text-xs text-gray-500">{signatures.contractorDate || ''}</div>
                            </div>
                            <div className="text-center">
                                <div className="font-bold mb-8 border-b-2 border-black pb-1 min-w-[150px]">مدير الإدارة</div>
                                <div>{signatures.deptManager || ''}</div>
                                <div className="text-xs text-gray-500">{signatures.deptManagerDate || ''}</div>
                            </div>
                        </div>
                        
                        <div className="mt-auto bg-[#c5b358] flex justify-between px-4 py-1 font-bold border-t-2 border-[#8b4513]">
                            <span>SH-KPI</span>
                            <span>نسخة الكترونية معتمدة</span>
                            <span>Page 1-1</span>
                        </div>
                    </div>
                </div>
            );
        };

        const InvoicePage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedFacilityId, setSelectedFacilityId] = useState(currentUser.facilityId || '1');
            const [facilities, setFacilities] = useState([]);
            const [calculatedData, setCalculatedData] = useState(null);
            const [invoiceRecord, setInvoiceRecord] = useState(null);
            const [contractNumber, setContractNumber] = useState('');
            const [paymentNumber, setPaymentNumber] = useState('');
            const [amountInWords, setAmountInWords] = useState('');
            const [signatures, setSignatures] = useState({
                enteredBy: '',
                enteredDate: '',
                contractor: '',
                contractorDate: '',
                deptManager: '',
                deptManagerDate: ''
            });
            
            const canViewAll = [UserRole.ADMIN, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD, UserRole.CONTRACT_MANAGER].includes(currentUser.role);
            const canSubmit = [UserRole.ADMIN, UserRole.USER].includes(currentUser.role);
            const canApproveContractor = [UserRole.ADMIN, UserRole.CONTRACTOR].includes(currentUser.role);
            const canApproveManager = [UserRole.ADMIN, UserRole.DEPT_MANAGER].includes(currentUser.role);

            useEffect(() => {
                const all = DataService.facilities.getAll();
                if(canViewAll) setFacilities(all);
                else {
                    const myFac = all.filter(f => f.id === currentUser.facilityId);
                    setFacilities(myFac);
                    if(myFac.length>0) setSelectedFacilityId(myFac[0].id);
                }
            }, [currentUser, canViewAll]);

            useEffect(() => { 
                if(selectedFacilityId) calculateInvoice(); 
            }, [month, selectedFacilityId]);

            const calculateInvoice = () => {
                const fac = DataService.facilities.getAll().find(f => f.id === selectedFacilityId);
                if(!fac) return;
                
                const existing = DataService.invoices.getAll().find(i => i.month === month && i.facilityId === selectedFacilityId);
                if(existing) {
                    setInvoiceRecord(existing);
                    setCalculatedData(existing.data);
                    setContractNumber(existing.data.contractNumber);
                    setPaymentNumber(existing.id);
                    setAmountInWords(existing.data.amountInWords || '');
                    setSignatures(existing.signatures || {});
                    return;
                } else {
                    setInvoiceRecord(null);
                    setSignatures({});
                }

                setContractNumber(fac.contractNumber);
                setPaymentNumber(`PAY-${month}`);

                const daysInMonth = 30; 
                const emps = DataService.employees.getAll().filter(e => e.facilityId === selectedFacilityId);
                const evaluations = DataService.evaluations.getAll().filter(e => e.date.startsWith(month) && e.facilityId === selectedFacilityId);
                
                const grouped = {};
                emps.forEach(e => {
                    const t = e.jobTitle.trim();
                    if(!grouped[t]) grouped[t] = { employees: [], count: 0, totalSalary: 0 };
                    grouped[t].employees.push(e);
                    grouped[t].count++;
                    grouped[t].totalSalary += e.salary;
                });

                const employeeCosts = Object.keys(grouped).map(role => {
                    const g = grouped[role];
                    let totalAbsence = 0;
                    evaluations.forEach(ev => {
                        g.employees.forEach(emp => { if(ev.scores[`i1_${emp.id}`] === false) totalAbsence++; });
                    });
                    
                    const monthlySalaryAvg = g.totalSalary / g.count;
                    const dailySalaryAvg = monthlySalaryAvg / 30;
                    const totalExpectedDays = g.count * daysInMonth;
                    const actualDays = totalExpectedDays - totalAbsence;
                    
                    const absenceDeduction = totalAbsence * dailySalaryAvg;
                    const netSalary = g.totalSalary - absenceDeduction;

                    return {
                        role, count: g.count, monthlySalary: monthlySalaryAvg, dailySalary: dailySalaryAvg,
                        totalExpectedDays, absentDays: totalAbsence, actualDays, netSalary,
                        totalMonthlyCost: g.totalSalary,
                        absenceDeduction
                    };
                });

                const violations = DataService.violations.getAll().filter(v => v.facilityId === selectedFacilityId && v.date.startsWith(month) && v.status === 'OPEN');
                const totalViolationsAmount = violations.reduce((s, v) => s + v.total, 0);

                const extraLabor = DataService.extraLabor.getAll().find(e => e.date === month && e.facilityId === selectedFacilityId && e.submitted);
                const extraLaborCost = extraLabor ? extraLabor.items.reduce((s, i) => s + (i.dailyRate * i.days), 0) : 0;
                
                // --- Updated Calculations ---
                const extraLaborCount = extraLabor ? extraLabor.items.length : 0;
                const extraLaborDays = extraLabor ? extraLabor.items.reduce((s, i) => s + i.days, 0) : 0;
                
                let tChecks = 0, pChecks = 0;
                evaluations.forEach(ev => Object.values(ev.scores).forEach(v => { tChecks++; if(v) pChecks++; }));
                const kpiPercent = tChecks === 0 ? 100 : Math.round((pChecks/tChecks)*100);
                
                const cleaningCost = 40000;
                const baseTotal = employeeCosts.reduce((s,i) => s + i.totalMonthlyCost, 0) + cleaningCost + extraLaborCost;
                
                const retention = baseTotal * 0.05;
                const taxableAmount = baseTotal - retention;
                const tax = taxableAmount * 0.05;
                
                const totalAbsenceDeduction = employeeCosts.reduce((s, i) => s + i.absenceDeduction, 0);
                
                let kpiDeduction = 0;
                if(kpiPercent < 80) kpiDeduction = baseTotal * 0.10; 
                else if(kpiPercent < 90) kpiDeduction = baseTotal * 0.05;
                
                const totalDeductions = totalViolationsAmount + totalAbsenceDeduction + kpiDeduction;
                const finalTotal = (baseTotal + tax) - (retention + totalDeductions);

                const data = {
                    employeeCosts, daysInMonth, baseTotal, cleaningCost, extraLaborCost, 
                    kpiPercent, kpiDeduction, totalViolationsAmount, totalAbsentPenalties: totalAbsenceDeduction,
                    totalImposedPenalties: totalDeductions, retention, taxableAmount, tax, finalTotal,
                    facilityName: fac.name, contractNumber: fac.contractNumber, operatingCompany: fac.operatingCompany,
                    deductionsDetail: {
                        insurance: retention,
                        fines: totalViolationsAmount,
                        absences: totalAbsenceDeduction,
                        kpi: kpiDeduction
                    },
                    extraLaborData: {
                        count: extraLaborCount,
                        days: extraLaborDays,
                        cost: extraLaborCost
                    }
                };
                
                setCalculatedData(data);
                setAmountInWords(numberToArabicWords(Math.round(finalTotal)));
            };

            const handleSubmit = () => {
                if(!calculatedData) return;
                const rec = { 
                    id: paymentNumber, 
                    month, 
                    facilityId: selectedFacilityId, 
                    status: 'SUBMITTED', 
                    approvals: {}, 
                    signatures: { 
                        ...signatures,
                        enteredBy: currentUser.name, 
                        enteredDate: new Date().toLocaleDateString('en-GB') 
                    }, 
                    data: { 
                        ...calculatedData, 
                        contractNumber, 
                        paymentNumber,
                        amountInWords 
                    } 
                };
                DataService.invoices.save([...DataService.invoices.getAll().filter(i => i.month !== month || i.facilityId !== selectedFacilityId), rec]);
                setInvoiceRecord(rec);
                
                const contractor = DataService.users.getAll().find(u => 
                    u.role === UserRole.CONTRACTOR && u.facilityId === selectedFacilityId
                );
                if (contractor) {
                    DataService.notifications.add({
                        toUserId: contractor.id,
                        message: `تم تقديم الفاتورة الشهرية ${month} للمراجعة`,
                        facilityId: selectedFacilityId,
                        type: 'INVOICE_SUBMITTED'
                    });
                }
                
                showToast('تم التقديم');
            };

            const handleApprove = (role) => {
                if(!invoiceRecord) return;
                const up = { ...invoiceRecord };
                const today = new Date().toLocaleDateString('en-GB');
                
                if(role === 'CONTRACTOR') { 
                    up.approvals.contractor = true; 
                    up.signatures.contractor = currentUser.name;
                    up.signatures.contractorDate = today;
                    
                    const deptManager = DataService.users.getAll().find(u => u.role === UserRole.DEPT_MANAGER);
                    if (deptManager) {
                        DataService.notifications.add({
                            toUserId: deptManager.id,
                            message: `تم اعتماد الفاتورة ${month} من المقاول`,
                            facilityId: selectedFacilityId,
                            type: 'INVOICE_APPROVED'
                        });
                    }
                } else { 
                    up.approvals.deptManager = true; 
                    up.status = 'APPROVED'; 
                    up.signatures.deptManager = currentUser.name;
                    up.signatures.deptManagerDate = today;
                    
                    const contractManager = DataService.users.getAll().find(u => u.role === UserRole.CONTRACT_MANAGER);
                    if (contractManager) {
                        DataService.notifications.add({
                            toUserId: contractManager.id,
                            message: `فاتورة جديدة ${month} جاهزة للأرشيف`,
                            facilityId: selectedFacilityId,
                            type: 'INVOICE_FINAL'
                        });
                    }

                    const vet = DataService.users.getAll().find(u => u.role === UserRole.USER && u.facilityId === selectedFacilityId);
                    if (vet) {
                        DataService.notifications.add({
                            toUserId: vet.id,
                            message: `تم اعتماد الفاتورة ${month} من مدير الإدارة`,
                            facilityId: selectedFacilityId,
                            type: 'INVOICE_APPROVED'
                        });
                    }
                }
                DataService.invoices.save([...DataService.invoices.getAll().filter(i => i.id !== up.id), up]);
                setInvoiceRecord(up);
                showToast('تم الاعتماد');
            };

            const handleExport = () => {
                const el = document.getElementById('invoice-report');
                if(el && window.html2pdf) {
                    window.html2pdf().from(el).set({ 
                        margin: 0, 
                        filename: `Invoice-${month}.pdf`, 
                        image: { type: 'jpeg', quality: 0.98 }, 
                        html2canvas: { scale: 2, useCORS: true }, 
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } 
                    }).save();
                }
            };

            if(!calculatedData) return <div className="p-8 text-center">جاري الحساب...</div>;

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex flex-col gap-4 no-print">
                        <div className="flex justify-between items-center">
                            <h2 className="text-xl font-bold">الفاتورة الشهرية</h2>
                            <div className="flex gap-2">
                                {canViewAll ? (
                                    <select value={selectedFacilityId} onChange={e=>setSelectedFacilityId(e.target.value)} className="border p-2 rounded">
                                        {facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                    </select>
                                ) : (
                                    <span className="font-bold px-3">{calculatedData.facilityName}</span>
                                )}
                                <input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border p-2 rounded" />
                            </div>
                        </div>
                        
                        {canSubmit && (!invoiceRecord || invoiceRecord.status === 'PENDING') && (
                            <div className="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded">
                                <input value={contractNumber} onChange={e=>setContractNumber(e.target.value)} placeholder="رقم العقد" className="border p-2 rounded" />
                                <input value={paymentNumber} onChange={e=>setPaymentNumber(e.target.value)} placeholder="رقم الدفعة" className="border p-2 rounded" />
                            </div>
                        )}
                        
                        <div className="flex gap-2">
                            {canSubmit && !invoiceRecord && (
                                <button onClick={handleSubmit} className="bg-blue-600 text-white px-4 py-2 rounded">
                                    تقديم
                                </button>
                            )}
                            
                            {canApproveContractor && invoiceRecord && !invoiceRecord.approvals.contractor && (
                                <button onClick={()=>handleApprove('CONTRACTOR')} className="bg-purple-600 text-white px-4 py-2 rounded font-bold">
                                    اعتماد المقاول
                                </button>
                            )}
                            
                            {canApproveManager && invoiceRecord && !invoiceRecord.approvals.deptManager && (
                                <button onClick={()=>handleApprove('DEPT_MANAGER')} className="bg-gold text-white px-4 py-2 rounded font-bold shadow-lg border-2 border-gold-dark">
                                    اعتماد مدير الإدارة
                                </button>
                            )}
                            
                            <button onClick={handleExport} className="bg-gray-800 text-white px-4 py-2 rounded">PDF</button>
                        </div>
                    </div>

                    <div id="invoice-report" className="bg-white p-2 mx-auto w-full max-w-[297mm] h-[210mm] flex flex-col justify-between text-[10px] leading-tight font-sans overflow-hidden shadow-lg relative">
                        <div>
                            <div className="flex justify-between items-center bg-[#c5b358] p-1 border-2 border-black mb-1 h-[18mm]">
                                <div className="text-center w-1/4 h-full flex items-center justify-center">
                                    {DataService.settings.get().logo ? (
                                        <img src={DataService.settings.get().logo} className="h-full max-h-16 mx-auto object-contain mix-blend-multiply" alt="شعار المؤسسة" />
                                    ) : <span className="font-bold">LOGO</span>}
                                </div>
                                <div className="text-center w-2/4">
                                    <h1 className="text-xl font-bold mb-0">إدارة الصحة العامة</h1>
                                    <h2 className="text-lg font-bold">مسلخ {calculatedData.facilityName}</h2>
                                </div>
                                <div className="w-1/4"></div>
                            </div>
                            
                            <div className="grid grid-cols-3 border-2 border-black mb-1 text-center font-bold">
                                <div className="border-l-2 border-black bg-[#e6d89b] p-0.5">الشركة : {calculatedData.operatingCompany}</div>
                                <div className="border-l-2 border-black bg-[#e6d89b] p-0.5">عقد رقم : {contractNumber}</div>
                                <div className="bg-[#e6d89b] p-0.5">الشهر : {month}</div>
                            </div>
                            
                            <table className="w-full border-collapse border-2 border-black text-center text-[10px]">
                                <thead className="bg-[#c5b358] text-black font-bold">
                                    <tr>
                                        <th className="border border-black p-0.5">م</th>
                                        <th className="border border-black p-0.5">الفئة</th>
                                        <th className="border border-black p-0.5">العدد</th>
                                        <th className="border border-black p-0.5">أيام الحضور الفعلي</th>
                                        <th className="border border-black p-0.5">أيام الغياب</th>
                                        <th className="border border-black p-0.5">الراتب الشهري</th>
                                        <th className="border border-black p-0.5">اجمالي الرواتب</th>
                                        <th className="border border-black p-0.5">خصم الغياب</th>
                                        <th className="border border-black p-0.5">الصافي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {calculatedData.employeeCosts.map((i, idx) => (
                                        <tr key={idx}>
                                            <td className="border border-black p-0.5">{idx + 1}</td>
                                            <td className="border border-black p-0.5 font-bold bg-white text-right px-1">{i.role}</td>
                                            <td className="border border-black p-0.5">{i.count}</td>
                                            <td className="border border-black p-0.5 font-bold">{i.actualDays}</td>
                                            <td className="border border-black p-0.5 font-bold text-red-600">{i.absentDays}</td>
                                            <td className="border border-black p-0.5">{Math.round(i.monthlySalary)}</td>
                                            <td className="border border-black p-0.5 font-bold">{Math.round(i.totalMonthlyCost)}</td>
                                            <td className="border border-black p-0.5 text-red-600">({Math.round(i.absenceDeduction)})</td>
                                            <td className="border border-black p-0.5 bg-[#fef3c7]">{Math.round(i.netSalary).toLocaleString()}</td>
                                        </tr>
                                    ))}
                                    
                                    <tr className="bg-blue-50">
                                        <td className="border border-black p-0.5">-</td>
                                        <td className="border border-black p-0.5 font-bold bg-white text-right px-1">عمالة إضافية</td>
                                        {/* Column 3: Count */}
                                        <td className="border border-black p-0.5 font-bold">{calculatedData.extraLaborData.count > 0 ? calculatedData.extraLaborData.count : '-'}</td>
                                        {/* Column 4: Actual Days */}
                                        <td className="border border-black p-0.5 font-bold">{calculatedData.extraLaborData.days > 0 ? calculatedData.extraLaborData.days : '-'}</td>
                                        <td className="border border-black p-0.5">-</td>
                                        <td className="border border-black p-0.5">-</td>
                                        <td className="border border-black p-0.5">-</td>
                                        <td className="border border-black p-0.5">-</td>
                                        {/* Last Column: Total Cost */}
                                        <td className="border border-black p-0.5 font-bold bg-[#fef3c7]">{Math.round(calculatedData.extraLaborData.cost).toLocaleString()}</td>
                                    </tr>

                                    <tr className="bg-gray-50">
                                        <td className="border border-black p-0.5">-</td>
                                        <td className="border border-black p-0.5 font-bold bg-white text-right px-1">مواد تنظيف</td>
                                        <td colSpan={2} className="border border-black"></td>
                                        <td className="border border-black"></td>
                                        <td className="border border-black"></td>
                                        <td className="border border-black p-0.5 font-bold">{calculatedData.cleaningCost.toLocaleString()}</td>
                                        <td colSpan={2} className="border border-black"></td>
                                    </tr>
                                    
                                    <tr className="bg-[#c5b358] font-bold text-[11px]">
                                        <td className="border border-black p-0.5" colSpan={6}>اجمالي الاستحقاق (قبل الخصومات والضريبة)</td>
                                        <td className="border border-black p-0.5">{Math.round(calculatedData.baseTotal).toLocaleString()}</td>
                                        <td colSpan={2} className="border border-black"></td>
                                    </tr>
                                </tbody>
                            </table>

                            <div className="grid grid-cols-2 gap-2 mt-2">
                                <table className="w-full border-collapse border-2 border-black text-center text-[10px]">
                                    <thead>
                                        <tr>
                                            <th colSpan={2} className="bg-gray-200 border border-black font-bold">الخصومات والغرامات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td className="border border-black p-1 text-right">حجز الضمان (5%)</td>
                                            <td className="border border-black p-1 text-red-600 font-bold">({Math.round(calculatedData.deductionsDetail.insurance).toLocaleString()})</td>
                                        </tr>
                                        <tr>
                                            <td className="border border-black p-1 text-right">غرامات مخالفات</td>
                                            <td className="border border-black p-1 text-red-600 font-bold">({Math.round(calculatedData.deductionsDetail.fines).toLocaleString()})</td>
                                        </tr>
                                        <tr>
                                            <td className="border border-black p-1 text-right">خصم الغياب</td>
                                            <td className="border border-black p-1 text-red-600 font-bold">({Math.round(calculatedData.deductionsDetail.absences).toLocaleString()})</td>
                                        </tr>
                                        <tr>
                                            <td className="border border-black p-1 text-right">خصم الأداء ({calculatedData.kpiPercent}%)</td>
                                            <td className="border border-black p-1 text-red-600 font-bold">({Math.round(calculatedData.deductionsDetail.kpi).toLocaleString()})</td>
                                        </tr>
                                        <tr className="bg-red-50">
                                            <td className="border border-black p-1 font-bold text-right">إجمالي الخصومات</td>
                                            <td className="border border-black p-1 font-bold text-red-800">
                                                ({Math.round(calculatedData.totalImposedPenalties + calculatedData.retention).toLocaleString()})
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <table className="w-full border-collapse border-2 border-black text-center text-[10px]">
                                    <thead>
                                        <tr>
                                            <th colSpan={2} className="bg-gray-200 border border-black font-bold">الملخص المالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td className="border border-black p-1 text-right">الإجمالي الخاضع للضريبة</td>
                                            <td className="border border-black p-1 font-bold">{Math.round(calculatedData.taxableAmount).toLocaleString()}</td>
                                        </tr>
                                        <tr>
                                            <td className="border border-black p-1 text-right">الضريبة المضافة (5%)</td>
                                            <td className="border border-black p-1 font-bold">{Math.round(calculatedData.tax).toLocaleString()}</td>
                                        </tr>
                                        <tr className="bg-[#c5b358] text-[12px]">
                                            <td className="border border-black p-2 font-bold text-right">صافي المبلغ المستحق</td>
                                            <td className="border border-black p-2 font-bold">{Math.round(calculatedData.finalTotal).toLocaleString()}</td>
                                        </tr>
                                        <tr className="bg-yellow-50">
                                            <td colSpan={2} className="border border-black p-2 text-center font-bold">
                                                {amountInWords}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="mt-4 grid grid-cols-3 gap-4 border-t pt-4">
                                <div className="text-center">
                                    <div className="font-bold border-b pb-1">الطبيب البيطري</div>
                                    <div className="mt-2">{signatures.enteredBy || ''}</div>
                                    <div className="text-xs text-gray-500">{signatures.enteredDate || ''}</div>
                                </div>
                                <div className="text-center">
                                    <div className="font-bold border-b pb-1">المقاول</div>
                                    <div className="mt-2">{signatures.contractor || ''}</div>
                                    <div className="text-xs text-gray-500">{signatures.contractorDate || ''}</div>
                                </div>
                                <div className="text-center">
                                    <div className="font-bold border-b pb-1">مدير الإدارة</div>
                                    <div className="mt-2">{signatures.deptManager || ''}</div>
                                    <div className="text-xs text-gray-500">{signatures.deptManagerDate || ''}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex justify-between items-center bg-[#c5b358] p-0.5 font-bold border-2 border-black text-[9px] mt-2">
                            <span>SH-INVOICE</span>
                            <span>نسخة الكترونية معتمدة</span>
                            <span>Page 1-1</span>
                        </div>
                    </div>
                </div>
            );
        };

        const ExtraLaborPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const [facilities, setFacilities] = useState([]);
            const [rows, setRows] = useState([]);
            const [submitted, setSubmitted] = useState(false);
            
            const canViewAll = [UserRole.ADMIN, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD, UserRole.CONTRACT_MANAGER].includes(currentUser.role);

            useEffect(() => {
                const allFacs = DataService.facilities.getAll();
                if(canViewAll) { 
                    setFacilities(allFacs); 
                    if(allFacs.length > 0 && !selectedFacility) setSelectedFacility(allFacs[0].id);
                } else { 
                    setFacilities(allFacs.filter(f=>f.id===currentUser.facilityId)); 
                    if(currentUser.facilityId) setSelectedFacility(currentUser.facilityId); 
                }
            }, [currentUser, canViewAll]);

            const loadData = () => {
                if(!selectedFacility) return;
                const ex = DataService.extraLabor.getAll().find(e => e.date === month && e.facilityId === selectedFacility);
                if(ex) { 
                    setRows(ex.items); 
                    setSubmitted(ex.submitted); 
                } else { 
                    setRows(Array(12).fill(null).map((_, i) => ({ 
                        id: i, 
                        employeeName: '', 
                        jobTitle: '', 
                        dailyRate: 0, 
                        days: 0 
                    }))); 
                    setSubmitted(false); 
                }
            };

            useEffect(() => {
                loadData();
                window.addEventListener('storage-update', loadData);
                return () => window.removeEventListener('storage-update', loadData);
            }, [month, selectedFacility]);

            const updateRow = (i, f, v) => { 
                if(submitted) return; 
                const n = [...rows]; 
                n[i] = {...n[i], [f]:v}; 
                setRows(n); 
            };
            
            const addRow = () => {
                if(submitted) return;
                setRows([...rows, { 
                    id: rows.length, 
                    employeeName: '', 
                    jobTitle: '', 
                    dailyRate: 0, 
                    days: 0 
                }]);
            };
            
            const removeRow = (index) => {
                if(submitted || rows.length <= 1) return;
                const newRows = rows.filter((_, i) => i !== index);
                setRows(newRows);
            };
            
            const handleSubmit = () => {
                const rec = { 
                    id: `${month}-${selectedFacility}`, 
                    date: month, 
                    facilityId: selectedFacility, 
                    items: rows.filter(r => r.employeeName.trim() !== ''), 
                    submitted: true,
                    submittedBy: currentUser.name,
                    submittedDate: new Date().toISOString()
                };
                const all = DataService.extraLabor.getAll();
                const idx = all.findIndex(e=>e.id===rec.id);
                if(idx>=0) all[idx]=rec; else all.push(rec);
                DataService.extraLabor.save(all);
                setSubmitted(true);
                showToast('تم اعتماد العمالة الإضافية');
            };
            
            const handleEdit = () => {
                const rec = { 
                    id: `${month}-${selectedFacility}`, 
                    date: month, 
                    facilityId: selectedFacility, 
                    items: rows,
                    submitted: false
                };
                const all = DataService.extraLabor.getAll();
                const idx = all.findIndex(e=>e.id===rec.id);
                if(idx>=0) all[idx]=rec; else all.push(rec);
                DataService.extraLabor.save(all);
                setSubmitted(false);
                showToast('تم فتح التعديل');
            };
            
            const total = rows.filter(r => r.employeeName.trim() !== '').reduce((s,r)=>s+(r.dailyRate*r.days), 0);
            const canEdit = !submitted && (canViewAll || currentUser.facilityId === selectedFacility);

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex justify-between items-center no-print">
                        <h2 className="text-xl font-bold">العمالة الإضافية</h2>
                        <div className="flex gap-2">
                            {canViewAll ? (
                                <select value={selectedFacility} onChange={e=>setSelectedFacility(e.target.value)} className="border p-2 rounded">
                                    {facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                </select>
                            ) : (
                                <span className="font-bold px-3">{facilities.find(f=>f.id===selectedFacility)?.name}</span>
                            )}
                            <input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border p-2 rounded"/>
                            {!submitted && canEdit && (
                                <button onClick={addRow} className="bg-green-600 text-white px-4 py-2 rounded">
                                    <i className="fa fa-plus ml-2"></i> إضافة عامل
                                </button>
                            )}
                        </div>
                    </div>
                    
                    <div className="bg-white p-6 rounded shadow mt-6">
                        <table className="w-full border-collapse border">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="border p-2">#</th>
                                    <th className="border p-2">الاسم</th>
                                    <th className="border p-2">الوظيفة</th>
                                    <th className="border p-2">الأجر اليومي</th>
                                    <th className="border p-2">عدد الأيام</th>
                                    <th className="border p-2">الإجمالي</th>
                                    {!submitted && <th className="border p-2">أدوات</th>}
                                </tr>
                            </thead>
                            <tbody>
                                {rows.map((r,i)=>(
                                    <tr key={i}>
                                        <td className="border p-2">{i+1}</td>
                                        <td className="border p-2">
                                            <input 
                                                value={r.employeeName} 
                                                onChange={e=>updateRow(i,'employeeName',e.target.value)} 
                                                disabled={submitted} 
                                                className="w-full outline-none"
                                                placeholder="اسم العامل"
                                            />
                                        </td>
                                        <td className="border p-2">
                                            <input 
                                                value={r.jobTitle} 
                                                onChange={e=>updateRow(i,'jobTitle',e.target.value)} 
                                                disabled={submitted} 
                                                className="w-full outline-none"
                                                placeholder="الوظيفة"
                                            />
                                        </td>
                                        <td className="border p-2">
                                            <input 
                                                type="number" 
                                                value={r.dailyRate} 
                                                onChange={e=>updateRow(i,'dailyRate',Number(e.target.value))} 
                                                disabled={submitted} 
                                                className="w-full outline-none"
                                                min="0"
                                            />
                                        </td>
                                        <td className="border p-2">
                                            <input 
                                                type="number" 
                                                value={r.days} 
                                                onChange={e=>updateRow(i,'days',Number(e.target.value))} 
                                                disabled={submitted} 
                                                className="w-full outline-none"
                                                min="0"
                                            />
                                        </td>
                                        <td className="border p-2 font-bold bg-gray-50">
                                            {(r.dailyRate*r.days).toLocaleString()}
                                        </td>
                                        {!submitted && (
                                            <td className="border p-2">
                                                <button 
                                                    onClick={()=>removeRow(i)} 
                                                    className="text-red-600 hover:text-red-800"
                                                    disabled={rows.length <= 1}
                                                >
                                                    <i className="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        )}
                                    </tr>
                                ))}
                                
                                <tr className="bg-gold text-white font-bold">
                                    <td colSpan={5} className="p-3 text-center">الإجمالي</td>
                                    <td className="p-3 text-center">{total.toLocaleString()}</td>
                                    {!submitted && <td className="p-3"></td>}
                                </tr>
                            </tbody>
                        </table>
                        
                        <div className="flex gap-2 mt-4">
                            {!submitted && (
                                <button onClick={handleSubmit} className="bg-gold text-white px-6 py-2 rounded font-bold">
                                    اعتماد العمالة الإضافية
                                </button>
                            )}
                            {submitted && (
                                <button onClick={handleEdit} className="bg-blue-600 text-white px-6 py-2 rounded font-bold">
                                    تعديل
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ArchivePage = ({ currentUser }) => {
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedFacilityId, setSelectedFacilityId] = useState('');
            const [facilities, setFacilities] = useState([]);
            const [contractorFiles, setContractorFiles] = useState([]);
            const [approvedReports, setApprovedReports] = useState([]);

            useEffect(() => {
                const all = DataService.facilities.getAll();
                setFacilities(all);
                if(all.length > 0) setSelectedFacilityId(all[0].id);
            }, [currentUser]);

            useEffect(() => {
                if(selectedFacilityId) {
                    // Load contractor files
                    FileService.getFiles(selectedFacilityId, month).then(setContractorFiles);
                    
                    // Load approved reports
                    const monthlyReports = DataService.monthlyReports.getAll().filter(r => 
                        r.month === month && r.facilityId === selectedFacilityId && r.approvedBySectionHead
                    );
                    
                    const kpiReports = DataService.kpiReports.getAll().filter(r => 
                        r.month === month && r.facilityId === selectedFacilityId && r.status === 'APPROVED'
                    );
                    
                    const invoices = DataService.invoices.getAll().filter(i => 
                        i.month === month && i.facilityId === selectedFacilityId && i.status === 'APPROVED'
                    );
                    
                    setApprovedReports([...monthlyReports, ...kpiReports, ...invoices]);
                }
            }, [month, selectedFacilityId]);

            const downloadFile = (file) => {
                const link = document.createElement('a');
                link.href = file.data;
                link.download = file.name;
                link.click();
            };

            const facility = facilities.find(f => f.id === selectedFacilityId);

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex justify-between items-center">
                        <h2 className="text-xl font-bold text-gray-800">
                            <i className="fa fa-archive ml-2"></i> أرشيف العقود والتقارير
                        </h2>
                        <div className="flex gap-2">
                            <select value={selectedFacilityId} onChange={e=>setSelectedFacilityId(e.target.value)} className="border p-2 rounded">
                                {facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                            </select>
                            <input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border p-2 rounded" />
                        </div>
                    </div>

                    {facility && (
                        <div className="bg-white p-4 rounded shadow border-t-4 border-gold">
                            <h3 className="font-bold text-lg mb-4 text-gold-dark border-b pb-2">
                                معلومات العقد: {facility.name}
                            </h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="bg-gray-50 p-3 rounded border">
                                    <div className="text-sm text-gray-500">رقم العقد</div>
                                    <div className="font-bold">{facility.contractNumber}</div>
                                </div>
                                <div className="bg-gray-50 p-3 rounded border">
                                    <div className="text-sm text-gray-500">الشركة المشغلة</div>
                                    <div className="font-bold">{facility.operatingCompany}</div>
                                </div>
                                <div className="bg-gray-50 p-3 rounded border">
                                    <div className="text-sm text-gray-500">الموقع</div>
                                    <div className="font-bold">{facility.location}</div>
                                </div>
                                <div className="bg-gray-50 p-3 rounded border">
                                    <div className="text-sm text-gray-500">الشهر</div>
                                    <div className="font-bold">{month}</div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white p-6 rounded shadow border-t-4 border-gold">
                        <h3 className="font-bold text-lg mb-4 text-gold-dark border-b pb-2">التقارير المعتمدة</h3>
                        {approvedReports.length === 0 ? (
                            <p className="text-gray-500 text-center py-10 bg-gray-50 rounded border border-dashed">
                                لا توجد تقارير معتمدة لهذا الشهر
                            </p>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {approvedReports.map((report, idx) => (
                                    <div key={idx} className="flex flex-col justify-between p-4 bg-gray-50 rounded border hover:bg-yellow-50 transition-colors shadow-sm">
                                        <div className="flex items-center mb-2">
                                            <i className="fa fa-file-alt text-blue-500 ml-3 text-2xl"></i>
                                            <div>
                                                <div className="text-sm font-bold">
                                                    {report.id.includes('PAY') ? 'فاتورة' : 
                                                     report.id.includes('KPI') ? 'مؤشر أداء' : 'تقرير شهري'}
                                                </div>
                                                <div className="text-xs text-gray-500">{report.month}</div>
                                            </div>
                                        </div>
                                        <div className="text-xs text-gray-600 mt-2">
                                            <div>الحالة: <span className="text-green-600 font-bold">معتمد</span></div>
                                            {report.signatures && (
                                                <div className="mt-1">
                                                    {report.signatures.deptManager && (
                                                        <div>مدير الإدارة: {report.signatures.deptManager}</div>
                                                    )}
                                                    {report.signatures.contractor && (
                                                        <div>المقاول: {report.signatures.contractor}</div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="bg-white p-6 rounded shadow border-t-4 border-gold">
                        <h3 className="font-bold text-lg mb-4 text-gold-dark border-b pb-2">مرفقات المقاول</h3>
                        {contractorFiles.length === 0 ? (
                            <p className="text-gray-500 text-center py-10 bg-gray-50 rounded border border-dashed">
                                لا توجد ملفات مرفقة لهذا الشهر
                            </p>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {contractorFiles.map(file => (
                                    <div key={file.id} className="flex flex-col justify-between p-4 bg-gray-50 rounded border hover:bg-yellow-50 transition-colors shadow-sm">
                                        <div className="flex items-center mb-2 overflow-hidden">
                                            <i className={`fa ${file.type.includes('pdf')?'fa-file-pdf text-red-500':'fa-file-image text-blue-500'} ml-3 text-2xl`}></i>
                                            <div className="overflow-hidden">
                                                <div className="text-sm font-bold truncate" title={file.name}>{file.name}</div>
                                                <div className="text-xs text-gray-500">
                                                    {new Date(file.uploadDate).toLocaleDateString('ar-AE')}
                                                </div>
                                            </div>
                                        </div>
                                        <button onClick={()=>downloadFile(file)} className="w-full bg-white border border-gray-300 text-blue-600 hover:bg-blue-50 py-2 rounded text-sm font-bold mt-2">
                                            <i className="fa fa-download ml-2"></i> تحميل الملف
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ContractorFilesPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [files, setFiles] = useState([]);
            const [uploading, setUploading] = useState(false);

            const loadFiles = async () => {
                try {
                    const list = await FileService.getFiles(currentUser.facilityId, month);
                    setFiles(list);
                } catch (e) {
                    console.error(e);
                    showToast('خطأ في تحميل الملفات');
                }
            };

            useEffect(() => { 
                if(currentUser.facilityId) loadFiles(); 
            }, [month, currentUser]);

            const handleUpload = async (e) => {
                const file = e.target.files?.[0];
                if (!file || !currentUser.facilityId) return;

                if (file.size > 10 * 1024 * 1024) {
                    alert('حجم الملف كبير جداً. الحد الأقصى 10 ميجابايت.');
                    return;
                }

                setUploading(true);
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64 = reader.result;
                    const newFile = {
                        id: Date.now().toString(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: base64,
                        uploadDate: new Date().toISOString(),
                        month: month,
                        facilityId: currentUser.facilityId,
                        uploadedBy: currentUser.name
                    };
                    await FileService.saveFile(newFile);
                    
                    // Send Notification to Contract Manager
                    const contractManager = DataService.users.getAll().find(u => u.role === UserRole.CONTRACT_MANAGER);
                    if (contractManager) {
                        DataService.notifications.add({
                            toUserId: contractManager.id,
                            message: `ملف جديد: ${file.name}`,
                            facilityId: currentUser.facilityId,
                            type: 'FILE_UPLOADED'
                        });
                    }

                    setUploading(false);
                    showToast('تم رفع الملف بنجاح');
                    loadFiles();
                };
                reader.readAsDataURL(file);
            };

            const handleDelete = async (id) => {
                if(!confirm('حذف الملف؟')) return;
                await FileService.deleteFile(id);
                loadFiles();
                showToast('تم الحذف');
            };

            const handleView = (file) => {
                const win = window.open();
                if(win) {
                    if(file.type.includes('pdf')) {
                        win.document.write(`
                            <html>
                                <head><title>${file.name}</title></head>
                                <body style="margin:0;padding:0;height:100vh;">
                                    <iframe src="${file.data}" style="width:100%; height:100%; border:none;"></iframe>
                                </body>
                            </html>
                        `);
                    } else {
                        win.document.write(`
                            <html>
                                <head><title>${file.name}</title></head>
                                <body style="margin:0;padding:0;display:flex;justify-content:center;align-items:center;height:100vh;">
                                    <img src="${file.data}" style="max-width:100%; max-height:100%;" />
                                </body>
                            </html>
                        `);
                    }
                }
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex justify-between items-center">
                        <h2 className="text-xl font-bold">ملف التقارير الداعمة</h2>
                        <input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border p-2 rounded" />
                    </div>
                    
                    <div className="bg-white p-6 rounded shadow">
                        <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:bg-gray-50 transition-colors">
                            <i className="fa fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p className="mb-4 text-gray-600">اضغط لرفع ملفات (PDF, صور) تدعم مؤشرات الأداء</p>
                            <input type="file" onChange={handleUpload} accept="application/pdf,image/*" disabled={uploading} className="hidden" id="file-upload" />
                            <label htmlFor="file-upload" className="bg-gold text-white px-6 py-2 rounded cursor-pointer hover:bg-gold-dark inline-block">
                                {uploading ? 'جاري الرفع...' : 'اختر ملف'}
                            </label>
                            <p className="text-xs text-gray-500 mt-2">الحجم الأقصى: 10 ميجابايت</p>
                        </div>
                    </div>
                    
                    {files.length > 0 && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {files.map(file => (
                                <div key={file.id} className="bg-white p-4 rounded shadow flex items-center justify-between border-r-4 border-gold">
                                    <div className="flex items-center overflow-hidden flex-1">
                                        <i className={`fa ${file.type.includes('pdf') ? 'fa-file-pdf text-red-500' : 'fa-file-image text-blue-500'} text-2xl ml-3`}></i>
                                        <div className="truncate flex-1">
                                            <div className="font-bold truncate" title={file.name}>{file.name}</div>
                                            <div className="text-xs text-gray-500">
                                                {new Date(file.uploadDate).toLocaleDateString('ar-AE')}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>handleView(file)} className="text-blue-600 hover:text-blue-800" title="عرض">
                                            <i className="fa fa-eye"></i>
                                        </button>
                                        <button onClick={()=>handleDelete(file.id)} className="text-red-600 hover:text-red-800" title="حذف">
                                            <i className="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const SettingsPage = () => {
            const { showToast } = useToast();
            const [activeTab, setActiveTab] = useState('GENERAL');
            const [facilities, setFacilities] = useState([]);
            const [users, setUsers] = useState([]);
            const [employees, setEmployees] = useState([]);
            const [items, setItems] = useState([]);
            const [violations, setViolations] = useState([]);
            const [logo, setLogo] = useState(null);

            const [editFacility, setEditFacility] = useState({});
            const [editUser, setEditUser] = useState({});
            const [editEmployee, setEditEmployee] = useState({});
            const [editItem, setEditItem] = useState({});
            const [editViolation, setEditViolation] = useState({});

            const refreshData = () => {
                setFacilities(DataService.facilities.getAll());
                setUsers(DataService.users.getAll());
                setEmployees(DataService.employees.getAll());
                setItems(DataService.items.getAll());
                setViolations(DataService.violationTypes.getAll());
                setLogo(DataService.settings.get().logo || null);
            };

            useEffect(() => { refreshData(); }, []);

            const handleLogoUpload = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64 = reader.result;
                        setLogo(base64);
                        DataService.settings.save({ ...DataService.settings.get(), logo: base64 });
                        showToast('تم حفظ الشعار بنجاح');
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSave = (type, data, idField = 'id') => {
                let list = [], saver = null, setter = null;
                let newData = { ...data };
                if (!newData[idField]) newData[idField] = Date.now().toString();

                switch(type) {
                    case 'FACILITY': list = facilities; saver = DataService.facilities.save; setter = setEditFacility; break;
                    case 'USER': list = users; saver = DataService.users.save; setter = setEditUser; break;
                    case 'EMPLOYEE': list = employees; saver = DataService.employees.save; setter = setEditEmployee; break;
                    case 'ITEM': list = items; saver = DataService.items.save; setter = setEditItem; break;
                    case 'VIOLATION': list = violations; saver = DataService.violationTypes.save; setter = setEditViolation; break;
                }

                const idx = list.findIndex(x => x[idField] === newData[idField]);
                const updated = [...list];
                if (idx >= 0) updated[idx] = newData; else updated.push(newData);
                
                saver(updated);
                refreshData();
                setter({});
                showToast('تم الحفظ');
            };

            const handleDelete = (type, id) => {
                if (!confirm('هل أنت متأكد من الحذف؟')) return;
                let list = [], saver = null;
                switch(type) {
                    case 'FACILITY': list = facilities; saver = DataService.facilities.save; break;
                    case 'USER': list = users; saver = DataService.users.save; break;
                    case 'EMPLOYEE': list = employees; saver = DataService.employees.save; break;
                    case 'ITEM': list = items; saver = DataService.items.save; break;
                    case 'VIOLATION': list = violations; saver = DataService.violationTypes.save; break;
                }
                saver(list.filter(x => x.id !== id));
                refreshData();
                showToast('تم الحذف');
            };

            const Tabs = ({ tabs, active, onChange }) => (
                <div className="flex border-b mb-6 overflow-x-auto bg-gray-50 rounded-t-lg">
                    {tabs.map(t => (
                        <button key={t.id} onClick={() => onChange(t.id)} className={`px-6 py-3 whitespace-nowrap transition-all ${active === t.id ? 'border-b-4 border-gold font-bold text-gold-dark bg-white' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'}`}>
                            {t.label}
                        </button>
                    ))}
                </div>
            );

            return (
                <div className="bg-white p-6 rounded shadow-lg min-h-screen">
                    <h2 className="text-2xl font-bold mb-6 text-gray-800">إعدادات النظام</h2>
                    <Tabs active={activeTab} onChange={setActiveTab} tabs={[
                        { id: 'GENERAL', label: 'عام' }, 
                        { id: 'FACILITIES', label: 'المواقع' }, 
                        { id: 'USERS', label: 'المستخدمين' }, 
                        { id: 'EMPLOYEES', label: 'الموظفين' }, 
                        { id: 'ITEMS', label: 'بنود التقييم' }, 
                        { id: 'VIOLATIONS', label: 'أنواع المخالفات' }
                    ]} />
                    
                    {activeTab === 'GENERAL' && (
                        <div>
                            <h3 className="font-bold mb-2">شعار المؤسسة</h3>
                            <div className="w-40 h-40 border-2 border-dashed flex items-center justify-center overflow-hidden mb-2 rounded bg-gray-50">
                                {logo ? <img src={logo} className="w-full h-full object-contain" alt="شعار المؤسسة" /> : <span className="text-gray-400">لا يوجد</span>}
                            </div>
                            <input type="file" onChange={handleLogoUpload} accept="image/*" className="mb-4" />
                            <div className="text-sm text-gray-500">سيتم عرض الشعار في جميع التقارير المطبوعة</div>
                        </div>
                    )}
                    
                    {activeTab === 'FACILITIES' && (
                         <div className="space-y-6">
                            <div className="bg-gray-50 p-4 rounded border grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <input placeholder="اسم المسلخ" value={editFacility.name || ''} onChange={e => setEditFacility({...editFacility, name: e.target.value})} className="border p-2 rounded" />
                                <input placeholder="رقم العقد" value={editFacility.contractNumber || ''} onChange={e => setEditFacility({...editFacility, contractNumber: e.target.value})} className="border p-2 rounded" />
                                <input placeholder="الشركة المشغلة" value={editFacility.operatingCompany || ''} onChange={e => setEditFacility({...editFacility, operatingCompany: e.target.value})} className="border p-2 rounded" />
                                <input placeholder="الموقع" value={editFacility.location || ''} onChange={e => setEditFacility({...editFacility, location: e.target.value})} className="border p-2 rounded" />
                                <input placeholder="الهاتف" value={editFacility.phone || ''} onChange={e => setEditFacility({...editFacility, phone: e.target.value})} className="border p-2 rounded" />
                                <input placeholder="البريد الإلكتروني" value={editFacility.email || ''} onChange={e => setEditFacility({...editFacility, email: e.target.value})} className="border p-2 rounded" />
                                <div className="md:col-span-3">
                                    <button onClick={() => handleSave('FACILITY', editFacility)} className="bg-gold text-white px-6 py-2 rounded font-bold">
                                        {editFacility.id ? 'تحديث' : 'إضافة'}
                                    </button>
                                    {editFacility.id && (
                                        <button onClick={() => setEditFacility({})} className="bg-gray-500 text-white px-4 py-2 rounded mr-2">
                                            إلغاء
                                        </button>
                                    )}
                                </div>
                            </div>
                            <table className="w-full border text-sm">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="p-2 border">المسلخ</th>
                                        <th className="p-2 border">العقد</th>
                                        <th className="p-2 border">الشركة</th>
                                        <th className="p-2 border">الموقع</th>
                                        <th className="p-2 border">أدوات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {facilities.map(f => (
                                        <tr key={f.id}>
                                            <td className="p-2 border">{f.name}</td>
                                            <td className="p-2 border">{f.contractNumber}</td>
                                            <td className="p-2 border">{f.operatingCompany}</td>
                                            <td className="p-2 border">{f.location}</td>
                                            <td className="p-2 border text-center">
                                                <button onClick={() => setEditFacility(f)} className="text-blue-600 mx-2" title="تعديل">
                                                    <i className="fa fa-edit"></i>
                                                </button>
                                                <button onClick={() => handleDelete('FACILITY', f.id)} className="text-red-600 mx-2" title="حذف">
                                                    <i className="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                         </div>
                    )}
                    
                    {activeTab === 'USERS' && (
                        <div className="space-y-6">
                            <div className="bg-gray-50 p-4 rounded border grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input placeholder="الرمز الوظيفي" value={editUser.id || ''} onChange={e => setEditUser({...editUser, id: e.target.value})} className="border p-2 rounded" />
                                <input placeholder="الاسم" value={editUser.name || ''} onChange={e => setEditUser({...editUser, name: e.target.value})} className="border p-2 rounded" />
                                <select value={editUser.role || 'USER'} onChange={e => setEditUser({...editUser, role: e.target.value})} className="border p-2 rounded">
                                    {Object.values(UserRole).map(r=><option key={r} value={r}>{r}</option>)}
                                </select>
                                <select value={editUser.facilityId || ''} onChange={e => setEditUser({...editUser, facilityId: e.target.value})} className="border p-2 rounded">
                                    <option value="">الكل</option>
                                    {facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                </select>
                                <div className="md:col-span-4">
                                    <button onClick={() => handleSave('USER', editUser)} className="bg-gold text-white px-6 py-2 rounded font-bold">
                                        {editUser.id ? 'تحديث' : 'إضافة'}
                                    </button>
                                    {editUser.id && (
                                        <button onClick={() => setEditUser({})} className="bg-gray-500 text-white px-4 py-2 rounded mr-2">
                                            إلغاء
                                        </button>
                                    )}
                                </div>
                            </div>
                            <table className="w-full border text-sm">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="p-2 border">الرمز</th>
                                        <th className="p-2 border">الاسم</th>
                                        <th className="p-2 border">الدور</th>
                                        <th className="p-2 border">الموقع</th>
                                        <th className="p-2 border">أدوات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {users.map(u=>(
                                        <tr key={u.id}>
                                            <td className="p-2 border">{u.id}</td>
                                            <td className="p-2 border">{u.name}</td>
                                            <td className="p-2 border">{u.role}</td>
                                            <td className="p-2 border">{facilities.find(f=>f.id===u.facilityId)?.name || 'الكل'}</td>
                                            <td className="p-2 border text-center">
                                                <button onClick={()=>setEditUser(u)} className="text-blue-600 mx-2" title="تعديل">
                                                    <i className="fa fa-edit"></i>
                                                </button>
                                                <button onClick={()=>handleDelete('USER', u.id)} className="text-red-600 mx-2" title="حذف">
                                                    <i className="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    
                    {activeTab === 'EMPLOYEES' && (
                        <div className="space-y-6">
                             <div className="bg-gray-50 p-4 rounded border grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input placeholder="الاسم" value={editEmployee.name || ''} onChange={e => setEditEmployee({...editEmployee, name: e.target.value})} className="border p-2 rounded" />
                                <input placeholder="الوظيفة" value={editEmployee.jobTitle || ''} onChange={e => setEditEmployee({...editEmployee, jobTitle: e.target.value})} className="border p-2 rounded" />
                                <input type="number" placeholder="الراتب" value={editEmployee.salary || ''} onChange={e => setEditEmployee({...editEmployee, salary: Number(e.target.value)})} className="border p-2 rounded" />
                                <select value={editEmployee.facilityId || ''} onChange={e => setEditEmployee({...editEmployee, facilityId: e.target.value})} className="border p-2 rounded">
                                    <option value="">اختر الموقع</option>
                                    {facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                </select>
                                <div className="md:col-span-4">
                                    <button onClick={() => handleSave('EMPLOYEE', editEmployee)} className="bg-gold text-white px-6 py-2 rounded font-bold">
                                        {editEmployee.id ? 'تحديث' : 'إضافة'}
                                    </button>
                                    {editEmployee.id && (
                                        <button onClick={() => setEditEmployee({})} className="bg-gray-500 text-white px-4 py-2 rounded mr-2">
                                            إلغاء
                                        </button>
                                    )}
                                </div>
                            </div>
                            
                            {facilities.map(f => {
                                const siteEmps = employees.filter(e => e.facilityId === f.id);
                                if(siteEmps.length === 0) return null;
                                return (
                                    <div key={f.id} className="border rounded mb-4">
                                        <div className="bg-gray-100 p-2 font-bold">{f.name}</div>
                                        <table className="w-full text-right text-sm">
                                            <thead>
                                                <tr className="border-b">
                                                    <th className="p-2">الاسم</th>
                                                    <th className="p-2">الوظيفة</th>
                                                    <th className="p-2">الراتب</th>
                                                    <th className="p-2">أدوات</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {siteEmps.map(e => (
                                                    <tr key={e.id} className="border-b">
                                                        <td className="p-2">{e.name}</td>
                                                        <td className="p-2">{e.jobTitle}</td>
                                                        <td className="p-2">{e.salary.toLocaleString()}</td>
                                                        <td className="p-2">
                                                            <button onClick={() => setEditEmployee(e)} className="text-blue-600 ml-2" title="تعديل">
                                                                <i className="fa fa-edit"></i>
                                                            </button>
                                                            <button onClick={() => handleDelete('EMPLOYEE', e.id)} className="text-red-600" title="حذف">
                                                                <i className="fa fa-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )
                            })}
                        </div>
                    )}
                    
                    {activeTab === 'ITEMS' && (
                        <div className="space-y-6">
                            <div className="bg-gray-50 p-4 rounded border grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input placeholder="البند" value={editItem.name || ''} onChange={e => setEditItem({...editItem, name: e.target.value})} className="border p-2 rounded" />
                                <select value={editItem.category || 'ADMIN'} onChange={e => setEditItem({...editItem, category: e.target.value})} className="border p-2 rounded">
                                    {['ADMIN','OPERATIONAL','PROFESSIONAL','HYGIENE','SAFETY','LAB'].map(c=>
                                        <option key={c} value={c}>{c}</option>
                                    )}
                                </select>
                                <input type="number" placeholder="النقاط" value={editItem.points || 5} onChange={e => setEditItem({...editItem, points: Number(e.target.value)})} className="border p-2 rounded" />
                                <select value={editItem.linkedViolationId || ''} onChange={e => setEditItem({...editItem, linkedViolationId: e.target.value})} className="border p-2 rounded">
                                    <option value="">بلا مخالفة</option>
                                    {violations.map(v=><option key={v.id} value={v.id}>{v.name}</option>)}
                                </select>
                                <div className="md:col-span-4">
                                    <button onClick={() => handleSave('ITEM', editItem)} className="bg-gold text-white px-6 py-2 rounded font-bold">
                                        {editItem.id ? 'تحديث' : 'إضافة'}
                                    </button>
                                    {editItem.id && (
                                        <button onClick={() => setEditItem({})} className="bg-gray-500 text-white px-4 py-2 rounded mr-2">
                                            إلغاء
                                        </button>
                                    )}
                                </div>
                            </div>
                             <div className="h-96 overflow-y-auto border rounded">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th className="p-2 border">البند</th>
                                            <th className="p-2 border">التصنيف</th>
                                            <th className="p-2 border">النقاط</th>
                                            <th className="p-2 border">المخالفة المرتبطة</th>
                                            <th className="p-2 border">أدوات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {items.map(i => {
                                            const violation = violations.find(v => v.id === i.linkedViolationId);
                                            return (
                                                <tr key={i.id} className="border-b">
                                                    <td className="p-2">{i.name}</td>
                                                    <td className="p-2 text-center text-xs bg-gray-200 rounded">{i.category}</td>
                                                    <td className="p-2 text-center font-bold">{i.points || 5}</td>
                                                    <td className="p-2 text-center text-xs">
                                                        {violation ? violation.name : '-'}
                                                    </td>
                                                    <td className="p-2 text-center">
                                                        <button onClick={() => setEditItem(i)} className="text-blue-600 mx-1" title="تعديل">
                                                            <i className="fa fa-edit"></i>
                                                        </button>
                                                        <button onClick={() => handleDelete('ITEM', i.id)} className="text-red-600 mx-1" title="حذف">
                                                            <i className="fa fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                    
                    {activeTab === 'VIOLATIONS' && (
                        <div className="space-y-6">
                             <div className="bg-gray-50 p-4 rounded border grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input placeholder="المخالفة" value={editViolation.name || ''} onChange={e => setEditViolation({...editViolation, name: e.target.value})} className="border p-2 rounded" />
                                <input type="number" placeholder="الغرامة" value={editViolation.fineAmount || ''} onChange={e => setEditViolation({...editViolation, fineAmount: Number(e.target.value)})} className="border p-2 rounded" />
                                <div className="md:col-span-3">
                                    <button onClick={() => handleSave('VIOLATION', editViolation)} className="bg-gold text-white px-6 py-2 rounded font-bold">
                                        {editViolation.id ? 'تحديث' : 'إضافة'}
                                    </button>
                                    {editViolation.id && (
                                        <button onClick={() => setEditViolation({})} className="bg-gray-500 text-white px-4 py-2 rounded mr-2">
                                            إلغاء
                                        </button>
                                    )}
                                </div>
                            </div>
                            <table className="w-full border text-sm">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="p-2 border">المخالفة</th>
                                        <th className="p-2 border">الغرامة</th>
                                        <th className="p-2 border">أدوات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {violations.map(v => (
                                        <tr key={v.id} className="border-b">
                                            <td className="p-2">{v.name}</td>
                                            <td className="p-2 text-center text-red-600 font-bold">{v.fineAmount.toLocaleString()}</td>
                                            <td className="p-2 text-center">
                                                <button onClick={() => setEditViolation(v)} className="text-blue-600 mx-1" title="تعديل">
                                                    <i className="fa fa-edit"></i>
                                                </button>
                                                <button onClick={() => handleDelete('VIOLATION', v.id)} className="text-red-600 mx-1" title="حذف">
                                                    <i className="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const MonthlyEvaluationPage = ({ currentUser }) => {
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const [facilities, setFacilities] = useState([]);
            const [data, setData] = useState({ days: [], items: [], employees: [], evals: [] });
            
            const canViewAll = [UserRole.ADMIN, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD, UserRole.CONTRACT_MANAGER].includes(currentUser.role);

            const loadData = () => {
                const allFacs = DataService.facilities.getAll();
                if(canViewAll) { 
                    setFacilities(allFacs); 
                } else { 
                    setFacilities(allFacs.filter(f=>f.id===currentUser.facilityId)); 
                    if(currentUser.facilityId) setSelectedFacility(currentUser.facilityId); 
                }
                
                const emps = DataService.employees.getAll().filter(e => e.facilityId === selectedFacility);
                const items = DataService.items.getAll();
                const evals = DataService.evaluations.getAll().filter(e => e.date.startsWith(month) && e.facilityId === selectedFacility);
                
                const [y, m] = month.split('-');
                const days = Array.from({length: new Date(Number(y), Number(m), 0).getDate()}, (_, i) => `${month}-${String(i+1).padStart(2, '0')}`);
                
                setData({ days, items, employees: emps, evals });
            };

            useEffect(() => {
                loadData();
                window.addEventListener('storage-update', loadData);
                return () => window.removeEventListener('storage-update', loadData);
            }, [month, selectedFacility, currentUser]);

            const isApplicable = (item, emp) => {
                const t = emp.jobTitle.trim();
                if (['i1', 'i15', 'i16', 'i8', 'i9', 'i10'].includes(item.id)) return true;
                if (['i2', 'i3', 'i4', 'i5', 'i6', 'i7', 'i18'].includes(item.id)) return t.includes('مشرف');
                if (['i12', 'i14'].includes(item.id)) return t.includes('نظافة') || t.includes('حمال') || t.includes('مشرف');
                if (['i17', 'i11', 'i13'].includes(item.id)) return t.includes('قصاب') || t.includes('جزار');
                if (item.id === 'i19') return t.includes('محاسب');
                return false;
            };

            const getStatus = (day, item, emp) => {
                if(!isApplicable(item, emp)) return 'na';
                const ev = data.evals.find(e => e.date === day);
                if(!ev) return 'pending';
                const val = ev.scores[`${item.id}_${emp.id}`];
                return val === true ? 'pass' : val === false ? 'fail' : 'pending';
            };

            const calculateMonthlyPerformance = () => {
                let totalChecks = 0;
                let passedChecks = 0;
                
                data.days.forEach(day => {
                    data.employees.forEach(emp => {
                        data.items.forEach(item => {
                            if(isApplicable(item, emp)) {
                                const ev = data.evals.find(e => e.date === day);
                                if(ev) {
                                    const val = ev.scores[`${item.id}_${emp.id}`];
                                    totalChecks++;
                                    if(val === true) passedChecks++;
                                }
                            }
                        });
                    });
                });
                
                return totalChecks === 0 ? 100 : Math.round((passedChecks/totalChecks)*100);
            };

            const monthlyPerformance = calculateMonthlyPerformance();

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex justify-between items-center no-print">
                        <h2 className="text-xl font-bold">التقييم الشهري</h2>
                        <div className="flex gap-2">
                             {canViewAll ? (
                                 <select value={selectedFacility} onChange={e=>setSelectedFacility(e.target.value)} className="border p-2 rounded">
                                     {facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                 </select>
                             ) : (
                                 <span className="font-bold px-3">{facilities.find(f=>f.id===selectedFacility)?.name}</span>
                             )}
                            <input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border p-2 rounded"/>
                            <button onClick={()=>window.print()} className="bg-blue-600 text-white px-4 py-2 rounded">
                                <i className="fa fa-print ml-2"></i> طباعة
                            </button>
                        </div>
                    </div>
                    
                    <div className="bg-white p-4 rounded shadow">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg">
                                مؤشر الأداء الشهري: <span className={`${monthlyPerformance < 80 ? 'text-red-500' : 'text-green-500'}`}>
                                    {monthlyPerformance}%
                                </span>
                            </h3>
                            <div className="text-sm text-gray-600">
                                {data.days.length} يوم | {data.employees.length} موظف | {data.items.length} بند
                            </div>
                        </div>
                    </div>
                    
                    <div id="monthly-eval-report" className="bg-white p-4 rounded shadow overflow-x-auto">
                        <table className="w-full text-xs text-center border-collapse border border-gray-400">
                            <thead>
                                <tr className="bg-gold text-white">
                                    <th className="border p-2">التاريخ</th>
                                    <th className="border p-2">البند</th>
                                    {data.employees.map(e=>(
                                        <th key={e.id} className="border p-2">
                                            {e.name}<br/>
                                            <span className="text-xs">{e.jobTitle}</span>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {data.days.map(day => {
                                    const ev = data.evals.find(e => e.date === day);
                                    const vetName = ev ? ev.enteredBy : '-';
                                    
                                    return (
                                        <Fragment key={day}>
                                            {data.items.map((item, idx) => (
                                                <tr key={`${day}-${item.id}`} className={idx%2?'bg-gray-50':'bg-white'}>
                                                    {idx===0 && (
                                                        <td rowSpan={data.items.length + 1} className="border p-2 font-bold bg-gray-100">
                                                            {day.split('-')[2]}
                                                        </td>
                                                    )}
                                                    <td className="border p-1 text-right">{item.name}</td>
                                                    {data.employees.map(emp => {
                                                        const s = getStatus(day, item, emp);
                                                        return (
                                                            <td key={emp.id} className={`border p-1 ${s==='na'?'bg-gray-100':''}`}>
                                                                {s==='pass' ? (
                                                                    <i className="fa fa-check text-green-500"></i>
                                                                ) : s==='fail' ? (
                                                                    <i className="fa fa-times text-red-500"></i>
                                                                ) : s==='na' ? '' : '-'}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                            <tr className="bg-blue-50">
                                                <td className="border p-1 text-right font-bold text-blue-800">الطبيب المناوب</td>
                                                <td colSpan={data.employees.length} className="border p-1 text-center font-bold text-blue-800">
                                                    {vetName}
                                                </td>
                                            </tr>
                                        </Fragment>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => { 
                const s = localStorage.getItem('currentUser'); 
                if(s) setUser(JSON.parse(s)); 
                setLoading(false);
            }, []);

            const handleLogin = (u) => { 
                setUser(u); 
                localStorage.setItem('currentUser', JSON.stringify(u)); 
            };
            
            const handleLogout = () => { 
                setUser(null); 
                localStorage.removeItem('currentUser'); 
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-900">
                        <div className="text-white text-center">
                            <i className="fa fa-spinner fa-spin fa-3x mb-4"></i>
                            <div className="text-xl">جاري التحميل...</div>
                        </div>
                    </div>
                );
            }

            if (!user) return <Login onLogin={handleLogin} />;

            return (
                <ToastProvider>
                    <HashRouter>
                        <Layout currentUser={user} onLogout={handleLogout}>
                            <Routes>
                                <Route path="/" element={<Navigate to={user.role === UserRole.CONTRACT_MANAGER ? "/archive" : "/daily-evaluation"} />} />
                                
                                <Route path="/daily-evaluation" element={<DailyEvaluationPage currentUser={user} />} />
                                <Route path="/violations" element={<ViolationsPage currentUser={user} />} />
                                <Route path="/monthly-evaluation" element={<MonthlyEvaluationPage currentUser={user} />} />
                                <Route path="/monthly-report" element={<MonthlyReportPage currentUser={user} />} />
                                <Route path="/kpi" element={<KPIPage currentUser={user} />} />
                                <Route path="/invoice" element={<InvoicePage currentUser={user} />} />
                                <Route path="/extra-labor" element={<ExtraLaborPage currentUser={user} />} />
                                <Route path="/settings" element={user.role === UserRole.ADMIN ? <SettingsPage /> : <Navigate to="/" />} />
                                
                                <Route path="/contractor-files" element={
                                    user.role === UserRole.CONTRACTOR || user.role === UserRole.ADMIN ? 
                                    <ContractorFilesPage currentUser={user} /> : 
                                    <Navigate to="/" />} 
                                />
                                
                                <Route path="/archive" element={
                                    user.role === UserRole.CONTRACT_MANAGER || user.role === UserRole.ADMIN ? 
                                    <ArchivePage currentUser={user} /> : 
                                    <Navigate to="/" />} 
                                />
                            </Routes>
                        </Layout>
                    </HashRouter>
                </ToastProvider>
            );
        };

        // ==========================================
        // 8. CACHE BUSTING AND INITIALIZATION
        // ==========================================
        const CACHE_VERSION = 'v8.2';
        const cacheKey = 'app_cache_version';

        const checkCache = () => {
            const cached = localStorage.getItem(cacheKey);
            if (cached !== CACHE_VERSION) {
                console.log('Clearing cache for new version...');
                
                // Clear specific items or all
                const keysToKeep = ['users', 'facilities', 'employees', 'items', 'violationTypes', 'appSettings'];
                const allKeys = Object.keys(localStorage);
                
                allKeys.forEach(key => {
                    if (!keysToKeep.includes(key)) {
                        localStorage.removeItem(key);
                    }
                });
                
                localStorage.setItem(cacheKey, CACHE_VERSION);
            }
        };

        // Initialize app with cache check
        checkCache();

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
